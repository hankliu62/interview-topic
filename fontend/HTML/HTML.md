<!--
 * @owner: hank.liu
 * @team: å¡é²ç§‹
-->

# HTML é¢è¯•çŸ¥è¯†ç‚¹æ€»ç»“

æœ¬éƒ¨åˆ†ä¸»è¦æ˜¯ç¬”è€…åœ¨å¤ä¹  HTML ç›¸å…³çŸ¥è¯†å’Œä¸€äº›ç›¸å…³é¢è¯•é¢˜æ—¶æ‰€åšçš„ç¬”è®°ï¼Œä¸»è¦æ˜¯ä¸ªäººå¤ä¹ ä½¿ç”¨ï¼Œå¦‚æœå‡ºç°é”™è¯¯ï¼Œå¸Œæœ›å¹¶æ„Ÿè°¢å¤§å®¶æŒ‡å‡ºï¼Œå¦‚æ€»ç»“ç­”æ¡ˆä¸æ ‡å‡†æœ‰å‡ºå…¥ï¼Œè¯·è½»å–·ï¼Œè°¢è°¢ğŸ™

## æ·±å…¥è§£æä½ ä¸çŸ¥é“çš„ EventLoop å’Œæµè§ˆå™¨æ¸²æŸ“ã€å¸§åŠ¨ç”»ã€ç©ºé—²å›è°ƒ

### å‰è¨€

å…³äº Event Loop çš„æ–‡ç« å¾ˆå¤šï¼Œä½†æ˜¯æœ‰å¾ˆå¤šåªæ˜¯åœ¨è®²ã€Œå®ä»»åŠ¡ã€ã€ã€Œå¾®ä»»åŠ¡ã€ï¼Œæˆ‘å…ˆæå‡ºå‡ ä¸ªé—®é¢˜ï¼š

1. æ¯ä¸€è½® Event Loop éƒ½ä¼šä¼´éšç€æ¸²æŸ“å—ï¼Ÿ
2. requestAnimationFrame åœ¨å“ªä¸ªé˜¶æ®µæ‰§è¡Œï¼Œåœ¨æ¸²æŸ“å‰è¿˜æ˜¯åï¼Ÿåœ¨ microTask çš„å‰è¿˜æ˜¯åï¼Ÿ
3. requestIdleCallback åœ¨å“ªä¸ªé˜¶æ®µæ‰§è¡Œï¼Ÿå¦‚ä½•å»æ‰§è¡Œï¼Ÿåœ¨æ¸²æŸ“å‰è¿˜æ˜¯åï¼Ÿåœ¨ microTask çš„å‰è¿˜æ˜¯åï¼Ÿ
4. resizeã€scroll è¿™äº›äº‹ä»¶æ˜¯ä½•æ—¶å»æ´¾å‘çš„ã€‚

è¿™äº›é—®é¢˜å¹¶ä¸æ˜¯åˆ»æ„æƒ³åˆéš¾ä½ ï¼Œå¦‚æœä½ ä¸çŸ¥é“è¿™äº›ï¼Œé‚£ä½ å¯èƒ½å¹¶ä¸èƒ½åœ¨é‡åˆ°ä¸€ä¸ªåŠ¨ç”»éœ€æ±‚çš„æ—¶å€™åˆç†çš„é€‰æ‹© requestAnimationFrameï¼Œä½ å¯èƒ½åœ¨åšä¸€äº›éœ€æ±‚çš„æ—¶å€™æƒ³åˆ°äº† requestIdleCallbackï¼Œä½†æ˜¯ä½ ä¸çŸ¥é“å®ƒè¿è¡Œçš„æ—¶æœºï¼Œåªæ˜¯èƒ†æˆ˜å¿ƒæƒŠçš„å»ç”¨å®ƒï¼Œç¥ˆç¥·ä¸è¦å‡ºçº¿ä¸Š bugã€‚

è¿™ä¹Ÿæ˜¯æœ¬æ–‡æƒ³è¦ä»è§„èŒƒè§£è¯»å…¥æ‰‹ï¼Œæ·±æŒ–åº•å±‚çš„åŠ¨æœºä¹‹ä¸€ã€‚æœ¬æ–‡ä¼šé…Œæƒ…ä»è§„èŒƒä¸­æ’é™¤æ‰ä¸€äº›æ¯”è¾ƒæ™¦æ¶©éš¾æ‡‚ï¼Œæˆ–è€…å’Œä¸»æµç¨‹ä¸å¤ªç›¸å…³çš„æ¦‚å¿µã€‚æ›´è¯¦ç»†çš„ç‰ˆæœ¬ä¹Ÿå¯ä»¥ç›´æ¥å»è¯»è¿™ä¸ªè§„èŒƒï¼Œä¸è¿‡æ¯”è¾ƒè´¹æ—¶è´¹åŠ›ã€‚

### äº‹ä»¶å¾ªç¯

æˆ‘ä»¬å…ˆä¾æ®HTML å®˜æ–¹è§„èŒƒä»æµè§ˆå™¨çš„äº‹ä»¶å¾ªç¯è®²èµ·ï¼Œå› ä¸ºå‰©ä¸‹çš„ API éƒ½åœ¨è¿™ä¸ªå¾ªç¯ä¸­è¿›è¡Œï¼Œå®ƒæ˜¯æµè§ˆå™¨è°ƒåº¦ä»»åŠ¡çš„åŸºç¡€ã€‚

#### å®šä¹‰

ä¸ºäº†åè°ƒäº‹ä»¶ï¼Œç”¨æˆ·äº¤äº’ï¼Œè„šæœ¬ï¼Œæ¸²æŸ“ï¼Œç½‘ç»œä»»åŠ¡ç­‰ï¼Œæµè§ˆå™¨å¿…é¡»ä½¿ç”¨æœ¬èŠ‚ä¸­æè¿°çš„äº‹ä»¶å¾ªç¯ã€‚

#### æµç¨‹

1. ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªå®ä»»åŠ¡å¹¶æ‰§è¡Œã€‚

2. æ£€æŸ¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ‰§è¡Œå¹¶æ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¦‚æœåœ¨å¾®ä»»åŠ¡çš„æ‰§è¡Œä¸­åˆåŠ å…¥äº†æ–°çš„å¾®ä»»åŠ¡ï¼Œä¹Ÿä¼šåœ¨è¿™ä¸€æ­¥ä¸€èµ·æ‰§è¡Œã€‚

3. è¿›å…¥æ›´æ–°æ¸²æŸ“é˜¶æ®µï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ¸²æŸ“ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ª rendering opportunity çš„æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ä¸€å®šæ¯ä¸€è½® event loop éƒ½ä¼šå¯¹åº”ä¸€æ¬¡æµè§ˆå™¨æ¸²æŸ“ï¼Œè¦æ ¹æ®å±å¹•åˆ·æ–°ç‡ã€é¡µé¢æ€§èƒ½ã€é¡µé¢æ˜¯å¦åœ¨åå°è¿è¡Œæ¥å…±åŒå†³å®šï¼Œé€šå¸¸æ¥è¯´è¿™ä¸ªæ¸²æŸ“é—´éš”æ˜¯å›ºå®šçš„ã€‚ï¼ˆæ‰€ä»¥å¤šä¸ª task å¾ˆå¯èƒ½åœ¨ä¸€æ¬¡æ¸²æŸ“ä¹‹é—´æ‰§è¡Œï¼‰

  - æµè§ˆå™¨ä¼šå°½å¯èƒ½çš„ä¿æŒå¸§ç‡ç¨³å®šï¼Œä¾‹å¦‚é¡µé¢æ€§èƒ½æ— æ³•ç»´æŒ 60fpsï¼ˆæ¯ 16.66ms æ¸²æŸ“ä¸€æ¬¡ï¼‰çš„è¯ï¼Œé‚£ä¹ˆæµè§ˆå™¨å°±ä¼šé€‰æ‹© 30fps çš„æ›´æ–°é€Ÿç‡ï¼Œè€Œä¸æ˜¯å¶å°”ä¸¢å¸§ã€‚
  - å¦‚æœæµè§ˆå™¨ä¸Šä¸‹æ–‡ä¸å¯è§ï¼Œé‚£ä¹ˆé¡µé¢ä¼šé™ä½åˆ° 4fps å·¦å³ç”šè‡³æ›´ä½ã€‚
  - å¦‚æœæ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼Œä¹Ÿä¼šè·³è¿‡æ¸²æŸ“ï¼š

    1. æµè§ˆå™¨åˆ¤æ–­æ›´æ–°æ¸²æŸ“ä¸ä¼šå¸¦æ¥è§†è§‰ä¸Šçš„æ”¹å˜ã€‚
    2. map of animation frame callbacks ä¸ºç©ºï¼Œä¹Ÿå°±æ˜¯å¸§åŠ¨ç”»å›è°ƒä¸ºç©ºï¼Œå¯ä»¥é€šè¿‡ requestAnimationFrame æ¥è¯·æ±‚å¸§åŠ¨ç”»ã€‚

4. å¦‚æœä¸Šè¿°çš„åˆ¤æ–­å†³å®šæœ¬è½®ä¸éœ€è¦æ¸²æŸ“ï¼Œé‚£ä¹ˆä¸‹é¢çš„å‡ æ­¥ä¹Ÿä¸ä¼šç»§ç»­è¿è¡Œï¼š
  This step enables the user agent to prevent the steps below from running for other reasons, for example, to ensure certain tasks are executed immediately after each other, with only microtask checkpoints interleaved (and without, e.g., animation frame callbacks interleaved). Concretely, a user agent might wish to coalesce timer callbacks together, with no intermediate rendering updates. æœ‰æ—¶å€™æµè§ˆå™¨å¸Œæœ›ä¸¤æ¬¡ã€Œå®šæ—¶å™¨ä»»åŠ¡ã€æ˜¯åˆå¹¶çš„ï¼Œä»–ä»¬ä¹‹é—´åªä¼šç©¿æ’ç€ microTaskçš„æ‰§è¡Œï¼Œè€Œä¸ä¼šç©¿æ’å±å¹•æ¸²æŸ“ç›¸å…³çš„æµç¨‹ï¼ˆæ¯”å¦‚requestAnimationFrameï¼Œä¸‹é¢ä¼šå†™ä¸€ä¸ªä¾‹å­ï¼‰ã€‚

5. å¯¹äºéœ€è¦æ¸²æŸ“çš„æ–‡æ¡£ï¼Œå¦‚æœçª—å£çš„å¤§å°å‘ç”Ÿäº†å˜åŒ–ï¼Œæ‰§è¡Œç›‘å¬çš„ `resize` æ–¹æ³•ã€‚

6. å¯¹äºéœ€è¦æ¸²æŸ“çš„æ–‡æ¡£ï¼Œå¦‚æœé¡µé¢å‘ç”Ÿäº†æ»šåŠ¨ï¼Œæ‰§è¡Œ `scroll` æ–¹æ³•ã€‚

7. å¯¹äºéœ€è¦æ¸²æŸ“çš„æ–‡æ¡£ï¼Œæ‰§è¡Œå¸§åŠ¨ç”»å›è°ƒï¼Œä¹Ÿå°±æ˜¯ `requestAnimationFrame` çš„å›è°ƒã€‚ï¼ˆåæ–‡ä¼šè¯¦è§£ï¼‰

8. å¯¹äºéœ€è¦æ¸²æŸ“çš„æ–‡æ¡£ï¼Œæ‰§è¡Œ `IntersectionObserver` çš„å›è°ƒã€‚

9. å¯¹äºéœ€è¦æ¸²æŸ“çš„æ–‡æ¡£ï¼Œ**é‡æ–°æ¸²æŸ“**ç»˜åˆ¶ç”¨æˆ·ç•Œé¢ã€‚

10. åˆ¤æ–­ `taské˜Ÿåˆ—`å’Œ`microTaské˜Ÿåˆ—`æ˜¯å¦éƒ½ä¸ºç©ºï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œåˆ™è¿›è¡Œ `Idle` ç©ºé—²å‘¨æœŸçš„ç®—æ³•ï¼Œåˆ¤æ–­æ˜¯å¦è¦æ‰§è¡Œ `requestIdleCallback` çš„å›è°ƒå‡½æ•°ã€‚ï¼ˆåæ–‡ä¼šè¯¦è§£ï¼‰

å¯¹äº `resize` å’Œ `scroll` æ¥è¯´ï¼Œå¹¶ä¸æ˜¯åˆ°äº†è¿™ä¸€æ­¥æ‰å»æ‰§è¡Œæ»šåŠ¨å’Œç¼©æ”¾ï¼Œé‚£å²‚ä¸æ˜¯è¦å»¶è¿Ÿå¾ˆå¤šï¼Ÿæµè§ˆå™¨å½“ç„¶ä¼šç«‹åˆ»å¸®ä½ æ»šåŠ¨è§†å›¾ï¼Œæ ¹æ®CSSOM è§„èŒƒæ‰€è®²ï¼Œæµè§ˆå™¨ä¼šä¿å­˜ä¸€ä¸ª `pending scroll event targets`ï¼Œç­‰åˆ°äº‹ä»¶å¾ªç¯ä¸­çš„ `scroll` è¿™ä¸€æ­¥ï¼Œå»æ´¾å‘ä¸€ä¸ªäº‹ä»¶åˆ°å¯¹åº”çš„ç›®æ ‡ä¸Šï¼Œé©±åŠ¨å®ƒå»æ‰§è¡Œç›‘å¬çš„å›è°ƒå‡½æ•°è€Œå·²ã€‚`resize` ä¹Ÿæ˜¯åŒç†ã€‚
å¯ä»¥åœ¨è¿™ä¸ªæµç¨‹ä¸­ä»”ç»†çœ‹ä¸€ä¸‹ã€Œå®ä»»åŠ¡ã€ã€ã€Œå¾®ä»»åŠ¡ã€ã€ã€Œæ¸²æŸ“ã€ä¹‹é—´çš„å…³ç³»ã€‚
å¤šä»»åŠ¡é˜Ÿåˆ—

#### å¤šä»»åŠ¡é˜Ÿåˆ—

task é˜Ÿåˆ—å¹¶ä¸æ˜¯æˆ‘ä»¬æƒ³è±¡ä¸­çš„é‚£æ ·åªæœ‰ä¸€ä¸ªï¼Œæ ¹æ®è§„èŒƒé‡Œçš„æè¿°ï¼š

An event loop has one or more task queues. For example, a user agent could have one task queue for mouse and key events (to which the user interaction task source is associated), and another to which all other task sources are associated. Then, using the freedom granted in the initial step of the event loop processing model, it could give keyboard and mouse events preference over other tasks three-quarters of the time, keeping the interface responsive but not starving other task queues. Note that in this setup, the processing model still enforces that the user agent would never process events from any one task source out of order.

äº‹ä»¶å¾ªç¯ä¸­å¯èƒ½ä¼šæœ‰ä¸€ä¸ªæˆ–å¤šä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œè¿™äº›é˜Ÿåˆ—åˆ†åˆ«ä¸ºäº†å¤„ç†ï¼š

1. é¼ æ ‡å’Œé”®ç›˜äº‹ä»¶
2. å…¶ä»–çš„ä¸€äº› Task

è§ˆå™¨ä¼šåœ¨ä¿æŒä»»åŠ¡é¡ºåºçš„å‰æä¸‹ï¼Œå¯èƒ½åˆ†é…å››åˆ†ä¹‹ä¸‰çš„ä¼˜å…ˆæƒç»™é¼ æ ‡å’Œé”®ç›˜äº‹ä»¶ï¼Œä¿è¯ç”¨æˆ·çš„è¾“å…¥å¾—åˆ°æœ€é«˜ä¼˜å…ˆçº§çš„å“åº”ï¼Œè€Œå‰©ä¸‹çš„ä¼˜å…ˆçº§äº¤ç»™å…¶ä»– Taskï¼Œå¹¶ä¸”ä¿è¯ä¸ä¼šâ€œé¥¿æ­»â€å®ƒä»¬ã€‚

è¿™ä¸ªè§„èŒƒä¹Ÿå¯¼è‡´ Vue 2.0.0-rc.7 è¿™ä¸ªç‰ˆæœ¬ `nextTick` é‡‡ç”¨äº†ä»å¾®ä»»åŠ¡ `MutationObserver` æ›´æ¢æˆå®ä»»åŠ¡ `postMessage` è€Œå¯¼è‡´äº†ä¸€ä¸ª [Issue](https://github.com/vuejs/vue/issues/3771#issuecomment-249692588)ã€‚
ç›®å‰ç”±äºä¸€äº›â€œæœªçŸ¥â€çš„åŸå› ï¼Œ`jsfiddle` çš„æ¡ˆä¾‹æ‰“ä¸å¼€äº†ã€‚ç®€å•æè¿°ä¸€ä¸‹å°±æ˜¯é‡‡ç”¨äº† `task` å®ç°çš„ `nextTick`ï¼Œåœ¨ç”¨æˆ·æŒç»­æ»šåŠ¨çš„æƒ…å†µä¸‹ `nextTick` ä»»åŠ¡è¢«å»¶åäº†å¾ˆä¹…æ‰å»æ‰§è¡Œï¼Œå¯¼è‡´åŠ¨ç”»è·Ÿä¸ä¸Šæ»šåŠ¨äº†ã€‚

è¿«äºæ— å¥ˆï¼Œå°¤å¤§è¿˜æ˜¯æ”¹å›äº† `microTask` å»å®ç° `nextTick`ï¼Œå½“ç„¶ç›®å‰æ¥è¯´ `promise.then` å¾®ä»»åŠ¡å·²ç»æ¯”è¾ƒç¨³å®šäº†ï¼Œå¹¶ä¸” Chrome ä¹Ÿå·²ç»å®ç°äº† `queueMicroTask` è¿™ä¸ªå®˜æ–¹ APIã€‚ä¸ä¹…çš„æœªæ¥ï¼Œæˆ‘ä»¬æƒ³è¦è°ƒç”¨å¾®ä»»åŠ¡é˜Ÿåˆ—çš„è¯ï¼Œä¹Ÿå¯ä»¥èŠ‚çœæ‰å®ä¾‹åŒ– `Promise` åœ¨å¼€é”€äº†ã€‚

ä»è¿™ä¸ª Issue çš„ä¾‹å­ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œç¨å¾®å»æ·±å…¥äº†è§£ä¸€ä¸‹è§„èŒƒè¿˜æ˜¯æ¯”è¾ƒæœ‰å¥½å¤„çš„ï¼Œä»¥å…åœ¨é‡åˆ°è¿™ç§æ¯”è¾ƒå¤æ‚çš„ Bug çš„æ—¶å€™ä¸€è„¸æ‡µé€¼ã€‚

#### requestAnimationFrame

åœ¨è§£è¯»è§„èŒƒçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å‘ç° `requestAnimationFrame` çš„å›è°ƒæœ‰ä¸¤ä¸ªç‰¹å¾ï¼š

1. åœ¨é‡æ–°æ¸²æŸ“å‰è°ƒç”¨ã€‚
2. å¾ˆå¯èƒ½åœ¨å®ä»»åŠ¡ä¹‹åä¸è°ƒç”¨ã€‚

æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆè¦åœ¨é‡æ–°æ¸²æŸ“å‰å»è°ƒç”¨ï¼Ÿå› ä¸º `rAF` æ˜¯å®˜æ–¹æ¨èçš„ç”¨æ¥åšä¸€äº›æµç•…åŠ¨ç”»æ‰€åº”è¯¥ä½¿ç”¨çš„ APIï¼ŒåšåŠ¨ç”»ä¸å¯é¿å…çš„ä¼šå»æ›´æ”¹ DOMï¼Œè€Œå¦‚æœåœ¨æ¸²æŸ“ä¹‹åå†å»æ›´æ”¹ DOMï¼Œé‚£å°±åªèƒ½ç­‰åˆ°ä¸‹ä¸€è½®æ¸²æŸ“æœºä¼šçš„æ—¶å€™æ‰èƒ½å»ç»˜åˆ¶å‡ºæ¥äº†ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸åˆç†çš„ã€‚

`rAF`åœ¨æµè§ˆå™¨å†³å®šæ¸²æŸ“ä¹‹å‰ç»™ä½ æœ€åä¸€ä¸ªæœºä¼šå»æ”¹å˜ DOM å±æ€§ï¼Œç„¶åå¾ˆå¿«åœ¨æ¥ä¸‹æ¥çš„ç»˜åˆ¶ä¸­å¸®ä½ å‘ˆç°å‡ºæ¥ï¼Œæ‰€ä»¥è¿™æ˜¯åšæµç•…åŠ¨ç”»çš„ä¸äºŒé€‰æ‹©ã€‚ä¸‹é¢æˆ‘ç”¨ä¸€ä¸ª setTimeoutçš„ä¾‹å­æ¥å¯¹æ¯”ã€‚

##### é—ªçƒåŠ¨ç”»

å‡è®¾æˆ‘ä»¬ç°åœ¨æƒ³è¦å¿«é€Ÿçš„è®©å±å¹•ä¸Šé—ªçƒ çº¢ã€è“ä¸¤ç§é¢œè‰²ï¼Œä¿è¯ç”¨æˆ·å¯ä»¥è§‚å¯Ÿåˆ°ï¼Œå¦‚æœæˆ‘ä»¬ç”¨ `setTimeout` æ¥å†™ï¼Œå¹¶ä¸”å¸¦ç€æˆ‘ä»¬é•¿æœŸçš„è¯¯è§£ã€Œå®ä»»åŠ¡ä¹‹é—´ä¸€å®šä¼šä¼´éšç€æµè§ˆå™¨ç»˜åˆ¶ã€ï¼Œé‚£ä¹ˆä½ ä¼šå¾—åˆ°ä¸€ä¸ªé¢„æ–™ä¹‹å¤–çš„ç»“æœã€‚

``` js
setTimeout(() => {
  document.body.style.background = "red";
  setTimeout(() => {
    document.body.style.background = "blue";
  });
});
```

![setTimeouté—ªçƒåŠ¨ç”»](https://user-images.githubusercontent.com/8088864/125749050-c757f81e-6482-4262-a0d4-c455eb78d4f4.gif)

ä»¥çœ‹å‡ºè¿™ä¸ªç»“æœæ˜¯éå¸¸ä¸å¯æ§çš„ï¼Œå¦‚æœè¿™ä¸¤ä¸ª `Task` ä¹‹é—´æ­£å¥½é‡åˆ°äº†æµè§ˆå™¨è®¤å®šçš„æ¸²æŸ“æœºä¼šï¼Œé‚£ä¹ˆå®ƒä¼šé‡ç»˜ï¼Œå¦åˆ™å°±ä¸ä¼šã€‚ç”±äºè¿™ä¿©å®ä»»åŠ¡çš„é—´éš”å‘¨æœŸå¤ªçŸ­äº†ï¼Œæ‰€ä»¥å¾ˆå¤§æ¦‚ç‡æ˜¯ä¸ä¼šçš„ã€‚

å¦‚æœä½ æŠŠå»¶æ—¶è°ƒæ•´åˆ° 17ms é‚£ä¹ˆé‡ç»˜çš„æ¦‚ç‡ä¼šå¤§å¾ˆå¤šï¼Œæ¯•ç«Ÿè¿™ä¸ªæ˜¯ä¸€èˆ¬æƒ…å†µä¸‹ 60fps çš„ä¸€ä¸ªæŒ‡æ ‡ã€‚ä½†æ˜¯ä¹Ÿä¼šå‡ºç°å¾ˆå¤šä¸ç»˜åˆ¶çš„æƒ…å†µï¼Œæ‰€ä»¥å¹¶ä¸ç¨³å®šã€‚
å¦‚æœä½ ä¾èµ–è¿™ä¸ª API æ¥åšåŠ¨ç”»ï¼Œé‚£ä¹ˆå°±å¾ˆå¯èƒ½ä¼šé€ æˆã€Œæ‰å¸§ã€ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬æ¢æˆ rAF è¯•è¯•ï¼Ÿæˆ‘ä»¬ç”¨ä¸€ä¸ªé€’å½’å‡½æ•°æ¥æ¨¡æ‹Ÿ 10 æ¬¡é¢œè‰²å˜åŒ–çš„åŠ¨ç”»ã€‚

``` js
let i = 10;
let req = () => {
  i--;
  requestAnimationFrame(() => {
    document.body.style.background = "red";
    requestAnimationFrame(() => {
      document.body.style.background = "blue";
      if (i > 0) {
        req();
      }
    });
  });
};

req();
```

è¿™é‡Œç”±äºé¢œè‰²å˜åŒ–å¤ªå¿«ï¼Œgif å½•åˆ¶è½¯ä»¶æ²¡åŠæ³•æˆªå‡ºè¿™ä¹ˆé«˜å¸§ç‡çš„é¢œè‰²å˜æ¢ï¼Œæ‰€ä»¥å„ä½å¯ä»¥æ”¾åˆ°æµè§ˆå™¨ä¸­è‡ªå·±æ‰§è¡Œä¸€ä¸‹è¯•è¯•ï¼Œæˆ‘è¿™è¾¹ç›´æ¥æŠ›ç»“è®ºï¼Œæµè§ˆå™¨ä¼šéå¸¸è§„å¾‹çš„æŠŠè¿™ 10 ç»„ä¹Ÿå°±æ˜¯ 20 æ¬¡é¢œè‰²å˜åŒ–ç»˜åˆ¶å‡ºæ¥ï¼Œå¯ä»¥çœ‹ä¸‹ performance é¢æ¿è®°å½•çš„è¡¨ç°ï¼š

![requestAnimationFrameé—ªçƒåŠ¨ç”»](https://user-images.githubusercontent.com/8088864/125750295-ab491df6-c612-4add-b2fe-8819fcf47ef1.png)

##### å®šæ—¶å™¨åˆå¹¶

åœ¨ç¬¬ä¸€èŠ‚è§£è¯»è§„èŒƒçš„æ—¶å€™ï¼Œç¬¬ 4 ç‚¹ä¸­æåˆ°äº†ï¼Œå®šæ—¶å™¨å®ä»»åŠ¡å¯èƒ½ä¼šç›´æ¥è·³è¿‡æ¸²æŸ“ã€‚

æŒ‰ç…§ä¸€äº›å¸¸è§„çš„ç†è§£æ¥è¯´ï¼Œå®ä»»åŠ¡ä¹‹é—´ç†åº”ç©¿æ’æ¸²æŸ“ï¼Œè€Œå®šæ—¶å™¨ä»»åŠ¡å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„å®ä»»åŠ¡ï¼Œçœ‹ä¸€ä¸‹ä»¥ä¸‹çš„ä»£ç ï¼š

``` js
setTimeout(() => {
  console.log("sto1")
  requestAnimationFrame(() => console.log("rAF1"))
})
setTimeout(() => {
  console.log("sto2")
  requestAnimationFrame(() => console.log("rAF2"))
})

queueMicrotask(() => console.log("mic1"))
queueMicrotask(() => console.log("mic2"))
```

ä»ç›´è§‰ä¸Šæ¥çœ‹ï¼Œé¡ºåºæ˜¯ä¸æ˜¯åº”è¯¥æ˜¯ï¼š

``` text
mic1
mic2
sto1
rAF1
sto2
rAF2
```

å‘¢ï¼Ÿä¹Ÿå°±æ˜¯æ¯ä¸€ä¸ªå®ä»»åŠ¡ä¹‹åéƒ½ç´§è·Ÿç€ä¸€æ¬¡æ¸²æŸ“ã€‚

å®é™…ä¸Šä¸ä¼šï¼Œæµè§ˆå™¨ä¼šåˆå¹¶è¿™ä¸¤ä¸ªå®šæ—¶å™¨ä»»åŠ¡ï¼š

``` text
mic1
mic2
sto1
sto2
rAF1
rAF2
```

#### requestIdleCallback

#### è‰æ¡ˆè§£è¯»

æˆ‘ä»¬éƒ½çŸ¥é“ `requestIdleCallback` æ˜¯æµè§ˆå™¨æä¾›ç»™æˆ‘ä»¬çš„ç©ºé—²è°ƒåº¦ç®—æ³•ï¼Œå…³äºå®ƒçš„ç®€ä»‹å¯ä»¥çœ‹ [MDN æ–‡æ¡£](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestIdleCallback)ï¼Œæ„å›¾æ˜¯è®©æˆ‘ä»¬æŠŠä¸€äº›è®¡ç®—é‡è¾ƒå¤§ä½†æ˜¯åˆæ²¡é‚£ä¹ˆç´§æ€¥çš„ä»»åŠ¡æ”¾åˆ°ç©ºé—²æ—¶é—´å»æ‰§è¡Œã€‚ä¸è¦å»å½±å“æµè§ˆå™¨ä¸­ä¼˜å…ˆçº§è¾ƒé«˜çš„ä»»åŠ¡ï¼Œæ¯”å¦‚åŠ¨ç”»ç»˜åˆ¶ã€ç”¨æˆ·è¾“å…¥ç­‰ç­‰ã€‚

React çš„æ—¶é—´åˆ†ç‰‡æ¸²æŸ“å°±æƒ³è¦ç”¨åˆ°è¿™ä¸ª APIï¼Œä¸è¿‡ç›®å‰æµè§ˆå™¨æ”¯æŒçš„ä¸ç»™åŠ›ï¼Œä»–ä»¬æ˜¯è‡ªå·±å»ç”¨ postMessage å®ç°äº†ä¸€å¥—ã€‚

**æ¸²æŸ“æœ‰åºè¿›è¡Œ**

é¦–å…ˆçœ‹ä¸€å¼ å›¾ï¼Œå¾ˆç²¾ç¡®çš„æè¿°äº†è¿™ä¸ª API çš„æ„å›¾ï¼š

![æµè§ˆå™¨æ¸²æŸ“æœ‰åºè°ƒåº¦](https://user-images.githubusercontent.com/8088864/125756615-7bec3496-94cc-46ba-9298-5df48b99d2d8.png)

å½“ç„¶ï¼Œè¿™ç§æœ‰åºçš„ `æµè§ˆå™¨ -> ç”¨æˆ· -> æµè§ˆå™¨ -> ç”¨æˆ·` çš„è°ƒåº¦åŸºäºä¸€ä¸ªå‰æï¼Œå°±æ˜¯æˆ‘ä»¬è¦æŠŠä»»åŠ¡åˆ‡åˆ†æˆæ¯”è¾ƒå°çš„ç‰‡ï¼Œä¸èƒ½è¯´æµè§ˆå™¨æŠŠç©ºé—²æ—¶é—´è®©ç»™ä½ äº†ï¼Œä½ å»æ‰§è¡Œä¸€ä¸ªè€—æ—¶ 10s çš„ä»»åŠ¡ï¼Œé‚£è‚¯å®šä¹Ÿä¼šæŠŠæµè§ˆå™¨ç»™é˜»å¡ä½çš„ã€‚è¿™å°±è¦æ±‚æˆ‘ä»¬å»è¯»å– `rIC` æä¾›ç»™ä½ çš„ `deadline` é‡Œçš„æ—¶é—´ï¼Œå»åŠ¨æ€çš„å®‰æ’æˆ‘ä»¬åˆ‡åˆ†çš„å°ä»»åŠ¡ã€‚æµè§ˆå™¨ä¿¡ä»»äº†ä½ ï¼Œä½ ä¹Ÿä¸èƒ½è¾œè´Ÿå®ƒå‘€ã€‚

**æ¸²æŸ“é•¿æœŸç©ºé—²**

![æµè§ˆå™¨æ¸²æŸ“é•¿æœŸç©ºé—²è°ƒåº¦](https://user-images.githubusercontent.com/8088864/125756805-79afd49b-e62d-45b9-bb7e-4a4b34eb7bd4.png)

è¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œä¹Ÿæœ‰å¯èƒ½åœ¨å‡ å¸§çš„æ—¶é—´å†…æµè§ˆå™¨éƒ½æ˜¯ç©ºé—²çš„ï¼Œå¹¶æ²¡æœ‰å‘ç”Ÿä»»ä½•å½±å“è§†å›¾çš„æ“ä½œï¼Œå®ƒä¹Ÿå°±ä¸éœ€è¦å»ç»˜åˆ¶é¡µé¢ï¼š
è¿™ç§æƒ…å†µä¸‹ä¸ºä»€ä¹ˆè¿˜æ˜¯ä¼šæœ‰ 50ms çš„ deadline å‘¢ï¼Ÿæ˜¯å› ä¸ºæµè§ˆå™¨ä¸ºäº†æå‰åº”å¯¹ä¸€äº›å¯èƒ½ä¼šçªå‘çš„ç”¨æˆ·äº¤äº’æ“ä½œï¼Œæ¯”å¦‚ç”¨æˆ·è¾“å…¥æ–‡å­—ã€‚å¦‚æœç»™çš„æ—¶é—´å¤ªé•¿äº†ï¼Œä½ çš„ä»»åŠ¡æŠŠä¸»çº¿ç¨‹å¡ä½äº†ï¼Œé‚£ä¹ˆç”¨æˆ·çš„äº¤äº’å°±å¾—ä¸åˆ°å›åº”äº†ã€‚50ms å¯ä»¥ç¡®ä¿ç”¨æˆ·åœ¨æ— æ„ŸçŸ¥çš„å»¶è¿Ÿä¸‹å¾—åˆ°å›åº”ã€‚

MDN æ–‡æ¡£ä¸­çš„[å¹•åä»»åŠ¡åä½œè°ƒåº¦ API](https://developer.mozilla.org/zh-CN/docs/Web/API/Background_Tasks_API)  ä»‹ç»çš„æ¯”è¾ƒæ¸…æ¥šï¼Œæ¥æ ¹æ®é‡Œé¢çš„æ¦‚å¿µåšä¸ªå°å®éªŒï¼š

å±å¹•ä¸­é—´æœ‰ä¸ªçº¢è‰²çš„æ–¹å—ï¼ŒæŠŠ MDN æ–‡æ¡£ä¸­[requestAnimationFrame](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestAnimationFrame)çš„èŒƒä¾‹éƒ¨åˆ†çš„åŠ¨ç”»ä»£ç ç›´æ¥å¤åˆ¶è¿‡æ¥ã€‚

è‰æ¡ˆä¸­è¿˜æåˆ°ï¼š

1. å½“æµè§ˆå™¨åˆ¤æ–­è¿™ä¸ªé¡µé¢å¯¹ç”¨æˆ·ä¸å¯è§æ—¶ï¼Œè¿™ä¸ªå›è°ƒæ‰§è¡Œçš„é¢‘ç‡å¯èƒ½è¢«é™ä½åˆ° 10 ç§’æ‰§è¡Œä¸€æ¬¡ï¼Œç”šè‡³æ›´ä½ã€‚è¿™ç‚¹åœ¨è§£è¯» EventLoop ä¸­ä¹Ÿæœ‰æåŠã€‚

2. å¦‚æœæµè§ˆå™¨çš„å·¥ä½œæ¯”è¾ƒç¹å¿™çš„æ—¶å€™ï¼Œä¸èƒ½ä¿è¯å®ƒä¼šæä¾›ç©ºé—²æ—¶é—´å»æ‰§è¡Œ rIC çš„å›è°ƒï¼Œè€Œä¸”å¯èƒ½ä¼šé•¿æœŸçš„æ¨è¿Ÿä¸‹å»ã€‚æ‰€ä»¥å¦‚æœä½ éœ€è¦ä¿è¯ä½ çš„ä»»åŠ¡åœ¨ä¸€å®šæ—¶é—´å†…ä¸€å®šè¦æ‰§è¡Œæ‰ï¼Œé‚£ä¹ˆä½ å¯ä»¥ç»™ rIC ä¼ å…¥ç¬¬äºŒä¸ªå‚æ•° timeoutã€‚
è¿™ä¼šå¼ºåˆ¶æµè§ˆå™¨ä¸ç®¡å¤šå¿™ï¼Œéƒ½åœ¨è¶…è¿‡è¿™ä¸ªæ—¶é—´ä¹‹åå»æ‰§è¡Œ rIC çš„å›è°ƒå‡½æ•°ã€‚æ‰€ä»¥è¦è°¨æ…ä½¿ç”¨ï¼Œå› ä¸ºå®ƒä¼šæ‰“æ–­æµè§ˆå™¨æœ¬èº«ä¼˜å…ˆçº§æ›´é«˜çš„å·¥ä½œã€‚

3. æœ€é•¿æœŸé™ä¸º 50 æ¯«ç§’ï¼Œæ˜¯æ ¹æ®ç ”ç©¶å¾—å‡ºçš„ï¼Œç ”ç©¶è¡¨æ˜ï¼Œäººä»¬é€šå¸¸è®¤ä¸º 100 æ¯«ç§’å†…å¯¹ç”¨æˆ·è¾“å…¥çš„å“åº”æ˜¯ç¬æ—¶çš„ã€‚ å°†é—²ç½®æˆªæ­¢æœŸé™è®¾ç½®ä¸º 50ms æ„å‘³ç€å³ä½¿åœ¨é—²ç½®ä»»åŠ¡å¼€å§‹åç«‹å³å‘ç”Ÿç”¨æˆ·è¾“å…¥ï¼Œæµè§ˆå™¨ä»ç„¶æœ‰å‰©ä½™çš„ 50ms å¯ä»¥åœ¨å…¶ä¸­å“åº”ç”¨æˆ·è¾“å…¥è€Œä¸ä¼šäº§ç”Ÿç”¨æˆ·å¯å¯Ÿè§‰çš„æ»åã€‚

4. æ¯æ¬¡è°ƒç”¨ timeRemaining() å‡½æ•°åˆ¤æ–­æ˜¯å¦æœ‰å‰©ä½™æ—¶é—´çš„æ—¶å€™ï¼Œå¦‚æœæµè§ˆå™¨åˆ¤æ–­æ­¤æ—¶æœ‰ä¼˜å…ˆçº§æ›´é«˜çš„ä»»åŠ¡ï¼Œé‚£ä¹ˆä¼šåŠ¨æ€çš„æŠŠè¿™ä¸ªå€¼è®¾ç½®ä¸º 0ï¼Œå¦åˆ™å°±æ˜¯ç”¨é¢„å…ˆè®¾ç½®å¥½çš„ deadline - now å»è®¡ç®—ã€‚

5. è¿™ä¸ª timeRemaining() çš„è®¡ç®—éå¸¸åŠ¨æ€ï¼Œä¼šæ ¹æ®å¾ˆå¤šå› ç´ å»å†³å®šï¼Œæ‰€ä»¥ä¸è¦æŒ‡æœ›è¿™ä¸ªæ—¶é—´æ˜¯ç¨³å®šçš„ã€‚

#### åŠ¨ç”»ä¾‹å­

**æ»šåŠ¨**

å¦‚æœæˆ‘é¼ æ ‡ä¸åšä»»ä½•åŠ¨ä½œå’Œäº¤äº’ï¼Œç›´æ¥åœ¨æ§åˆ¶å°é€šè¿‡ rIC å»æ‰“å°è¿™æ¬¡ç©ºé—²ä»»åŠ¡çš„å‰©ä½™æ—¶é—´ï¼Œä¸€èˆ¬éƒ½ç¨³å®šç»´æŒåœ¨ 49.xx msï¼Œå› ä¸ºæ­¤æ—¶æµè§ˆå™¨æ²¡æœ‰ä»€ä¹ˆä¼˜å…ˆçº§æ›´é«˜çš„ä»»åŠ¡è¦å»å¤„ç†ã€‚

``` js
requestIdleCallback((deadline) => console.log(deadline.timeRemaining()))
```

![requetIdleCallbackçš„timeRemainingæ—¶é—´1](https://user-images.githubusercontent.com/8088864/125778161-1e903c20-19a8-4340-83e9-af15ff16078a.gif)

è€Œå¦‚æœæˆ‘ä¸åœçš„æ»šåŠ¨æµè§ˆå™¨ï¼Œä¸æ–­çš„è§¦å‘æµè§ˆå™¨çš„é‡æ–°ç»˜åˆ¶çš„è¯ï¼Œè¿™ä¸ªæ—¶é—´å°±å˜çš„éå¸¸ä¸ç¨³å®šäº†ã€‚

![requetIdleCallbackçš„timeRemainingæ—¶é—´2](https://user-images.githubusercontent.com/8088864/125778195-dc9bc852-60e6-475d-a50e-441707e793ff.gif)

é€šè¿‡è¿™ä¸ªä¾‹å­ï¼Œä½ å¯ä»¥æ›´åŠ æœ‰ä½“æ„Ÿçš„æ„Ÿå—åˆ°ä»€ä¹ˆæ ·å«åšã€Œç¹å¿™ã€ï¼Œä»€ä¹ˆæ ·å«åšã€Œç©ºé—²ã€ã€‚


**åŠ¨ç”»**

è¿™ä¸ªåŠ¨ç”»çš„ä¾‹å­å¾ˆç®€å•ï¼Œå°±æ˜¯åˆ©ç”¨rAFåœ¨æ¯å¸§æ¸²æŸ“å‰çš„å›è°ƒä¸­æŠŠæ–¹å—çš„ä½ç½®å‘å³ç§»åŠ¨ 10pxã€‚

``` html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      #SomeElementYouWantToAnimate {
        height: 200px;
        width: 200px;
        background: red;
      }
    </style>
  </head>
  <body>
    <div id="SomeElementYouWantToAnimate"></div>
    <script>
      var start = null;
      var element = document.getElementById("SomeElementYouWantToAnimate");
      element.style.position = "absolute";

      function step(timestamp) {
        if (!start) start = timestamp;
        var progress = timestamp - start;
        element.style.left = Math.min(progress / 10, 200) + "px";
        if (progress < 2000) {
          window.requestAnimationFrame(step);
        }
      }
      // åŠ¨ç”»
      window.requestAnimationFrame(step);

      // ç©ºé—²è°ƒåº¦
      window.requestIdleCallback((deadline) => {
        console.log(deadline.timeRemaining())
        alert("rIC");
      });
    </script>
  </body>
</html>
```

æ³¨æ„åœ¨æœ€åæˆ‘åŠ äº†ä¸€ä¸ª requestIdleCallback çš„å‡½æ•°ï¼Œå›è°ƒé‡Œä¼š alert('rIC')ï¼Œæ¥çœ‹ä¸€ä¸‹æ¼”ç¤ºæ•ˆæœï¼š

![requetIdleCallbackå’ŒrequestAnmationFrameåŠ¨ç”»](https://user-images.githubusercontent.com/8088864/125778813-19d6dde2-2b12-4754-bd4c-deba1209d3e6.gif)

alert åœ¨æœ€å¼€å§‹çš„æ—¶å€™å°±æ‰§è¡Œäº†ï¼Œä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ä¸€ä¸‹ï¼Œæƒ³ä¸€ä¸‹ã€Œç©ºé—²ã€çš„æ¦‚å¿µï¼Œæˆ‘ä»¬æ¯ä¸€å¸§ä»…ä»…æ˜¯æŠŠ left çš„å€¼ç§»åŠ¨äº†ä¸€ä¸‹ï¼Œåšäº†è¿™ä¸€ä¸ªç®€å•çš„æ¸²æŸ“ï¼Œæ²¡æœ‰å æ»¡ç©ºé—²æ—¶é—´ï¼Œæ‰€ä»¥å¯èƒ½åœ¨æœ€å¼€å§‹çš„æ—¶å€™ï¼Œæµè§ˆå™¨å°±æ‰¾åˆ°æœºä¼šå»è°ƒç”¨ rIC çš„å›è°ƒå‡½æ•°äº†ã€‚

æˆ‘ä»¬ç®€å•çš„ä¿®æ”¹ä¸€ä¸‹ step å‡½æ•°ï¼Œåœ¨é‡Œé¢åŠ ä¸€ä¸ªå¾ˆé‡çš„ä»»åŠ¡ï¼Œ1000 æ¬¡å¾ªç¯æ‰“å°ã€‚

``` html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      #SomeElementYouWantToAnimate {
        height: 200px;
        width: 200px;
        background: red;
      }
    </style>
  </head>
  <body>
    <div id="SomeElementYouWantToAnimate"></div>
    <script>
      var start = null;
      var element = document.getElementById("SomeElementYouWantToAnimate");
      element.style.position = "absolute";

      function step(timestamp) {
        if (!start) start = timestamp;
        var progress = timestamp - start;
        element.style.left = Math.min(progress / 10, 200) + "px";
        let i = 1000;
        while (i > 0) {
          console.log("i", i);
          i--;
        }
        if (progress < 2000) {
          window.requestAnimationFrame(step);
        }
      }

      // åŠ¨ç”»
      window.requestAnimationFrame(step);

      // ç©ºé—²è°ƒåº¦
      window.requestIdleCallback((deadline) => {
        console.log(deadline.timeRemaining())
        alert("rIC");
      });
    </script>
  </body>
</html>
```

å†æ¥çœ‹ä¸€ä¸‹å®ƒçš„è¡¨ç°ï¼š

![requetIdleCallbackå’ŒrequestAnmationFrameåŠ¨ç”»å¾ˆå¿™](https://user-images.githubusercontent.com/8088864/125779688-be382539-51e0-4462-afee-ddb5db99b2bb.gif)

å…¶å®å’Œæˆ‘ä»¬é¢„æœŸçš„ä¸€æ ·ï¼Œç”±äºæµè§ˆå™¨çš„æ¯ä¸€å¸§éƒ½"å¤ªå¿™äº†",å¯¼è‡´å®ƒçœŸçš„å°±æ— è§†æˆ‘ä»¬çš„ rIC å‡½æ•°äº†ã€‚

å¦‚æœç»™ rIC å‡½æ•°åŠ ä¸€ä¸ª timeout å‘¢ï¼š


``` html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      #SomeElementYouWantToAnimate {
        height: 200px;
        width: 200px;
        background: red;
      }
    </style>
  </head>
  <body>
    <div id="SomeElementYouWantToAnimate"></div>
    <script>
      var start = null;
      var element = document.getElementById("SomeElementYouWantToAnimate");
      element.style.position = "absolute";

      function step(timestamp) {
        if (!start) start = timestamp;
        var progress = timestamp - start;
        element.style.left = Math.min(progress / 10, 200) + "px";
        let i = 1000;
        while (i > 0) {
          console.log("i", i);
          i--;
        }
        if (progress < 2000) {
          window.requestAnimationFrame(step);
        }
      }

      // åŠ¨ç”»
      window.requestAnimationFrame(step);

      // ç©ºé—²è°ƒåº¦
      window.requestIdleCallback((deadline) => {
        console.log(deadline.timeRemaining())
        alert("rIC");
      }, { timeout: 500 });
    </script>
  </body>
</html>
```

æ•ˆæœå¦‚ä¸‹ï¼š

![requetIdleCallbackå’ŒrequestAnmationFrameåŠ¨ç”»å¾ˆå¿™å†åŠ ä¸Štimeout](https://user-images.githubusercontent.com/8088864/125779998-cf9201d8-707b-4d99-aece-9e40c4f7b2a2.gif)

æµè§ˆå™¨ä¼šåœ¨å¤§æ¦‚ 500ms çš„æ—¶å€™ï¼Œä¸ç®¡æœ‰å¤šå¿™ï¼Œéƒ½å»å¼ºåˆ¶æ‰§è¡Œ `rIC` å‡½æ•°ï¼Œè¿™ä¸ªæœºåˆ¶å¯ä»¥é˜²æ­¢æˆ‘ä»¬çš„ç©ºé—²ä»»åŠ¡è¢«â€œé¥¿æ­»â€ã€‚

### æ€»ç»“

é€šè¿‡æœ¬æ–‡çš„å­¦ä¹ è¿‡ç¨‹ï¼Œæˆ‘è‡ªå·±ä¹Ÿæ‰“ç ´äº†å¾ˆå¤šå¯¹äº Event Loop ä»¥åŠ rAFã€rIC å‡½æ•°çš„å›ºæœ‰é”™è¯¯è®¤çŸ¥ï¼Œé€šè¿‡æœ¬æ–‡æˆ‘ä»¬å¯ä»¥æ•´ç†å‡ºä»¥ä¸‹çš„å‡ ä¸ªå…³é”®ç‚¹ã€‚

1. äº‹ä»¶å¾ªç¯ä¸ä¸€å®šæ¯è½®éƒ½ä¼´éšç€é‡æ–°æ¸²æŸ“ï¼Œä½†æ˜¯å¦‚æœæœ‰å¾®ä»»åŠ¡ï¼Œä¸€å®šä¼šä¼´éšç€å¾®ä»»åŠ¡æ‰§è¡Œã€‚
2. å†³å®šæµè§ˆå™¨è§†å›¾æ˜¯å¦æ¸²æŸ“çš„å› ç´ å¾ˆå¤šï¼Œæµè§ˆå™¨æ˜¯éå¸¸èªæ˜çš„ã€‚
3. requestAnimationFrameåœ¨é‡æ–°æ¸²æŸ“å±å¹•ä¹‹å‰æ‰§è¡Œï¼Œéå¸¸é€‚åˆç”¨æ¥åšåŠ¨ç”»ã€‚
4. requestIdleCallbackåœ¨æ¸²æŸ“å±å¹•ä¹‹åæ‰§è¡Œï¼Œå¹¶ä¸”æ˜¯å¦æœ‰ç©ºæ‰§è¡Œè¦çœ‹æµè§ˆå™¨çš„è°ƒåº¦ï¼Œå¦‚æœä½ ä¸€å®šè¦å®ƒåœ¨æŸä¸ªæ—¶é—´å†…æ‰§è¡Œï¼Œè¯·ä½¿ç”¨ timeoutå‚æ•°ã€‚
5. resizeå’Œscrolläº‹ä»¶å…¶å®è‡ªå¸¦èŠ‚æµï¼Œå®ƒåªåœ¨ Event Loop çš„æ¸²æŸ“é˜¶æ®µå»æ´¾å‘äº‹ä»¶åˆ° EventTarget ä¸Šã€‚

## æµè§ˆå™¨æ¸²æŸ“æœºåˆ¶

**æµè§ˆå™¨çš„æ¸²æŸ“æœºåˆ¶ä¸€èˆ¬åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤**

- å¤„ç† `HTML` å¹¶æ„å»º `DOM` æ ‘ã€‚
- å¤„ç† `CSS` æ„å»º `CSSOM` æ ‘ã€‚
- å°† `DOM` ä¸ `CSSOM` åˆå¹¶æˆä¸€ä¸ªæ¸²æŸ“æ ‘ã€‚
- æ ¹æ®æ¸²æŸ“æ ‘æ¥å¸ƒå±€ï¼Œè®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„ä½ç½®ã€‚
- è°ƒç”¨ `GPU` ç»˜åˆ¶ï¼Œåˆæˆå›¾å±‚ï¼Œæ˜¾ç¤ºåœ¨å±å¹•ä¸Š

![](https://user-gold-cdn.xitu.io/2018/4/11/162b2ab2ec70ac5b?w=900&h=352&f=png&s=49983)

- åœ¨æ„å»º CSSOM æ ‘æ—¶ï¼Œä¼šé˜»å¡æ¸²æŸ“ï¼Œç›´è‡³ CSSOM æ ‘æ„å»ºå®Œæˆã€‚å¹¶ä¸”æ„å»º CSSOM æ ‘æ˜¯ä¸€ä¸ªååˆ†æ¶ˆè€—æ€§èƒ½çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥åº”è¯¥å°½é‡ä¿è¯å±‚çº§æ‰å¹³ï¼Œå‡å°‘è¿‡åº¦å±‚å ï¼Œè¶Šæ˜¯å…·ä½“çš„ CSS é€‰æ‹©å™¨ï¼Œæ‰§è¡Œé€Ÿåº¦è¶Šæ…¢
- å½“ HTML è§£æåˆ° script æ ‡ç­¾æ—¶ï¼Œä¼šæš‚åœæ„å»º DOMï¼Œå®Œæˆåæ‰ä¼šä»æš‚åœçš„åœ°æ–¹é‡æ–°å¼€å§‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä½ æƒ³é¦–å±æ¸²æŸ“çš„è¶Šå¿«ï¼Œå°±è¶Šä¸åº”è¯¥åœ¨é¦–å±å°±åŠ è½½ JS æ–‡ä»¶ã€‚å¹¶ä¸” CSS ä¹Ÿä¼šå½±å“ JS çš„æ‰§è¡Œï¼Œåªæœ‰å½“è§£æå®Œæ ·å¼è¡¨æ‰ä¼šæ‰§è¡Œ JSï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥è®¤ä¸ºè¿™ç§æƒ…å†µä¸‹ï¼ŒCSS ä¹Ÿä¼šæš‚åœæ„å»º DOM

### 5.1 å›¾å±‚

> ä¸€èˆ¬æ¥è¯´ï¼Œå¯ä»¥æŠŠæ™®é€šæ–‡æ¡£æµçœ‹æˆä¸€ä¸ªå›¾å±‚ã€‚ç‰¹å®šçš„å±æ€§å¯ä»¥ç”Ÿæˆä¸€ä¸ªæ–°çš„å›¾å±‚ã€‚ä¸åŒçš„å›¾å±‚æ¸²æŸ“äº’ä¸å½±å“ï¼Œæ‰€ä»¥å¯¹äºæŸäº›é¢‘ç¹éœ€è¦æ¸²æŸ“çš„å»ºè®®å•ç‹¬ç”Ÿæˆä¸€ä¸ªæ–°å›¾å±‚ï¼Œæé«˜æ€§èƒ½ã€‚ä½†ä¹Ÿä¸èƒ½ç”Ÿæˆè¿‡å¤šçš„å›¾å±‚ï¼Œä¼šå¼•èµ·åä½œç”¨

**é€šè¿‡ä»¥ä¸‹å‡ ä¸ªå¸¸ç”¨å±æ€§å¯ä»¥ç”Ÿæˆæ–°å›¾å±‚**

- 3D å˜æ¢ï¼š`translate3d`ã€`translateZ`
- `will-change`
- `video`ã€`iframe` æ ‡ç­¾
- é€šè¿‡åŠ¨ç”»å®ç°çš„ `opacity` åŠ¨ç”»è½¬æ¢
- `position: fixed`

### 5.2 é‡ç»˜ï¼ˆRepaintï¼‰å’Œå›æµï¼ˆReflowï¼‰

- é‡ç»˜æ˜¯å½“èŠ‚ç‚¹éœ€è¦æ›´æ”¹å¤–è§‚è€Œä¸ä¼šå½±å“å¸ƒå±€çš„ï¼Œæ¯”å¦‚æ”¹å˜ color å°±å«ç§°ä¸ºé‡ç»˜
- å›æµæ˜¯å¸ƒå±€æˆ–è€…å‡ ä½•å±æ€§éœ€è¦æ”¹å˜å°±ç§°ä¸ºå›æµ

> å›æµå¿…å®šä¼šå‘ç”Ÿé‡ç»˜ï¼Œé‡ç»˜ä¸ä¸€å®šä¼šå¼•å‘å›æµã€‚å›æµæ‰€éœ€çš„æˆæœ¬æ¯”é‡ç»˜é«˜çš„å¤šï¼Œæ”¹å˜æ·±å±‚æ¬¡çš„èŠ‚ç‚¹å¾ˆå¯èƒ½å¯¼è‡´çˆ¶èŠ‚ç‚¹çš„ä¸€ç³»åˆ—å›æµ

**æ‰€ä»¥ä»¥ä¸‹å‡ ä¸ªåŠ¨ä½œå¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜**ï¼š

- æ”¹å˜ window å¤§å°
- æ”¹å˜å­—ä½“
- æ·»åŠ æˆ–åˆ é™¤æ ·å¼
- æ–‡å­—æ”¹å˜
- å®šä½æˆ–è€…æµ®åŠ¨
- ç›’æ¨¡å‹

**å¾ˆå¤šäººä¸çŸ¥é“çš„æ˜¯ï¼Œé‡ç»˜å’Œå›æµå…¶å®å’Œ Event loop æœ‰å…³**

- å½“ Event loop æ‰§è¡Œå®Œ `Microtasks` åï¼Œä¼šåˆ¤æ–­ `document` æ˜¯å¦éœ€è¦æ›´æ–°ã€‚å› ä¸ºæµè§ˆå™¨æ˜¯ `60Hz `çš„åˆ·æ–°ç‡ï¼Œæ¯ `16ms `æ‰ä¼šæ›´æ–°ä¸€æ¬¡ã€‚
- ç„¶ååˆ¤æ–­æ˜¯å¦æœ‰ `resize` æˆ–è€… `scroll` ï¼Œæœ‰çš„è¯ä¼šå»è§¦å‘äº‹ä»¶ï¼Œæ‰€ä»¥ `resize` å’Œ `scroll` äº‹ä»¶ä¹Ÿæ˜¯è‡³å°‘ `16ms` æ‰ä¼šè§¦å‘ä¸€æ¬¡ï¼Œå¹¶ä¸”è‡ªå¸¦èŠ‚æµåŠŸèƒ½ã€‚
- åˆ¤æ–­æ˜¯å¦è§¦å‘äº†` media query`
- æ›´æ–°åŠ¨ç”»å¹¶ä¸”å‘é€äº‹ä»¶
- åˆ¤æ–­æ˜¯å¦æœ‰å…¨å±æ“ä½œäº‹ä»¶
- æ‰§è¡Œ `requestAnimationFrame` å›è°ƒ
- æ‰§è¡Œ `IntersectionObserver` å›è°ƒï¼Œè¯¥æ–¹æ³•ç”¨äºåˆ¤æ–­å…ƒç´ æ˜¯å¦å¯è§ï¼Œå¯ä»¥ç”¨äºæ‡’åŠ è½½ä¸Šï¼Œä½†æ˜¯å…¼å®¹æ€§ä¸å¥½
- æ›´æ–°ç•Œé¢
- ä»¥ä¸Šå°±æ˜¯ä¸€å¸§ä¸­å¯èƒ½ä¼šåšçš„äº‹æƒ…ã€‚å¦‚æœåœ¨ä¸€å¸§ä¸­æœ‰ç©ºé—²æ—¶é—´ï¼Œå°±ä¼šå»æ‰§è¡Œ `requestIdleCallback` å›è°ƒ

**å‡å°‘é‡ç»˜å’Œå›æµ**

- ä½¿ç”¨ `translate` æ›¿ä»£ `top`
- ä½¿ç”¨ `visibility` æ›¿æ¢` display: none` ï¼Œå› ä¸ºå‰è€…åªä¼šå¼•èµ·é‡ç»˜ï¼Œåè€…ä¼šå¼•å‘å›æµï¼ˆæ”¹å˜äº†å¸ƒå±€ï¼‰
- ä¸è¦ä½¿ç”¨ `table` å¸ƒå±€ï¼Œå¯èƒ½å¾ˆå°çš„ä¸€ä¸ªå°æ”¹åŠ¨ä¼šé€ æˆæ•´ä¸ª table çš„é‡æ–°å¸ƒå±€
- åŠ¨ç”»å®ç°çš„é€Ÿåº¦çš„é€‰æ‹©ï¼ŒåŠ¨ç”»é€Ÿåº¦è¶Šå¿«ï¼Œå›æµæ¬¡æ•°è¶Šå¤šï¼Œä¹Ÿå¯ä»¥é€‰æ‹©ä½¿ç”¨ `requestAnimationFrame`
- `CSS` é€‰æ‹©ç¬¦ä»å³å¾€å·¦åŒ¹é…æŸ¥æ‰¾ï¼Œé¿å… `DOM` æ·±åº¦è¿‡æ·±
- å°†é¢‘ç¹è¿è¡Œçš„åŠ¨ç”»å˜ä¸ºå›¾å±‚ï¼Œå›¾å±‚èƒ½å¤Ÿé˜»æ­¢è¯¥èŠ‚ç‚¹å›æµå½±å“åˆ«çš„å…ƒç´ ã€‚æ¯”å¦‚å¯¹äº `video `æ ‡ç­¾ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å°†è¯¥èŠ‚ç‚¹å˜ä¸ºå›¾å±‚


## DOMäº‹ä»¶çš„æ€»ç»“

**çŸ¥è¯†ç‚¹ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š**

- åŸºæœ¬æ¦‚å¿µï¼š`DOM`äº‹ä»¶çš„çº§åˆ«

> é¢è¯•ä¸ä¼šç›´æ¥é—®ä½ ï¼ŒDOMæœ‰å‡ ä¸ªçº§åˆ«ã€‚ä½†ä¼šåœ¨é¢˜ç›®ä¸­ä½“ç°ï¼šâ€œè¯·ç”¨`DOM2` ....â€ã€‚


- `DOM`äº‹ä»¶æ¨¡å‹ã€`DOM`äº‹ä»¶æµ

> é¢è¯•å®˜å¦‚æœé—®ä½ â€œ**DOMäº‹ä»¶æ¨¡å‹**â€ï¼Œä½ ä¸ä¸€å®šçŸ¥é“æ€ä¹ˆå›äº‹ã€‚å…¶å®è¯´çš„å°±æ˜¯**æ•è·å’Œå†’æ³¡**ã€‚

**DOMäº‹ä»¶æµ**ï¼ŒæŒ‡çš„æ˜¯äº‹ä»¶ä¼ é€’çš„**ä¸‰ä¸ªé˜¶æ®µ**ã€‚

- æè¿°`DOM`äº‹ä»¶æ•è·çš„å…·ä½“æµç¨‹

> è®²çš„æ˜¯äº‹ä»¶çš„ä¼ é€’é¡ºåºã€‚å‚æ•°ä¸º`false`ï¼ˆé»˜è®¤ï¼‰ã€å‚æ•°ä¸º`true`ï¼Œå„è‡ªä»£è¡¨äº‹ä»¶åœ¨ä»€ä¹ˆé˜¶æ®µè§¦å‘ã€‚

èƒ½å›ç­”å‡ºæ¥çš„äººï¼Œå¯¥å¯¥æ— å‡ ã€‚ä¹Ÿè®¸æœ‰äº›äººå¯ä»¥è¯´å‡ºä¸€å¤§åŠï¼Œä½†æ˜¯ä¸€å­—ä¸è½çš„äººï¼Œæå°‘ã€‚

- `Event`å¯¹è±¡çš„å¸¸è§åº”ç”¨ï¼ˆ`Event`çš„å¸¸ç”¨`api`æ–¹æ³•ï¼‰

> `DOM`äº‹ä»¶çš„çŸ¥è¯†ç‚¹ï¼Œä¸€æ–¹é¢åŒ…æ‹¬äº‹ä»¶çš„æµç¨‹ï¼›å¦ä¸€æ–¹é¢å°±æ˜¯ï¼šæ€ä¹ˆå»æ³¨å†Œäº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯ç›‘å¬ç”¨æˆ·çš„äº¤äº’è¡Œä¸ºã€‚ç¬¬ä¸‰ç‚¹ï¼šåœ¨å“åº”æ—¶ï¼Œ`Event`å¯¹è±¡æ˜¯éå¸¸é‡è¦çš„ã€‚

**è‡ªå®šä¹‰äº‹ä»¶ï¼ˆéå¸¸é‡è¦ï¼‰**

> ä¸€èˆ¬äººå¯ä»¥è®²å‡ºäº‹ä»¶å’Œæ³¨å†Œäº‹ä»¶ï¼Œä½†æ˜¯å¦‚æœè®©ä½ è®²**è‡ªå®šä¹‰äº‹ä»¶**ï¼Œèƒ½çŸ¥é“çš„äººï¼Œå°±æ›´å°‘äº†ã€‚

**DOMäº‹ä»¶çš„çº§åˆ«**

> `DOM`äº‹ä»¶çš„çº§åˆ«ï¼Œå‡†ç¡®æ¥è¯´ï¼Œæ˜¯**DOMæ ‡å‡†**å®šä¹‰çš„çº§åˆ«ã€‚åŒ…æ‹¬ï¼š

**DOM0çš„å†™æ³•ï¼š**

```javascript
  element.onclick = function () {

  }
```

> ä¸Šé¢çš„ä»£ç æ˜¯åœ¨ `js` ä¸­çš„å†™æ³•ï¼›å¦‚æœè¦åœ¨`html`ä¸­å†™ï¼Œå†™æ³•æ˜¯ï¼šåœ¨`onclick`å±æ€§ä¸­ï¼ŒåŠ  `js` è¯­å¥ã€‚

**DOM2çš„å†™æ³•ï¼š**

```javascript
  element.addEventListener('click', function () {

  }, false);
```

>ã€é‡è¦ã€‘ä¸Šé¢çš„ç¬¬ä¸‰å‚æ•°ä¸­ï¼Œ**true**è¡¨ç¤ºäº‹ä»¶åœ¨**æ•è·é˜¶æ®µ**è§¦å‘ï¼Œ**false**è¡¨ç¤ºäº‹ä»¶åœ¨**å†’æ³¡é˜¶æ®µ**è§¦å‘ï¼ˆé»˜è®¤ï¼‰ã€‚å¦‚æœä¸å†™ï¼Œåˆ™é»˜è®¤ä¸ºfalseã€‚

**DOM3çš„å†™æ³•ï¼š**


```javascript
    element.addEventListener('keyup', function () {

    }, false);
```

> `DOM3`ä¸­ï¼Œå¢åŠ äº†å¾ˆå¤šäº‹ä»¶ç±»å‹ï¼Œæ¯”å¦‚é¼ æ ‡äº‹ä»¶ã€é”®ç›˜äº‹ä»¶ç­‰ã€‚

> PSï¼šä¸ºä½•äº‹ä»¶æ²¡æœ‰`DOM1`çš„å†™æ³•å‘¢ï¼Ÿå› ä¸ºï¼Œ`DOM1`æ ‡å‡†åˆ¶å®šçš„æ—¶å€™ï¼Œæ²¡æœ‰æ¶‰åŠä¸äº‹ä»¶ç›¸å…³çš„å†…å®¹ã€‚

**æ€»ç»“**ï¼šå…³äºâ€œDOMäº‹ä»¶çš„çº§åˆ«â€ï¼Œèƒ½å›ç­”å‡ºä»¥ä¸Šå†…å®¹å³å¯ï¼Œä¸ä¼šå‡ºé¢˜ç›®è®©ä½ åšã€‚

**DOMäº‹ä»¶æ¨¡å‹**

> `DOM`äº‹ä»¶æ¨¡å‹è®²çš„å°±æ˜¯**æ•è·å’Œå†’æ³¡**ï¼Œä¸€èˆ¬äººéƒ½èƒ½å›ç­”å‡ºæ¥ã€‚

- æ•è·ï¼šä»ä¸Šå¾€ä¸‹ã€‚
- å†’æ³¡ï¼šä»ä¸‹ï¼ˆç›®æ ‡å…ƒç´ ï¼‰å¾€ä¸Šã€‚

**DOMäº‹ä»¶æµ**

> `DOM`äº‹ä»¶æµè®²çš„å°±æ˜¯ï¼šæµè§ˆå™¨åœ¨äºå½“å‰é¡µé¢åšäº¤äº’æ—¶ï¼Œè¿™ä¸ªäº‹ä»¶æ˜¯æ€ä¹ˆä¼ é€’åˆ°é¡µé¢ä¸Šçš„ã€‚

**å®Œæ•´çš„äº‹ä»¶æµï¼Œåˆ†ä¸‰ä¸ªé˜¶æ®µï¼š**

1. æ•è·ï¼šä» `window` å¯¹è±¡ä¼ åˆ° ç›®æ ‡å…ƒç´ ã€‚
2. ç›®æ ‡é˜¶æ®µï¼šäº‹ä»¶é€šè¿‡æ•è·ï¼Œåˆ°è¾¾ç›®æ ‡å…ƒç´ ï¼Œè¿™ä¸ªé˜¶æ®µå°±æ˜¯ç›®æ ‡é˜¶æ®µã€‚
3. å†’æ³¡ï¼šä»**ç›®æ ‡å…ƒç´ **ä¼ åˆ° `Window` å¯¹è±¡ã€‚

![](http://img.smyhvae.com/20180306_1058.png)

![](http://img.smyhvae.com/20180204_1218.jpg)

**æè¿°DOMäº‹ä»¶æ•è·çš„å…·ä½“æµç¨‹**

> å¾ˆå°‘æœ‰äººèƒ½è¯´å®Œæ•´ã€‚

**æ•è·çš„æµç¨‹**

![](http://img.smyhvae.com/20180306_1103.png)

**è¯´æ˜**ï¼šæ•è·é˜¶æ®µï¼Œäº‹ä»¶ä¾æ¬¡ä¼ é€’çš„é¡ºåºæ˜¯ï¼š`window` --> `document` --> `html`--> `body` --> çˆ¶å…ƒç´ ã€å­å…ƒç´ ã€ç›®æ ‡å…ƒç´ ã€‚

- PS1ï¼šç¬¬ä¸€ä¸ªæ¥æ”¶åˆ°äº‹ä»¶çš„å¯¹è±¡æ˜¯ **window**ï¼ˆæœ‰äººä¼šè¯´`body`ï¼Œæœ‰äººä¼šè¯´`html`ï¼Œè¿™éƒ½æ˜¯é”™è¯¯çš„ï¼‰ã€‚
- PS2ï¼š`JS`ä¸­æ¶‰åŠåˆ°`DOM`å¯¹è±¡æ—¶ï¼Œæœ‰ä¸¤ä¸ªå¯¹è±¡æœ€å¸¸ç”¨ï¼š`window`ã€`doucument`ã€‚å®ƒä»¬ä¿©ä¹Ÿæ˜¯æœ€å…ˆè·å–åˆ°äº‹ä»¶çš„ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```javascript
window.addEventListener("click", function () {
    alert("æ•è· window");
}, true);

document.addEventListener("click", function () {
    alert("æ•è· document");
}, true);

document.documentElement.addEventListener("click", function () {
    alert("æ•è· html");
}, true);

document.body.addEventListener("click", function () {
    alert("æ•è· body");
}, true);

fatherBox.addEventListener("click", function () {
    alert("æ•è· father");
}, true);

childBox.addEventListener("click", function () {
    alert("æ•è· child");
}, true);
```

**è¡¥å……ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼š**

> åœ¨ `js`ä¸­ï¼š

- å¦‚æœæƒ³è·å– `body` èŠ‚ç‚¹ï¼Œæ–¹æ³•æ˜¯ï¼š`document.body`ï¼›
- ä½†æ˜¯ï¼Œå¦‚æœæƒ³è·å– `html`èŠ‚ç‚¹ï¼Œæ–¹æ³•æ˜¯`document.documentElement`ã€‚

**å†’æ³¡çš„æµç¨‹**

> ä¸æ•è·çš„æµç¨‹ç›¸å

**Eventå¯¹è±¡çš„å¸¸è§ api æ–¹æ³•**

> ç”¨æˆ·åšçš„æ˜¯ä»€ä¹ˆæ“ä½œï¼ˆæ¯”å¦‚ï¼Œæ˜¯æ•²é”®ç›˜äº†ï¼Œè¿˜æ˜¯ç‚¹å‡»é¼ æ ‡äº†ï¼‰ï¼Œè¿™äº›äº‹ä»¶åŸºæœ¬éƒ½æ˜¯é€šè¿‡`Event`å¯¹è±¡æ‹¿åˆ°çš„ã€‚è¿™äº›éƒ½æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬å°±ä¸è®²äº†ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ä¸‹é¢è¿™å‡ ä¸ªæ–¹æ³•ï¼š

**æ–¹æ³•ä¸€**

```javascript
    event.preventDefault();
```

- è§£é‡Šï¼šé˜»æ­¢é»˜è®¤äº‹ä»¶ã€‚
- æ¯”å¦‚ï¼Œå·²çŸ¥`<a>`æ ‡ç­¾ç»‘å®šäº†clickäº‹ä»¶ï¼Œæ­¤æ—¶ï¼Œå¦‚æœç»™`<a>`è®¾ç½®äº†è¿™ä¸ªæ–¹æ³•ï¼Œå°±é˜»æ­¢äº†é“¾æ¥çš„é»˜è®¤è·³è½¬ã€‚

**æ–¹æ³•äºŒï¼šé˜»æ­¢å†’æ³¡**

> è¿™ä¸ªåœ¨ä¸šåŠ¡ä¸­å¾ˆå¸¸è§ã€‚

> æœ‰çš„æ—¶å€™ï¼Œä¸šåŠ¡ä¸­ä¸éœ€è¦äº‹ä»¶è¿›è¡Œå†’æ³¡ã€‚æ¯”å¦‚è¯´ï¼Œä¸šåŠ¡è¿™æ ·è¦æ±‚ï¼šå•å‡»å­å…ƒç´ åšäº‹ä»¶`A`ï¼Œå•å‡»çˆ¶å…ƒç´ åšäº‹ä»¶Bï¼Œå¦‚æœä¸é˜»æ­¢å†’æ³¡çš„è¯ï¼Œå‡ºç°çš„é—®é¢˜æ˜¯ï¼šå•å‡»å­å…ƒç´ æ—¶ï¼Œå­å…ƒç´ å’Œçˆ¶å…ƒç´ éƒ½ä¼šåšäº‹ä»¶`A`ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå°±è¦ç”¨åˆ°é˜»æ­¢å†’æ³¡äº†ã€‚


> `w3c`çš„æ–¹æ³•ï¼šï¼ˆç«ç‹ã€è°·æ­Œã€`IE11`ï¼‰

```javascript
    event.stopPropagation();
```

> `IE10`ä»¥ä¸‹åˆ™æ˜¯ï¼š

```javascript
	event.cancelBubble = true;
```

> å…¼å®¹ä»£ç å¦‚ä¸‹ï¼š

```javascript
   box3.onclick = function (event) {

        alert("child");

        //é˜»æ­¢å†’æ³¡
        event = event || window.event;

        if (event && event.stopPropagation) {
            event.stopPropagation();
        } else {
            event.cancelBubble = true;
        }
    }
```

> ä¸Šæ–¹ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯¹`box3`è¿›è¡Œäº†é˜»æ­¢å†’æ³¡ï¼Œäº§ç”Ÿçš„æ•ˆæœæ˜¯ï¼šäº‹ä»¶ä¸ä¼šç»§ç»­ä¼ é€’åˆ° `father`ã€`grandfather`ã€`body`äº†ã€‚

**æ–¹æ³•ä¸‰ï¼šè®¾ç½®äº‹ä»¶ä¼˜å…ˆçº§**

```javascript
    event.stopImmediatePropagation();
```

è¿™ä¸ªæ–¹æ³•æ¯”è¾ƒé•¿ï¼Œä¸€èˆ¬äººæ²¡å¬è¯´è¿‡ã€‚è§£é‡Šå¦‚ä¸‹ï¼š

> æ¯”å¦‚è¯´ï¼Œæˆ‘ç”¨`addEventListener`ç»™æŸæŒ‰é’®åŒæ—¶æ³¨å†Œäº†äº‹ä»¶`A`ã€äº‹ä»¶`B`ã€‚æ­¤æ—¶ï¼Œå¦‚æœæˆ‘å•å‡»æŒ‰é’®ï¼Œå°±ä¼šä¾æ¬¡æ‰§è¡Œäº‹ä»¶Aå’Œäº‹ä»¶`B`ã€‚ç°åœ¨è¦æ±‚ï¼šå•å‡»æŒ‰é’®æ—¶ï¼Œåªæ‰§è¡Œäº‹ä»¶Aï¼Œä¸æ‰§è¡Œäº‹ä»¶`B`ã€‚è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿè¿™æ˜¯æ—¶å€™ï¼Œå°±å¯ä»¥ç”¨åˆ°`stopImmediatePropagation`æ–¹æ³•äº†ã€‚åšæ³•æ˜¯ï¼šåœ¨äº‹ä»¶Açš„å“åº”å‡½æ•°ä¸­åŠ å…¥è¿™å¥è¯ã€‚

> å¤§å®¶è¦è®°ä½ `event` æœ‰è¿™ä¸ªæ–¹æ³•ã€‚

**å±æ€§4ã€å±æ€§5ï¼ˆäº‹ä»¶å§”æ‰˜ä¸­ç”¨åˆ°ï¼‰**

```javascript

    event.currentTarget   //å½“å‰æ‰€ç»‘å®šçš„äº‹ä»¶å¯¹è±¡ã€‚åœ¨äº‹ä»¶å§”æ‰˜ä¸­ï¼ŒæŒ‡çš„æ˜¯ã€çˆ¶å…ƒç´ ã€‘ã€‚

    event.target  //å½“å‰è¢«ç‚¹å‡»çš„å…ƒç´ ã€‚åœ¨äº‹ä»¶å§”æ‰˜ä¸­ï¼ŒæŒ‡çš„æ˜¯ã€å­å…ƒç´ ã€‘ã€‚

```

ä¸Šé¢è¿™ä¸¤ä¸ªå±æ€§ï¼Œåœ¨äº‹ä»¶å§”æ‰˜ä¸­ç»å¸¸ç”¨åˆ°ã€‚

> **æ€»ç»“**ï¼šä¸Šé¢è¿™å‡ é¡¹ï¼Œéå¸¸é‡è¦ï¼Œä½†æ˜¯å®¹æ˜“å¼„æ··æ·†ã€‚

**è‡ªå®šä¹‰äº‹ä»¶**

> è‡ªå®šä¹‰äº‹ä»¶çš„ä»£ç å¦‚ä¸‹ï¼š


```javascript
    var myEvent = new Event('clickTest');
    element.addEventListener('clickTest', function () {
        console.log('smyhvae');
    });

	//å…ƒç´ æ³¨å†Œäº‹ä»¶
    element.dispatchEvent(myEvent); //æ³¨æ„ï¼Œå‚æ•°æ˜¯å†™äº‹ä»¶å¯¹è±¡ myEventï¼Œä¸æ˜¯å†™ äº‹ä»¶å clickTest

```

> ä¸Šé¢è¿™ä¸ªäº‹ä»¶æ˜¯å®šä¹‰å®Œäº†ä¹‹åï¼Œå°±ç›´æ¥è‡ªåŠ¨è§¦å‘äº†ã€‚åœ¨æ­£å¸¸çš„ä¸šåŠ¡ä¸­ï¼Œè¿™ä¸ªäº‹ä»¶ä¸€èˆ¬æ˜¯å’Œåˆ«çš„äº‹ä»¶ç»“åˆç”¨çš„ã€‚æ¯”å¦‚å»¶æ—¶å™¨è®¾ç½®æŒ‰é’®çš„åŠ¨ä½œï¼š

```javascript
    var myEvent = new Event('clickTest');

    element.addEventListener('clickTest', function () {
        console.log('smyhvae');
    });

    setTimeout(function () {
        element.dispatchEvent(myEvent); //æ³¨æ„ï¼Œå‚æ•°æ˜¯å†™äº‹ä»¶å¯¹è±¡ myEventï¼Œä¸æ˜¯å†™ äº‹ä»¶å clickTest
    }, 1000);
```

## äº‹ä»¶æœºåˆ¶

### 1.1 äº‹ä»¶è§¦å‘ä¸‰é˜¶æ®µ

- document å¾€äº‹ä»¶è§¦å‘å¤„ä¼ æ’­ï¼Œé‡åˆ°æ³¨å†Œçš„æ•è·äº‹ä»¶ä¼šè§¦å‘
- ä¼ æ’­åˆ°äº‹ä»¶è§¦å‘å¤„æ—¶è§¦å‘æ³¨å†Œçš„äº‹ä»¶
- ä»äº‹ä»¶è§¦å‘å¤„å¾€ document ä¼ æ’­ï¼Œé‡åˆ°æ³¨å†Œçš„å†’æ³¡äº‹ä»¶ä¼šè§¦å‘

> äº‹ä»¶è§¦å‘ä¸€èˆ¬æ¥è¯´ä¼šæŒ‰ç…§ä¸Šé¢çš„é¡ºåºè¿›è¡Œï¼Œä½†æ˜¯ä¹Ÿæœ‰ç‰¹ä¾‹ï¼Œå¦‚æœç»™ä¸€ä¸ªç›®æ ‡èŠ‚ç‚¹åŒæ—¶æ³¨å†Œå†’æ³¡å’Œæ•è·äº‹ä»¶ï¼Œäº‹ä»¶è§¦å‘ä¼šæŒ‰ç…§æ³¨å†Œçš„é¡ºåºæ‰§è¡Œ

```
// ä»¥ä¸‹ä¼šå…ˆæ‰“å°å†’æ³¡ç„¶åæ˜¯æ•è·
node.addEventListener('click',(event) =>{
	console.log('å†’æ³¡')
},false);
node.addEventListener('click',(event) =>{
	console.log('æ•è· ')
},true)
```

### 1.2 æ³¨å†Œäº‹ä»¶

- é€šå¸¸æˆ‘ä»¬ä½¿ç”¨ `addEventListener` æ³¨å†Œäº‹ä»¶ï¼Œè¯¥å‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°å¯ä»¥æ˜¯å¸ƒå°”å€¼ï¼Œä¹Ÿå¯ä»¥æ˜¯å¯¹è±¡ã€‚å¯¹äºå¸ƒå°”å€¼ `useCapture` å‚æ•°æ¥è¯´ï¼Œè¯¥å‚æ•°é»˜è®¤å€¼ä¸º `false` ã€‚`useCapture` å†³å®šäº†æ³¨å†Œçš„äº‹ä»¶æ˜¯æ•è·äº‹ä»¶è¿˜æ˜¯å†’æ³¡äº‹ä»¶
- ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬åªå¸Œæœ›äº‹ä»¶åªè§¦å‘åœ¨ç›®æ ‡ä¸Šï¼Œè¿™æ—¶å€™å¯ä»¥ä½¿ç”¨ `stopPropagation` æ¥é˜»æ­¢äº‹ä»¶çš„è¿›ä¸€æ­¥ä¼ æ’­ã€‚é€šå¸¸æˆ‘ä»¬è®¤ä¸º `stopPropagation` æ˜¯ç”¨æ¥é˜»æ­¢äº‹ä»¶å†’æ³¡çš„ï¼Œå…¶å®è¯¥å‡½æ•°ä¹Ÿå¯ä»¥é˜»æ­¢æ•è·äº‹ä»¶ã€‚`stopImmediatePropagation` åŒæ ·ä¹Ÿèƒ½å®ç°é˜»æ­¢äº‹ä»¶ï¼Œä½†æ˜¯è¿˜èƒ½é˜»æ­¢è¯¥äº‹ä»¶ç›®æ ‡æ‰§è¡Œåˆ«çš„æ³¨å†Œäº‹ä»¶

```javascript
node.addEventListener('click',(event) =>{
	event.stopImmediatePropagation()
	console.log('å†’æ³¡')
},false);
// ç‚¹å‡» node åªä¼šæ‰§è¡Œä¸Šé¢çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸ä¼šæ‰§è¡Œ
node.addEventListener('click',(event) => {
	console.log('æ•è· ')
},true)
```

### 1.3 äº‹ä»¶ä»£ç†

> å¦‚æœä¸€ä¸ªèŠ‚ç‚¹ä¸­çš„å­èŠ‚ç‚¹æ˜¯åŠ¨æ€ç”Ÿæˆçš„ï¼Œé‚£ä¹ˆå­èŠ‚ç‚¹éœ€è¦æ³¨å†Œäº‹ä»¶çš„è¯åº”è¯¥æ³¨å†Œåœ¨çˆ¶èŠ‚ç‚¹ä¸Š

```html
<ul id="ul">
	<li>1</li>
    <li>2</li>
	<li>3</li>
	<li>4</li>
	<li>5</li>
</ul>
<script>
	let ul = document.querySelector('##ul')
	ul.addEventListener('click', (event) => {
		console.log(event.target);
	})
</script>
```

> äº‹ä»¶ä»£ç†çš„æ–¹å¼ç›¸å¯¹äºç›´æ¥ç»™ç›®æ ‡æ³¨å†Œäº‹ä»¶æ¥è¯´ï¼Œæœ‰ä»¥ä¸‹ä¼˜ç‚¹

- èŠ‚çœå†…å­˜
- ä¸éœ€è¦ç»™å­èŠ‚ç‚¹æ³¨é”€äº‹ä»¶


## Canvasç›¸å…³API

Canvas API æä¾›äº†ä¸€ä¸ªé€šè¿‡JavaScript å’Œ HTMLçš„`<canvas>`å…ƒç´ æ¥ç»˜åˆ¶å›¾å½¢çš„æ–¹å¼ã€‚å®ƒå¯ä»¥ç”¨äºåŠ¨ç”»ã€æ¸¸æˆç”»é¢ã€æ•°æ®å¯è§†åŒ–ã€å›¾ç‰‡ç¼–è¾‘ä»¥åŠå®æ—¶è§†é¢‘å¤„ç†ç­‰æ–¹é¢ã€‚

Canvas APIä¸»è¦èšç„¦äº2Då›¾å½¢ã€‚è€ŒåŒæ ·ä½¿ç”¨`<canvas>`å…ƒç´ çš„ WebGL API åˆ™ç”¨äºç»˜åˆ¶ç¡¬ä»¶åŠ é€Ÿçš„2Då’Œ3Då›¾å½¢ã€‚

### æ ‡ç­¾

``` html
<canvas width="600" height="400" id="canvas"></canvas>
```

ä¸ç»™å®½é«˜çš„è¯é»˜è®¤æ˜¯300+150

### æ€ä¹ˆç”¨

``` js
// æ‹¿åˆ°canvas
var canvas = document.getElementById("canvas");
// åˆ›å»ºç”»å›¾å·¥å…·
var context = canvas.getContext("2d");
```

### ç›¸å…³çš„apiåŠç”¨æ³•

``` html
<!DOCTYPE html>
<html>
<body>

<canvas id="myCanvas" width="600" height="500" style="border:1px solid #d3d3d3;">
  Your browser does not support the HTML5 canvas tag.
</canvas>

<script>

var canvas = document.getElementById("myCanvas");
var context = canvas.getContext("2d");

// ç”»çº¿
context.moveTo(100, 100);
context.lineTo(300, 100);
context.lineTo(300, 200);

// ç”»ç¬¬äºŒæ¡çº¿
// ç”»ç¬¬äºŒæ¡çº¿
context.moveTo(100, 300);
context.lineTo(300, 300);

// æœ€åè¦æè¾¹æ‰ä¼šå‡ºæ•ˆæœ
context.stroke();

// åˆ›å»ºä¸€å¼ æ–°çš„ç»ç’ƒçº¸
context.beginPath();
// ç”»ç¬¬ä¸‰æ¡çº¿
context.moveTo(400, 100);
context.lineTo(400, 300);
context.lineTo(500, 300);
context.lineTo(500, 200);

// åªè¦æ‰§è¡Œstrokeï¼Œéƒ½ä¼šç»ç’ƒçº¸ä¸Šçš„å›¾å½¢é‡å¤å°åˆ·ä¸€æ¬¡
context.stroke();

// å¡«å……
context.fill();
context.fillStyle = "gray";

// è®¾ç½®æè¾¹è‰²
context.strokeStyle = "red"; // é¢œè‰²çš„å†™æ³•å’Œcsså†™æ³•æ˜¯ä¸€æ ·çš„
context.stroke();

//å¡«å……
//è®¾ç½®å¡«å……è‰²
context.fillStyle = "yellowgreen";
context.fill();

//æŠŠè·¯å¾„é—­åˆ
context.closePath();

//è®¾ç½®çº¿æ¡çš„ç²—ç»†ï¼Œ ä¸éœ€è¦åŠ px
context.lineWidth = 15;
//çº¿æ¡çš„å¤´éƒ¨çš„è®¾ç½®
context.lineCap = "round"; //é»˜è®¤æ˜¯buttï¼Œ è®°ä½round
</script>

</body>
</html>
```

æ•ˆæœå¦‚ä¸‹æ‰€ç¤º:

![Canvas LineTo æ•ˆæœå›¾](https://user-images.githubusercontent.com/8088864/125880740-1d667e65-6511-4fd1-96a2-c697fa62aba3.png)

#### ç”»çŸ©å½¢

``` js
// ç›´æ¥ä¼ å…¥ xï¼Œ yï¼Œ widthï¼Œ heightï¼Œ å°±å¯ä»¥ç»˜åˆ¶ä¸€ä¸ªçŸ©å½¢
// ç”»åœ¨ç»ç’ƒçº¸ä¸Š

context.rect(100, 100, 200, 200);
context.strokeStyle = "red";
context.stroke();
context.fillStyle = "yellow";
context.fill();
```

``` js
// ç›´æ¥åˆ›å»ºä¸€ä¸ªå¡«å……çš„çŸ©å½¢
// åˆ›å»ºç»ç’ƒçº¸ï¼Œ ç”»çŸ©å½¢è·¯å¾„ï¼Œ å¡«å……ï¼Œ æŠŠç»ç’ƒçº¸é”€æ¯
context.fillRect(100, 100, 200, 200);

// é»„è‰²çš„è¾¹ä¸ä¼šæ˜¾ç¤ºï¼Œæ˜¯å› ä¸ºä¸Šé¢é‚£ä¸€å¥ï¼Œç”»å®Œä¹‹åï¼Œå°±æŠŠç»ç’ƒçº¸é”€æ¯äº†
context.strokeStyle = "yellow";
context.stroke();
// å¦‚æœæ”¾åœ¨fillRectä¸Šé¢å°±å¯ä»¥å®ç°
```

#### åœ†å½¢ç»˜åˆ¶

``` js
// xè½´æ˜¯0åº¦å¼€å§‹
// x, y: åœ†å¿ƒä½ç½®ï¼›radiusï¼š åŠå¾„çš„é•¿åº¦; startRadian, endRadian ä»£è¡¨çš„æ˜¯èµ·å§‹å¼§åº¦å’Œç»“æŸå¼§åº¦ï¼›dircetionä»£è¡¨çš„åœ†å½¢çš„è·¯å¾„çš„æ–¹å‘ï¼Œé»˜è®¤æ˜¯é¡ºæ—¶é’ˆï¼ˆæ˜¯å¦é€†æ—¶é’ˆï¼Œ é»˜è®¤å€¼æ˜¯falseï¼‰ï¼Œå¦‚æœä¼ trueå°±æ˜¯é€†æ—¶é’ˆ,æœ€åä¸€ä¸ªå‚æ•°æ˜¯å¯ä»¥ä¸ä¼ çš„ï¼Œ é»˜è®¤å°±æ˜¯é¡ºæ—¶é’ˆ

// context.arc(x, y, radius, startRadian, endRadian, direction);

// ä»31åº¦çš„åœ°æ–¹ï¼Œç”»åˆ°81åº¦çš„åœ°æ–¹
context.arc(300, 200, 100, 31/180*Math.PI, 81/180*Math.PI);

context.strokeStyle = "yellow";
context.stroke();

context.fillStyle = "red";
context.fill();
```

#### ç”»é£é•–è½¬ç›˜

``` js
for (var i = 0; i < 10; i++) {
    context.moveTo(320+i*20,200);
    // i % 2ä»£è¡¨æ˜¯å¥‡æ•°è¿˜æ˜¯å¶æ•°ï¼Œ å¶æ•°å°±é€†æ—¶é’ˆï¼Œ å¥‡æ•°å°±é¡ºæ—¶é’ˆ
    context.arc(300, 200, 20 + i * 20, 0, 2*Math.PI, i%2==0);
}
context.fillStyle = "green";
context.fill();
context.stroke();
```

æ•ˆæœå›¾å¦‚ä¸‹æ‰€ç¤º:

![Canvas arc ç”»é£é•–è½¬ç›˜](https://user-images.githubusercontent.com/8088864/125925307-9fdd88ec-8569-412d-9245-37aceca560ba.png)

#### çº¿æ€§æ¸å˜

``` js
// 1. éœ€è¦åˆ›å»ºå‡ºä¸€ä¸ªæ¸å˜å¯¹è±¡
//    var gradient = context.createLinearGradient(100, 100, 300, 100);
// å‚æ•°ä»£è¡¨å“ªä¸ªç‚¹åˆ°å“ªä¸ªç‚¹ï¼Œè¿™é‡Œå†™çš„æ˜¯å·¦ä¸Šè§’åˆ°å³ä¸‹è§’çš„æ„æ€
var gradient = context.createLinearGradient(100, 100, 300, 380);

// 2. æ·»åŠ æ¸å˜é¢œè‰²
gradient.addColorStop(0, "red");
gradient.addColorStop(0.5, "hotpink");
gradient.addColorStop(1, "yellowgreen");

// 3. å°†æ¸å˜å¯¹è±¡è®¾ä¸ºå¡«å……è‰²
context.fillStyle = gradient;

// 4. ç”»ä¸€ä¸ªçŸ©å½¢
context.fillRect(100, 100, 200, 280);
```

æ•ˆæœå›¾å¦‚ä¸‹æ‰€ç¤º:

![Canvas createLinearGradient çº¿æ€§æ¸å˜](https://user-images.githubusercontent.com/8088864/125925678-c260361c-11cb-44cd-86f9-86156ea7033e.png)

#### å¾„å‘æ¸å˜

``` js
// 1. åˆ›å»ºæ¸å˜å¯¹è±¡
// å†…åœ†
var c1 = {x: 260, y: 160, r: 0};
// å¤–åœ†
var c2 = {x: 300, y: 200, r: 120};

var gradient = context.createRadialGradient(c1.x, c1.y, c1.r, c2.x, c2.y, c2.r);
gradient.addColorStop(0, "red");
gradient.addColorStop(0.3, "yellow");
gradient.addColorStop(0.6, "green");
gradient.addColorStop(1, "orange");

// 2. æŠŠæ¸å˜å¯¹è±¡è®¾ä¸ºå¡«å……è‰²
context.fillStyle = gradient;

// 3. ç”»åœ†å¹¶å¡«å……
// å†…åœ†çš„éƒ¨åˆ†æ˜¯ç”¨0çš„ä½ç½®å¡«å……çš„; å†…åœ†çš„è¾¹åˆ°å¤–åœ†çš„è¾¹æ‰€å‘ç”Ÿçš„æ¸å˜å«ï¼Œ å¾„å‘æ¸å˜
context.arc(c2.x, c2.y, c2.r, 0, 2*Math.PI);
context.fill();
```

æ•ˆæœå›¾å¦‚ä¸‹æ‰€ç¤º:

![Canvas createRadialGradient å¾„å‘æ¸å˜](https://user-images.githubusercontent.com/8088864/125926105-f8d0128c-fc71-4278-9c10-580d9dbf4d3c.png)

#### å¾„å‘æ¸å˜ç”»çƒ

``` js
//1. åˆ›å»ºä¸€ä¸ªå¾„å‘æ¸å˜
var c1 = {x: 240, y: 160, r: 0};
var c2 = {x: 300, y: 200, r: 120};

var gradient = context.createRadialGradient(c1.x, c1.y, c1.r, c2.x, c2.y, c2.r);
gradient.addColorStop(1, "gray");
gradient.addColorStop(0, "lightgray");

//2. å°†æ¸å˜å¯¹è±¡è®¾ä¸ºå¡«å……è‰²
context.fillStyle = gradient;

//3. ç”»åœ†å¹¶å¡«å……
context.arc(c2.x, c2.y, c2.r, 0, 2*Math.PI);
context.fill();
```

æ•ˆæœå›¾å¦‚ä¸‹æ‰€ç¤º:

![Canvas createRadialGradient å¾„å‘æ¸å˜ç”»çƒ](https://user-images.githubusercontent.com/8088864/125926450-19a90cf2-1049-4d2c-a47d-1f22fad0cd58.png)

#### å¾„å‘æ¸å˜ç”»å½©è™¹

``` js
//å®ç°å½©è™¹ï¼Œç»™é‡Œé¢çš„åœ†ä¸€ä¸ªåŠå¾„80æ˜¯å…³é”®
var c1 = {x: 300, y: 200, r: 80};
var c2 = {x: 300, y: 200, r: 150};
var gradient = context.createRadialGradient(c1.x, c1.y, c1.r, c2.x, c2.y, c2.r);
gradient.addColorStop(1, "red");
gradient.addColorStop(6/7, "orange");
gradient.addColorStop(5/7, "yellow");
gradient.addColorStop(4/7, "green");
gradient.addColorStop(3/7, "cyan");
gradient.addColorStop(2/7, "skyblue");
gradient.addColorStop(1/7, "purple");
gradient.addColorStop(0, "white");

//è®¾ä¸ºå¡«å……è‰²
context.fillStyle = gradient;

//ç”»åœ†å¹¶å¡«å……
context.arc(c2.x, c2.y, c2.r, 0, 2*Math.PI);
context.fill();

//é®æŒ¡ä¸‹åŠéƒ¨åˆ†
context.fillStyle = "white";
context.fillRect(0, 200, 600, 200);
```

æ•ˆæœå›¾å¦‚ä¸‹æ‰€ç¤º:

![Canvas createRadialGradient å¾„å‘æ¸å˜ç”»å½©è™¹](https://user-images.githubusercontent.com/8088864/125926965-02866a67-5dd9-4be1-84f3-b0589696e7f7.png)

#### é˜´å½±æ•ˆæœ

``` js
//å’Œcss3ç›¸æ¯”ï¼Œ é˜´å½±åªèƒ½è®¾ä¸€ä¸ªï¼Œ ä¸èƒ½è®¾å†…é˜´å½±
//æ°´å¹³åç§»ï¼Œ å‚ç›´çš„åç§»ï¼Œ æ¨¡ç³Šç¨‹åº¦ï¼Œ é˜´å½±çš„é¢œè‰²

//è®¾ç½®é˜´å½±çš„å‚æ•°
context.shadowOffsetX = 10;
context.shadowOffsetY = 10;
context.shadowBlur = 10;
context.shadowColor = "yellowgreen";

//ç”»ä¸€ä¸ªçŸ©å½¢
context.fillStyle = "red";
context.fillRect(100, 100, 300, 200);
```

æ•ˆæœå›¾å¦‚ä¸‹æ‰€ç¤º:

![Canvas shadow é˜´å½±æ•ˆæœ](https://user-images.githubusercontent.com/8088864/125927364-e91bafb3-7e90-4173-bd39-4ee8ae7da746.png)

#### ç»˜åˆ¶æ–‡å­—api

``` js
//ç»˜åˆ¶æ–‡å­—
//textå°±æ˜¯è¦ç»˜åˆ¶çš„æ–‡å­—ï¼Œ xï¼Œ yå°±æ˜¯ä»ä»€ä¹ˆåœ°æ–¹å¼€å§‹ç»˜åˆ¶
//context.strokeText("text", x, y)

context.font = "60px å¾®è½¯é›…é»‘";
//context.strokeText("hello, world", 100, 100);
context.fillText("hello, world", 100, 100);
```

æ•ˆæœå›¾å¦‚ä¸‹æ‰€ç¤º:

![Canvas fillText ç»˜åˆ¶æ–‡å­—](https://user-images.githubusercontent.com/8088864/125927573-fdaa09b5-93d7-4990-86ee-2fa9a453eab5.png)

#### æ–‡å­—å¯¹é½æ–¹å¼

``` js
//é»˜è®¤åœ¨left
//å…³é”®apiï¼šcontext.textAlign = "left";
context.textAlign = "left";
context.fillText("left", 300, 120);

context.textAlign = "center";
context.fillText("center", 300, 190);

context.textAlign = "right";
context.fillText("right", 300, 260);

// æ–‡å­—å‡ºç°åœ¨canvasçš„å³ä¸Šæ–¹
// 1. å…ˆè®¾ç½®right
// 2. ç»™canvas.width,0å³å¯
context.font = "60px å¾®è½¯é›…é»‘";
context.textAlign = "right";
context.textBaseline = "top";
context.fillText("hello, world", canvas.width, 0);
```

æ•ˆæœå›¾å¦‚ä¸‹æ‰€ç¤º:

![Canvas fillText æ°´å¹³å¯¹é½æ–¹å¼](https://user-images.githubusercontent.com/8088864/125934392-abf31a1e-2b7e-429f-90cc-8cef9fd516d0.png)

#### å‚ç›´æ–¹å‘

``` js
//é»˜è®¤æ˜¯top
//å…³é”®apiï¼šcontext.textBaseline = "top";

context.fillText("default", 50, 200);

context.textBaseline = "top";
context.fillText("top", 150, 200);

context.textBaseline = "middle";
context.fillText("middle", 251, 200);

context.textBaseline = "bottom";
context.fillText("bottom", 400, 200);
```

æ•ˆæœå›¾å¦‚ä¸‹æ‰€ç¤º:

![Canvas fillText å‚ç›´å¯¹é½æ–¹å¼](https://user-images.githubusercontent.com/8088864/125935099-d0a918b3-25e8-4150-bd86-053a5e5cfa98.png)

#### å›¾ç‰‡çš„ç»˜åˆ¶

3å‚æ¨¡å¼ï¼š å°†imgä»x, yçš„åœ°æ–¹å¼€å§‹ç»˜åˆ¶ï¼Œ å›¾ç‰‡æœ‰å¤šå¤§ï¼Œå°±ç»˜åˆ¶å¤šå¤§ï¼Œè¶…å‡ºcanvasçš„éƒ¨åˆ†å°±ä¸æ˜¾ç¤ºäº†

``` js
//context.drawImage(img, x, y)

var image = new Image();
image.src = "./img/gls.jpg";

//å¿…é¡»è¦ç­‰åˆ°å›¾ç‰‡åŠ è½½å‡ºæ¥ï¼Œæ‰èƒ½è¿›è¡Œç»˜åˆ¶çš„æ“ä½œ
image.onload = function () {
  context.drawImage(image, 100, 200);
}
```

5å‚æ¨¡å¼ï¼ˆç¼©æ”¾æ¨¡å¼ï¼‰, å°±æ˜¯å°†å›¾ç‰‡æ˜¾ç¤ºåœ¨ç”»å¸ƒä¸Šçš„æŸä¸€å—åŒºåŸŸï¼ˆx, y, w, hï¼‰,å¦‚æœè¿™ä¸ªåŒºåŸŸçš„å®½é«˜å’Œå›¾ç‰‡ä¸ä¸€è‡³ï¼Œä¼šè¢«å‹ç¼©æˆ–æ”¾å¤§

``` js
var image = new Image();
image.src = "./img/gls.jpg";

image.onload = function () {
  context.drawImage(image, 100, 100, 100, 100);
}
```

å›¾ç‰‡ç»˜åˆ¶çš„9å‚æ¨¡å¼ï¼Œ å°±æ˜¯æŠŠåŸå›¾ï¼ˆimgï¼‰ä¸­çš„æŸä¸€å—ï¼ˆimagexï¼Œimageyï¼Œimagewï¼Œimagehï¼‰æˆªå–å‡ºæ¥ï¼Œ æ˜¾ç¤ºåœ¨ç”»å¸ƒçš„æŸä¸ªåŒºåŸŸ(canvasx, canvasy, canvasw, canvash)

``` js
//ç†è§£å…³é”®ï¼š
//ï¼ˆimagexï¼Œimageyï¼Œimagewï¼Œimagehï¼‰
//(canvasx, canvasy, canvasw, canvash)

var image = new Image();
image.src = "./img/gls.jpg";
image.onload = function () {
  /*
    å‚æ•°çš„è§£é‡Šï¼š
    imageï¼š å°±æ˜¯å¤§å›¾ç‰‡æœ¬èº«
    ä¸­é—´çš„å››ä¸ªå‚æ•°ï¼Œ ä»£è¡¨ä»å›¾ç‰‡çš„150ï¼Œ 0çš„ä½ç½®ï¼Œæˆªå– 150 * 200çš„ä¸€å—åŒºåŸŸ
    åé¢çš„å››ä¸ªå‚æ•°ï¼Œ å°†åˆšæ‰æˆªå–çš„å°å›¾ï¼Œ æ˜¾ç¤ºç”»å¸ƒä¸Š 100ï¼Œ 100ï¼Œ 150ï¼Œ 200çš„è¿™ä¸ªåŒºåŸŸ
  */
  context.drawImage(image, 150, 0, 150, 200, 100, 100, 150, 200);
}
```


## WebWorkerå’ŒpostMessage

### æ¦‚è¿°

JavaScript è¯­è¨€é‡‡ç”¨çš„æ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰€æœ‰ä»»åŠ¡åªèƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šå®Œæˆï¼Œä¸€æ¬¡åªèƒ½åšä¸€ä»¶äº‹ã€‚å‰é¢çš„ä»»åŠ¡æ²¡åšå®Œï¼Œåé¢çš„ä»»åŠ¡åªèƒ½ç­‰ç€ã€‚éšç€ç”µè„‘è®¡ç®—èƒ½åŠ›çš„å¢å¼ºï¼Œå°¤å…¶æ˜¯å¤šæ ¸ CPU çš„å‡ºç°ï¼Œå•çº¿ç¨‹å¸¦æ¥å¾ˆå¤§çš„ä¸ä¾¿ï¼Œæ— æ³•å……åˆ†å‘æŒ¥è®¡ç®—æœºçš„è®¡ç®—èƒ½åŠ›ã€‚

Web Worker çš„ä½œç”¨ï¼Œå°±æ˜¯ä¸º JavaScript åˆ›é€ å¤šçº¿ç¨‹ç¯å¢ƒï¼Œå…è®¸ä¸»çº¿ç¨‹åˆ›å»º Worker çº¿ç¨‹ï¼Œå°†ä¸€äº›ä»»åŠ¡åˆ†é…ç»™åè€…è¿è¡Œã€‚åœ¨ä¸»çº¿ç¨‹è¿è¡Œçš„åŒæ—¶ï¼ŒWorker çº¿ç¨‹åœ¨åå°è¿è¡Œï¼Œä¸¤è€…äº’ä¸å¹²æ‰°ã€‚ç­‰åˆ° Worker çº¿ç¨‹å®Œæˆè®¡ç®—ä»»åŠ¡ï¼Œå†æŠŠç»“æœè¿”å›ç»™ä¸»çº¿ç¨‹ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯ï¼Œä¸€äº›è®¡ç®—å¯†é›†å‹æˆ–é«˜å»¶è¿Ÿçš„ä»»åŠ¡ï¼Œè¢« Worker çº¿ç¨‹è´Ÿæ‹…äº†ï¼Œä¸»çº¿ç¨‹ï¼ˆé€šå¸¸è´Ÿè´£ UI äº¤äº’ï¼‰å°±ä¼šå¾ˆæµç•…ï¼Œä¸ä¼šè¢«é˜»å¡æˆ–æ‹–æ…¢ã€‚

Worker çº¿ç¨‹ä¸€æ—¦æ–°å»ºæˆåŠŸï¼Œå°±ä¼šå§‹ç»ˆè¿è¡Œï¼Œä¸ä¼šè¢«ä¸»çº¿ç¨‹ä¸Šçš„æ´»åŠ¨ï¼ˆæ¯”å¦‚ç”¨æˆ·ç‚¹å‡»æŒ‰é’®ã€æäº¤è¡¨å•ï¼‰æ‰“æ–­ã€‚è¿™æ ·æœ‰åˆ©äºéšæ—¶å“åº”ä¸»çº¿ç¨‹çš„é€šä¿¡ã€‚ä½†æ˜¯ï¼Œè¿™ä¹Ÿé€ æˆäº† Worker æ¯”è¾ƒè€—è´¹èµ„æºï¼Œä¸åº”è¯¥è¿‡åº¦ä½¿ç”¨ï¼Œè€Œä¸”ä¸€æ—¦ä½¿ç”¨å®Œæ¯•ï¼Œå°±åº”è¯¥å…³é—­ã€‚

Web Worker æœ‰ä»¥ä¸‹å‡ ä¸ªä½¿ç”¨æ³¨æ„ç‚¹ã€‚

#### ï¼ˆ1ï¼‰åŒæºé™åˆ¶

åˆ†é…ç»™ Worker çº¿ç¨‹è¿è¡Œçš„è„šæœ¬æ–‡ä»¶ï¼Œå¿…é¡»ä¸ä¸»çº¿ç¨‹çš„è„šæœ¬æ–‡ä»¶åŒæºã€‚

#### ï¼ˆ2ï¼‰DOM é™åˆ¶

Worker çº¿ç¨‹æ‰€åœ¨çš„å…¨å±€å¯¹è±¡ï¼Œä¸ä¸»çº¿ç¨‹ä¸ä¸€æ ·ï¼Œæ— æ³•è¯»å–ä¸»çº¿ç¨‹æ‰€åœ¨ç½‘é¡µçš„ DOM å¯¹è±¡ï¼Œä¹Ÿæ— æ³•ä½¿ç”¨documentã€windowã€parentè¿™äº›å¯¹è±¡ã€‚ä½†æ˜¯ï¼ŒWorker çº¿ç¨‹å¯ä»¥navigatorå¯¹è±¡å’Œlocationå¯¹è±¡ã€‚

#### ï¼ˆ3ï¼‰é€šä¿¡è”ç³»

Worker çº¿ç¨‹å’Œä¸»çº¿ç¨‹ä¸åœ¨åŒä¸€ä¸ªä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œå®ƒä»¬ä¸èƒ½ç›´æ¥é€šä¿¡ï¼Œå¿…é¡»é€šè¿‡æ¶ˆæ¯å®Œæˆã€‚(postMessage)

#### ï¼ˆ4ï¼‰è„šæœ¬é™åˆ¶

Worker çº¿ç¨‹ä¸èƒ½æ‰§è¡Œalert()æ–¹æ³•å’Œconfirm()æ–¹æ³•ï¼Œä½†å¯ä»¥ä½¿ç”¨ XMLHttpRequest å¯¹è±¡å‘å‡º AJAX è¯·æ±‚ã€‚

#### ï¼ˆ5ï¼‰æ–‡ä»¶é™åˆ¶

Worker çº¿ç¨‹æ— æ³•è¯»å–æœ¬åœ°æ–‡ä»¶ï¼Œå³ä¸èƒ½æ‰“å¼€æœ¬æœºçš„æ–‡ä»¶ç³»ç»Ÿï¼ˆfile://ï¼‰ï¼Œå®ƒæ‰€åŠ è½½çš„è„šæœ¬ï¼Œå¿…é¡»æ¥è‡ªç½‘ç»œã€‚

### åŸºæœ¬ç”¨æ³•

#### ä¸»çº¿ç¨‹

ä¸»çº¿ç¨‹é‡‡ç”¨`new`å‘½ä»¤ï¼Œè°ƒç”¨`Worker()`æ„é€ å‡½æ•°ï¼Œæ–°å»ºä¸€ä¸ª `Worker` çº¿ç¨‹ã€‚

``` js
var worker = new Worker('work.js');
```

`Worker()`æ„é€ å‡½æ•°çš„å‚æ•°æ˜¯ä¸€ä¸ªè„šæœ¬æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°±æ˜¯ `Worker` çº¿ç¨‹æ‰€è¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚ç”±äº `Worker` ä¸èƒ½è¯»å–æœ¬åœ°æ–‡ä»¶ï¼Œæ‰€ä»¥è¿™ä¸ªè„šæœ¬å¿…é¡»æ¥è‡ªç½‘ç»œã€‚å¦‚æœä¸‹è½½æ²¡æœ‰æˆåŠŸï¼ˆæ¯”å¦‚404é”™è¯¯ï¼‰ï¼Œ`Worker` å°±ä¼šé»˜é»˜åœ°å¤±è´¥ã€‚

ç„¶åï¼Œä¸»çº¿ç¨‹è°ƒç”¨`worker.postMessage()`æ–¹æ³•ï¼Œå‘ `Worker` å‘æ¶ˆæ¯ã€‚

``` js
worker.postMessage('Hello World');
worker.postMessage({method: 'echo', args: ['Work']});
// worker.postMessage() æ–¹æ³•çš„å‚æ•°ï¼Œå°±æ˜¯ä¸»çº¿ç¨‹ä¼ ç»™ Worker çš„æ•°æ®ã€‚å®ƒå¯ä»¥æ˜¯å„ç§æ•°æ®ç±»å‹ï¼ŒåŒ…æ‹¬äºŒè¿›åˆ¶æ•°æ®ã€‚
```

æ¥ç€ï¼Œä¸»çº¿ç¨‹é€šè¿‡`worker.onmessage`æŒ‡å®šç›‘å¬å‡½æ•°ï¼Œæ¥æ”¶å­çº¿ç¨‹å‘å›æ¥çš„æ¶ˆæ¯ã€‚

``` js
worker.onmessage = function (event) {
  console.log('Received message ' + event.data);
  doSomething();
}

function doSomething() {
  // æ‰§è¡Œä»»åŠ¡
  worker.postMessage('Work done!');
}
```

ä¸Šé¢ä»£ç ä¸­ï¼Œäº‹ä»¶å¯¹è±¡çš„dataå±æ€§å¯ä»¥è·å– `Worker` å‘æ¥çš„æ•°æ®ã€‚

`Worker` å®Œæˆä»»åŠ¡ä»¥åï¼Œä¸»çº¿ç¨‹å°±å¯ä»¥æŠŠå®ƒå…³æ‰ã€‚

``` js
worker.terminate();
```

#### Worker çº¿ç¨‹

`Worker` çº¿ç¨‹å†…éƒ¨éœ€è¦æœ‰ä¸€ä¸ªç›‘å¬å‡½æ•°ï¼Œç›‘å¬`message`äº‹ä»¶ã€‚

``` js
self.addEventListener('message', function (e) {
  self.postMessage('You said: ' + e.data);
}, false);
```

ä¸Šé¢ä»£ç ä¸­ï¼Œ`self`ä»£è¡¨å­çº¿ç¨‹è‡ªèº«ï¼Œå³å­çº¿ç¨‹çš„å…¨å±€å¯¹è±¡ã€‚å› æ­¤ï¼Œç­‰åŒäºä¸‹é¢ä¸¤ç§å†™æ³•ã€‚

```js
// å†™æ³•ä¸€
this.addEventListener('message', function (e) {
  this.postMessage('You said: ' + e.data);
}, false);

// å†™æ³•äºŒ
addEventListener('message', function (e) {
  postMessage('You said: ' + e.data);
}, false);
```

é™¤äº†ä½¿ç”¨`self.addEventListener()`æŒ‡å®šç›‘å¬å‡½æ•°ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨`self.onmessage`æŒ‡å®šã€‚ç›‘å¬å‡½æ•°çš„å‚æ•°æ˜¯ä¸€ä¸ªäº‹ä»¶å¯¹è±¡ï¼Œå®ƒçš„dataå±æ€§åŒ…å«ä¸»çº¿ç¨‹å‘æ¥çš„æ•°æ®ã€‚`self.postMessage()`æ–¹æ³•ç”¨æ¥å‘ä¸»çº¿ç¨‹å‘é€æ¶ˆæ¯ã€‚

æ ¹æ®ä¸»çº¿ç¨‹å‘æ¥çš„æ•°æ®ï¼Œ`Worker` çº¿ç¨‹å¯ä»¥è°ƒç”¨ä¸åŒçš„æ–¹æ³•ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚

``` js
self.addEventListener('message', function (e) {
  var data = e.data;
  switch (data.cmd) {
    case 'start':
      self.postMessage('WORKER STARTED: ' + data.msg);
      break;
    case 'stop':
      self.postMessage('WORKER STOPPED: ' + data.msg);
      self.close(); // Terminates the worker.
      break;
    default:
      self.postMessage('Unknown command: ' + data.msg);
  };
}, false);
```

ä¸Šé¢ä»£ç ä¸­ï¼Œ`self.close()`ç”¨äºåœ¨ Worker å†…éƒ¨å…³é—­è‡ªèº«ã€‚

#### Worker åŠ è½½è„šæœ¬

Worker å†…éƒ¨å¦‚æœè¦åŠ è½½å…¶ä»–è„šæœ¬ï¼Œæœ‰ä¸€ä¸ªä¸“é—¨çš„æ–¹æ³•`importScripts()`ã€‚

``` js
importScripts('script1.js');
```

è¯¥æ–¹æ³•å¯ä»¥åŒæ—¶åŠ è½½å¤šä¸ªè„šæœ¬ã€‚

``` js
importScripts('script1.js', 'script2.js');
```

#### Worker é”™è¯¯å¤„ç†

ä¸»çº¿ç¨‹å¯ä»¥ç›‘å¬ `Worker` æ˜¯å¦å‘ç”Ÿé”™è¯¯ã€‚å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œ`Worker` ä¼šè§¦å‘ä¸»çº¿ç¨‹çš„erroräº‹ä»¶ã€‚

``` js
worker.onerror(function (event) {
  console.log([
    'ERROR: Line ', e.lineno, ' in ', e.filename, ': ', e.message
  ].join(''));
});

// æˆ–è€…
worker.addEventListener('error', function (event) {
  // ...
});
```

`Worker` å†…éƒ¨ä¹Ÿå¯ä»¥ç›‘å¬erroräº‹ä»¶ã€‚

#### å…³é—­ Worker

ä½¿ç”¨å®Œæ¯•ï¼Œä¸ºäº†èŠ‚çœç³»ç»Ÿèµ„æºï¼Œå¿…é¡»å…³é—­ Workerã€‚

``` js
// ä¸»çº¿ç¨‹
worker.terminate();

// Worker çº¿ç¨‹
self.close();
```

### æ•°æ®é€šä¿¡

å‰é¢è¯´è¿‡ï¼Œä¸»çº¿ç¨‹ä¸ Worker ä¹‹é—´çš„é€šä¿¡å†…å®¹ï¼Œå¯ä»¥æ˜¯æ–‡æœ¬ï¼Œä¹Ÿå¯ä»¥æ˜¯å¯¹è±¡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§é€šä¿¡æ˜¯æ‹·è´å…³ç³»ï¼Œå³æ˜¯ä¼ å€¼è€Œä¸æ˜¯ä¼ å€ï¼ŒWorker å¯¹é€šä¿¡å†…å®¹çš„ä¿®æ”¹ï¼Œä¸ä¼šå½±å“åˆ°ä¸»çº¿ç¨‹ã€‚äº‹å®ä¸Šï¼Œæµè§ˆå™¨å†…éƒ¨çš„è¿è¡Œæœºåˆ¶æ˜¯ï¼Œå…ˆå°†é€šä¿¡å†…å®¹ä¸²è¡ŒåŒ–ï¼Œç„¶åæŠŠä¸²è¡ŒåŒ–åçš„å­—ç¬¦ä¸²å‘ç»™ Workerï¼Œåè€…å†å°†å®ƒè¿˜åŸã€‚

ä¸»çº¿ç¨‹ä¸ Worker ä¹‹é—´ä¹Ÿå¯ä»¥äº¤æ¢äºŒè¿›åˆ¶æ•°æ®ï¼Œæ¯”å¦‚ Fileã€Blobã€ArrayBuffer ç­‰ç±»å‹ï¼Œä¹Ÿå¯ä»¥åœ¨çº¿ç¨‹ä¹‹é—´å‘é€ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚

``` js
// ä¸»çº¿ç¨‹
var uInt8Array = new Uint8Array(new ArrayBuffer(10));
for (var i = 0; i < uInt8Array.length; ++i) {
  uInt8Array[i] = i * 2; // [0, 2, 4, 6, 8,...]
}
worker.postMessage(uInt8Array);

// Worker çº¿ç¨‹
self.onmessage = function (e) {
  var uInt8Array = e.data;
  postMessage('Inside worker.js: uInt8Array.toString() = ' + uInt8Array.toString());
  postMessage('Inside worker.js: uInt8Array.byteLength = ' + uInt8Array.byteLength);
};
```

ä½†æ˜¯ï¼Œæ‹·è´æ–¹å¼å‘é€äºŒè¿›åˆ¶æ•°æ®ï¼Œä¼šé€ æˆæ€§èƒ½é—®é¢˜ã€‚æ¯”å¦‚ï¼Œä¸»çº¿ç¨‹å‘ Worker å‘é€ä¸€ä¸ª 500MB æ–‡ä»¶ï¼Œé»˜è®¤æƒ…å†µä¸‹æµè§ˆå™¨ä¼šç”Ÿæˆä¸€ä¸ªåŸæ–‡ä»¶çš„æ‹·è´ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒJavaScript å…è®¸ä¸»çº¿ç¨‹æŠŠäºŒè¿›åˆ¶æ•°æ®ç›´æ¥è½¬ç§»ç»™å­çº¿ç¨‹ï¼Œä½†æ˜¯ä¸€æ—¦è½¬ç§»ï¼Œä¸»çº¿ç¨‹å°±æ— æ³•å†ä½¿ç”¨è¿™äº›äºŒè¿›åˆ¶æ•°æ®äº†ï¼Œè¿™æ˜¯ä¸ºäº†é˜²æ­¢å‡ºç°å¤šä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹æ•°æ®çš„éº»çƒ¦å±€é¢ã€‚è¿™ç§è½¬ç§»æ•°æ®çš„æ–¹æ³•ï¼Œå«åšTransferable Objectsã€‚è¿™ä½¿å¾—ä¸»çº¿ç¨‹å¯ä»¥å¿«é€ŸæŠŠæ•°æ®äº¤ç»™ Workerï¼Œå¯¹äºå½±åƒå¤„ç†ã€å£°éŸ³å¤„ç†ã€3D è¿ç®—ç­‰å°±éå¸¸æ–¹ä¾¿äº†ï¼Œä¸ä¼šäº§ç”Ÿæ€§èƒ½è´Ÿæ‹…ã€‚

å¦‚æœè¦ç›´æ¥è½¬ç§»æ•°æ®çš„æ§åˆ¶æƒï¼Œå°±è¦ä½¿ç”¨ä¸‹é¢çš„å†™æ³•ã€‚

``` js
// Transferable Objects æ ¼å¼
worker.postMessage(arrayBuffer, [arrayBuffer]);

// ä¾‹å­
var ab = new ArrayBuffer(1);
worker.postMessage(ab, [ab]);
```

### åŒé¡µé¢çš„ Web Worker

é€šå¸¸æƒ…å†µä¸‹ï¼ŒWorker è½½å…¥çš„æ˜¯ä¸€ä¸ªå•ç‹¬çš„ JavaScript è„šæœ¬æ–‡ä»¶ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥è½½å…¥ä¸ä¸»çº¿ç¨‹åœ¨åŒä¸€ä¸ªç½‘é¡µçš„ä»£ç ã€‚

``` html
<!DOCTYPE html>
  <body>
    <script id="worker" type="app/worker">
      addEventListener('message', function () {
        postMessage('some message');
      }, false);
    </script>
  </body>
</html>
```

ä¸Šé¢æ˜¯ä¸€æ®µåµŒå…¥ç½‘é¡µçš„è„šæœ¬ï¼Œæ³¨æ„å¿…é¡»æŒ‡å®š`<script>`æ ‡ç­¾çš„typeå±æ€§æ˜¯ä¸€ä¸ªæµè§ˆå™¨ä¸è®¤è¯†çš„å€¼ï¼Œä¸Šä¾‹æ˜¯`app/worker`ã€‚

ç„¶åï¼Œè¯»å–è¿™ä¸€æ®µåµŒå…¥é¡µé¢çš„è„šæœ¬ï¼Œç”¨ Worker æ¥å¤„ç†ã€‚

``` js
var blob = new Blob([document.querySelector('#worker').textContent]);
var url = window.URL.createObjectURL(blob);
var worker = new Worker(url);

worker.onmessage = function (e) {
  // e.data === 'some message'
};
```

ä¸Šé¢ä»£ç ä¸­ï¼Œå…ˆå°†åµŒå…¥ç½‘é¡µçš„è„šæœ¬ä»£ç ï¼Œè½¬æˆä¸€ä¸ªäºŒè¿›åˆ¶å¯¹è±¡ï¼Œç„¶åä¸ºè¿™ä¸ªäºŒè¿›åˆ¶å¯¹è±¡ç”Ÿæˆ URLï¼Œå†è®© Worker åŠ è½½è¿™ä¸ª URLã€‚è¿™æ ·å°±åšåˆ°äº†ï¼Œä¸»çº¿ç¨‹å’Œ Worker çš„ä»£ç éƒ½åœ¨åŒä¸€ä¸ªç½‘é¡µä¸Šé¢ã€‚

### Worker çº¿ç¨‹å®Œæˆè½®è¯¢

æœ‰æ—¶ï¼Œæµè§ˆå™¨éœ€è¦è½®è¯¢æœåŠ¡å™¨çŠ¶æ€ï¼Œä»¥ä¾¿ç¬¬ä¸€æ—¶é—´å¾—çŸ¥çŠ¶æ€æ”¹å˜ã€‚è¿™ä¸ªå·¥ä½œå¯ä»¥æ”¾åœ¨ Worker é‡Œé¢ã€‚

``` js
function createWorker(f) {
  var blob = new Blob(['(' + f.toString() +')()']);
  var url = window.URL.createObjectURL(blob);
  var worker = new Worker(url);
  return worker;
}

var pollingWorker = createWorker(function (e) {
  var cache;

  function compare(new, old) { ... };

  setInterval(function () {
    fetch('/my-api-endpoint').then(function (res) {
      var data = res.json();

      if (!compare(data, cache)) {
        cache = data;
        self.postMessage(data);
      }
    })
  }, 1000)
});

pollingWorker.onmessage = function () {
  // render data
}

pollingWorker.postMessage('init');
```

ä¸Šé¢ä»£ç ä¸­ï¼ŒWorker æ¯ç§’é’Ÿè½®è¯¢ä¸€æ¬¡æ•°æ®ï¼Œç„¶åè·Ÿç¼“å­˜åšæ¯”è¾ƒã€‚å¦‚æœä¸ä¸€è‡´ï¼Œå°±è¯´æ˜æœåŠ¡ç«¯æœ‰äº†æ–°çš„å˜åŒ–ï¼Œå› æ­¤å°±è¦é€šçŸ¥ä¸»çº¿ç¨‹ã€‚

### Worker æ–°å»º Worker

Worker çº¿ç¨‹å†…éƒ¨è¿˜èƒ½å†æ–°å»º Worker çº¿ç¨‹ï¼ˆç›®å‰åªæœ‰ Firefox æµè§ˆå™¨æ”¯æŒï¼‰ã€‚ä¸‹é¢çš„ä¾‹å­æ˜¯å°†ä¸€ä¸ªè®¡ç®—å¯†é›†çš„ä»»åŠ¡ï¼Œåˆ†é…åˆ°10ä¸ª Workerã€‚

ä¸»çº¿ç¨‹ä»£ç å¦‚ä¸‹ã€‚

``` js
var worker = new Worker('worker.js');
worker.onmessage = function (event) {
  document.getElementById('result').textContent = event.data;
};
```

Worker çº¿ç¨‹ä»£ç å¦‚ä¸‹ã€‚

``` js
// worker.js

// settings
var num_workers = 10;
var items_per_worker = 1000000;

// start the workers
var result = 0;
var pending_workers = num_workers;
for (var i = 0; i < num_workers; i += 1) {
  var worker = new Worker('core.js');
  worker.postMessage(i * items_per_worker);
  worker.postMessage((i + 1) * items_per_worker);
  worker.onmessage = storeResult;
}

// handle the results
function storeResult(event) {
  result += event.data;
  pending_workers -= 1;
  if (pending_workers <= 0)
    postMessage(result); // finished!
}
```

ä¸Šé¢ä»£ç ä¸­ï¼ŒWorker çº¿ç¨‹å†…éƒ¨æ–°å»ºäº†10ä¸ª Worker çº¿ç¨‹ï¼Œå¹¶ä¸”ä¾æ¬¡å‘è¿™10ä¸ª Worker å‘é€æ¶ˆæ¯ï¼Œå‘ŠçŸ¥äº†è®¡ç®—çš„èµ·ç‚¹å’Œç»ˆç‚¹ã€‚è®¡ç®—ä»»åŠ¡è„šæœ¬çš„ä»£ç å¦‚ä¸‹ã€‚

``` js
// core.js
var start;
onmessage = getStart;
function getStart(event) {
  start = event.data;
  onmessage = getEnd;
}

var end;
function getEnd(event) {
  end = event.data;
  onmessage = null;
  work();
}

function work() {
  var result = 0;
  for (var i = start; i < end; i += 1) {
    // perform some complex calculation here
    result += 1;
  }
  postMessage(result);
  close();
}
```

### API

#### ä¸»çº¿ç¨‹

æµè§ˆå™¨åŸç”Ÿæä¾›Worker()æ„é€ å‡½æ•°ï¼Œç”¨æ¥ä¾›ä¸»çº¿ç¨‹ç”Ÿæˆ Worker çº¿ç¨‹ã€‚

``` js
var myWorker = new Worker(jsUrl, options);
```

Worker()æ„é€ å‡½æ•°ï¼Œå¯ä»¥æ¥å—ä¸¤ä¸ªå‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è„šæœ¬çš„ç½‘å€ï¼ˆå¿…é¡»éµå®ˆåŒæºæ”¿ç­–ï¼‰ï¼Œè¯¥å‚æ•°æ˜¯å¿…éœ€çš„ï¼Œä¸”åªèƒ½åŠ è½½ JS è„šæœ¬ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚ç¬¬äºŒä¸ªå‚æ•°æ˜¯é…ç½®å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯é€‰ã€‚å®ƒçš„ä¸€ä¸ªä½œç”¨å°±æ˜¯æŒ‡å®š Worker çš„åç§°ï¼Œç”¨æ¥åŒºåˆ†å¤šä¸ª Worker çº¿ç¨‹ã€‚

``` js
// ä¸»çº¿ç¨‹
var myWorker = new Worker('worker.js', { name : 'myWorker' });

// Worker çº¿ç¨‹
self.name // myWorker
```

Worker()æ„é€ å‡½æ•°è¿”å›ä¸€ä¸ª Worker çº¿ç¨‹å¯¹è±¡ï¼Œç”¨æ¥ä¾›ä¸»çº¿ç¨‹æ“ä½œ Workerã€‚Worker çº¿ç¨‹å¯¹è±¡çš„å±æ€§å’Œæ–¹æ³•å¦‚ä¸‹ã€‚

- Worker.onerrorï¼šæŒ‡å®š error äº‹ä»¶çš„ç›‘å¬å‡½æ•°ã€‚
- Worker.onmessageï¼šæŒ‡å®š message äº‹ä»¶çš„ç›‘å¬å‡½æ•°ï¼Œå‘é€è¿‡æ¥çš„æ•°æ®åœ¨Event.dataå±æ€§ä¸­ã€‚
- Worker.onmessageerrorï¼šæŒ‡å®š messageerror äº‹ä»¶çš„ç›‘å¬å‡½æ•°ã€‚å‘é€çš„æ•°æ®æ— æ³•åºåˆ—åŒ–æˆå­—ç¬¦ä¸²æ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªäº‹ä»¶ã€‚
- Worker.postMessage()ï¼šå‘ Worker çº¿ç¨‹å‘é€æ¶ˆæ¯ã€‚
- Worker.terminate()ï¼šç«‹å³ç»ˆæ­¢ Worker çº¿ç¨‹ã€‚

#### Worker çº¿ç¨‹

Web Worker æœ‰è‡ªå·±çš„å…¨å±€å¯¹è±¡ï¼Œä¸æ˜¯ä¸»çº¿ç¨‹çš„windowï¼Œè€Œæ˜¯ä¸€ä¸ªä¸“é—¨ä¸º Worker å®šåˆ¶çš„å…¨å±€å¯¹è±¡ã€‚å› æ­¤å®šä¹‰åœ¨windowä¸Šé¢çš„å¯¹è±¡å’Œæ–¹æ³•ä¸æ˜¯å…¨éƒ¨éƒ½å¯ä»¥ä½¿ç”¨ã€‚

Worker çº¿ç¨‹æœ‰ä¸€äº›è‡ªå·±çš„å…¨å±€å±æ€§å’Œæ–¹æ³•ã€‚

- self.nameï¼š Worker çš„åå­—ã€‚è¯¥å±æ€§åªè¯»ï¼Œç”±æ„é€ å‡½æ•°æŒ‡å®šã€‚
- self.onmessageï¼šæŒ‡å®šmessageäº‹ä»¶çš„ç›‘å¬å‡½æ•°ã€‚
- self.onmessageerrorï¼šæŒ‡å®š messageerror äº‹ä»¶çš„ç›‘å¬å‡½æ•°ã€‚å‘é€çš„æ•°æ®æ— æ³•åºåˆ—åŒ–æˆå­—ç¬¦ä¸²æ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªäº‹ä»¶ã€‚
- self.close()ï¼šå…³é—­ Worker çº¿ç¨‹ã€‚
- self.postMessage()ï¼šå‘äº§ç”Ÿè¿™ä¸ª Worker çº¿ç¨‹å‘é€æ¶ˆæ¯ã€‚
- self.importScripts()ï¼šåŠ è½½ JS è„šæœ¬ã€‚


## å››ã€Service Worker

> Service workers æœ¬è´¨ä¸Šå……å½“Webåº”ç”¨ç¨‹åºä¸æµè§ˆå™¨ä¹‹é—´çš„ä»£ç†æœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥åœ¨ç½‘ç»œå¯ç”¨æ—¶ä½œä¸ºæµè§ˆå™¨å’Œç½‘ç»œé—´çš„ä»£ç†ã€‚å®ƒä»¬æ—¨åœ¨ï¼ˆé™¤å…¶ä»–ä¹‹å¤–ï¼‰ä½¿å¾—èƒ½å¤Ÿåˆ›å»ºæœ‰æ•ˆçš„ç¦»çº¿ä½“éªŒï¼Œæ‹¦æˆªç½‘ç»œè¯·æ±‚å¹¶åŸºäºç½‘ç»œæ˜¯å¦å¯ç”¨ä»¥åŠæ›´æ–°çš„èµ„æºæ˜¯å¦é©»ç•™åœ¨æœåŠ¡å™¨ä¸Šæ¥é‡‡å–é€‚å½“çš„åŠ¨ä½œã€‚ä»–ä»¬è¿˜å…è®¸è®¿é—®æ¨é€é€šçŸ¥å’Œåå°åŒæ­¥API

**ç›®å‰è¯¥æŠ€æœ¯é€šå¸¸ç”¨æ¥åšç¼“å­˜æ–‡ä»¶ï¼Œæé«˜é¦–å±é€Ÿåº¦**

```javascript
// index.js
if (navigator.serviceWorker) {
  navigator.serviceWorker
    .register("sw.js")
    .then(function(registration) {
      console.log("service worker æ³¨å†ŒæˆåŠŸ");
    })
    .catch(function(err) {
      console.log("servcie worker æ³¨å†Œå¤±è´¥");
    });
}
// sw.js
// ç›‘å¬ `install` äº‹ä»¶ï¼Œå›è°ƒä¸­ç¼“å­˜æ‰€éœ€æ–‡ä»¶
self.addEventListener("install", e => {
  e.waitUntil(
    caches.open("my-cache").then(function(cache) {
      return cache.addAll(["./index.html", "./index.js"]);
    })
  );
});

// æ‹¦æˆªæ‰€æœ‰è¯·æ±‚äº‹ä»¶
// å¦‚æœç¼“å­˜ä¸­å·²ç»æœ‰è¯·æ±‚çš„æ•°æ®å°±ç›´æ¥ç”¨ç¼“å­˜ï¼Œå¦åˆ™å»è¯·æ±‚æ•°æ®
self.addEventListener("fetch", e => {
  e.respondWith(
    caches.match(e.request).then(function(response) {
      if (response) {
        return response;
      }
      console.log("fetch source");
    })
  );
});
```

> æ‰“å¼€é¡µé¢ï¼Œå¯ä»¥åœ¨å¼€å‘è€…å·¥å…·ä¸­çš„ Application çœ‹åˆ° Service Worker å·²ç»å¯åŠ¨äº†

![](https://user-gold-cdn.xitu.io/2018/3/28/1626b1e8eba68e1c?w=1770&h=722&f=png&s=192277)


> åœ¨ Cache ä¸­ä¹Ÿå¯ä»¥å‘ç°æˆ‘ä»¬æ‰€éœ€çš„æ–‡ä»¶å·²è¢«ç¼“å­˜

![](https://user-gold-cdn.xitu.io/2018/3/28/1626b20dfc4fcd26?w=1118&h=728&f=png&s=85610)

å½“æˆ‘ä»¬é‡æ–°åˆ·æ–°é¡µé¢å¯ä»¥å‘ç°æˆ‘ä»¬ç¼“å­˜çš„æ•°æ®æ˜¯ä» Service Worker ä¸­è¯»å–çš„


## OffscreenCanvas ç¦»å±Canvas â€” ä½¿ç”¨Web Workeræé«˜ä½ çš„Canvasè¿è¡Œé€Ÿåº¦

OffscreenCanvasæä¾›äº†ä¸€ä¸ªå¯ä»¥è„±ç¦»å±å¹•æ¸²æŸ“çš„canvaså¯¹è±¡ã€‚

æœ‰äº†ç¦»å±Canvasï¼Œä½ å¯ä»¥ä¸ç”¨åœ¨ä½ çš„ä¸»çº¿ç¨‹ä¸­ç»˜åˆ¶å›¾åƒäº†ï¼

Canvas æ˜¯ä¸€ä¸ªéå¸¸å—æ¬¢è¿çš„è¡¨ç°æ–¹å¼ï¼ŒåŒæ—¶ä¹Ÿæ˜¯WebGLçš„å…¥å£ã€‚å®ƒèƒ½ç»˜åˆ¶å›¾å½¢ï¼Œå›¾ç‰‡ï¼Œå±•ç¤ºåŠ¨ç”»ï¼Œç”šè‡³æ˜¯å¤„ç†è§†é¢‘å†…å®¹ã€‚å®ƒç»å¸¸è¢«ç”¨æ¥åœ¨å¯Œåª’ä½“webåº”ç”¨ä¸­åˆ›å»ºç‚«é…·çš„ç”¨æˆ·ç•Œé¢æˆ–è€…æ˜¯åˆ¶ä½œåœ¨çº¿ï¼ˆwebï¼‰æ¸¸æˆã€‚

å®ƒæ˜¯éå¸¸çµæ´»çš„ï¼Œè¿™æ„å‘³ç€ç»˜åˆ¶åœ¨Canvasçš„å†…å®¹å¯ä»¥è¢«ç¼–ç¨‹ã€‚JavaScriptå°±æä¾›äº†Canvasçš„ç³»åˆ—APIã€‚è¿™äº›ç»™äº†Canvaséå¸¸å¥½çš„çµæ´»åº¦ã€‚

ä½†åŒæ—¶ï¼Œåœ¨ä¸€äº›ç°ä»£åŒ–çš„webç«™ç‚¹ï¼Œè„šæœ¬è§£æè¿è¡Œæ˜¯å®ç°æµç•…ç”¨æˆ·åé¦ˆçš„æœ€å¤§çš„é—®é¢˜ä¹‹ä¸€ã€‚å› ä¸ºCanvasè®¡ç®—å’Œæ¸²æŸ“å’Œç”¨æˆ·æ“ä½œå“åº”éƒ½å‘ç”Ÿåœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œåœ¨åŠ¨ç”»ä¸­ï¼ˆæœ‰æ—¶å€™å¾ˆè€—æ—¶ï¼‰çš„è®¡ç®—æ“ä½œå°†ä¼šå¯¼è‡´Appå¡é¡¿ï¼Œé™ä½ç”¨æˆ·ä½“éªŒã€‚

å¹¸è¿çš„æ˜¯, [OffscreenCanvas](https://developer.mozilla.org/zh-CN/docs/Web/API/OffscreenCanvas) ç¦»å±Canvaså¯ä»¥éå¸¸æ£’çš„è§£å†³è¿™ä¸ªéº»çƒ¦ï¼

åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒCanvasçš„ç»˜åˆ¶åŠŸèƒ½éƒ½ä¸`<canvas>`æ ‡ç­¾ç»‘å®šåœ¨ä¸€èµ·ï¼Œè¿™æ„å‘³ç€Canvas APIå’ŒDOMæ˜¯è€¦åˆçš„ã€‚è€ŒOffscreenCanvasï¼Œæ­£å¦‚å®ƒçš„åå­—ä¸€æ ·ï¼Œé€šè¿‡å°†Canvasç§»å‡ºå±å¹•æ¥è§£è€¦äº†DOMå’ŒCanvas APIã€‚

ç”±äºè¿™ç§è§£è€¦ï¼ŒOffscreenCanvasçš„æ¸²æŸ“ä¸DOMå®Œå…¨åˆ†ç¦»äº†å¼€æ¥ï¼Œå¹¶ä¸”æ¯”æ™®é€šCanvasé€Ÿåº¦æå‡äº†ä¸€äº›ï¼Œè€Œè¿™åªæ˜¯å› ä¸ºä¸¤è€…ï¼ˆCanvaså’ŒDOMï¼‰ä¹‹é—´æ²¡æœ‰åŒæ­¥ã€‚ä½†æ›´é‡è¦çš„æ˜¯ï¼Œå°†ä¸¤è€…åˆ†ç¦»åï¼ŒCanvaså°†å¯ä»¥åœ¨Web Workerä¸­ä½¿ç”¨ï¼Œå³ä½¿åœ¨Web Workerä¸­æ²¡æœ‰DOMã€‚è¿™ç»™Canvasæä¾›äº†æ›´å¤šçš„å¯èƒ½æ€§ã€‚

### å…¼å®¹æ€§

è¿™æ˜¯ä¸€ä¸ªå®éªŒä¸­çš„åŠŸèƒ½
æ­¤åŠŸèƒ½æŸäº›æµè§ˆå™¨å°šåœ¨å¼€å‘ä¸­ï¼Œè¯·å‚è€ƒæµè§ˆå™¨å…¼å®¹æ€§è¡¨æ ¼ä»¥å¾—åˆ°åœ¨ä¸åŒæµè§ˆå™¨ä¸­é€‚åˆä½¿ç”¨çš„å‰ç¼€ã€‚ç”±äºè¯¥åŠŸèƒ½å¯¹åº”çš„æ ‡å‡†æ–‡æ¡£å¯èƒ½è¢«é‡æ–°ä¿®è®¢ï¼Œæ‰€ä»¥åœ¨æœªæ¥ç‰ˆæœ¬çš„æµè§ˆå™¨ä¸­è¯¥åŠŸèƒ½çš„è¯­æ³•å’Œè¡Œä¸ºå¯èƒ½éšä¹‹æ”¹å˜ã€‚

æ”¯æŒæµè§ˆå™¨å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![OffscreenCanvaså…¼å®¹æ€§](https://user-images.githubusercontent.com/8088864/126027990-d476b78e-e6c9-4438-998d-7ccc4ae79f8b.png)

### åœ¨Workerä¸­ä½¿ç”¨OffscreenCanvas

å®ƒåœ¨çª—å£ç¯å¢ƒå’Œweb workerç¯å¢ƒå‡æœ‰æ•ˆã€‚

[Workers](https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API) æ˜¯ä¸€ä¸ªWebç‰ˆçš„çº¿ç¨‹â€”â€”å®ƒå…è®¸ä½ åœ¨å¹•åè¿è¡Œä½ çš„ä»£ç ã€‚å°†ä½ çš„ä¸€éƒ¨åˆ†ä»£ç æ”¾åˆ°Workerä¸­å¯ä»¥ç»™ä½ çš„ä¸»çº¿ç¨‹æ›´å¤šçš„ç©ºé—²æ—¶é—´ï¼Œè¿™å¯ä»¥æé«˜ä½ çš„ç”¨æˆ·ä½“éªŒåº¦ã€‚å°±åƒå…¶æ²¡æœ‰DOMä¸€æ ·ï¼Œç›´åˆ°ç°åœ¨ï¼Œåœ¨Workerä¸­éƒ½æ²¡æœ‰Canvas APIã€‚

è€ŒOffscreenCanvaså¹¶ä¸ä¾èµ–DOMï¼Œæ‰€ä»¥åœ¨Workerä¸­Canvas APIå¯ä»¥è¢«æŸç§æ–¹æ³•æ¥ä»£æ›¿ã€‚ä¸‹é¢æ˜¯æˆ‘åœ¨Workerä¸­ç”¨OffscreenCanvasæ¥è®¡ç®—æ¸å˜é¢œè‰²çš„ï¼š

``` js
// file: worker.js

function getGradientColor(percent) {
    const canvas = new OffscreenCanvas(100, 1);
    const ctx = canvas.getContext('2d');
    const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
    gradient.addColorStop(0, 'red');
    gradient.addColorStop(1, 'blue');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, ctx.canvas.width, 1);
    const imgd = ctx.getImageData(0, 0, ctx.canvas.width, 1);
    const colors = imgd.data.slice(percent * 4, percent * 4 + 4);
    return `rgba(${colors[0]}, ${colors[1]}, ${colors[2]}, ${colors[3]})`;
}

getGradientColor(40);  // rgba(152, 0, 104, 255)
```

### ä¸è¦é˜»å¡ä¸»çº¿ç¨‹

å½“æˆ‘ä»¬å°†å¤§é‡çš„è®¡ç®—ç§»åˆ°Workerä¸­è¿è¡Œæ—¶ï¼Œå¯ä»¥é‡Šæ”¾ä¸»çº¿ç¨‹ä¸Šçš„èµ„æºï¼Œè¿™å¾ˆæœ‰æ„æ€ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨transferControlToOffscreen æ–¹æ³•å°†å¸¸è§„çš„Canvasæ˜ å°„åˆ°OffscreenCanvaså®ä¾‹ä¸Šã€‚ä¹‹åæ‰€æœ‰åº”ç”¨äºOffscreenCanvasçš„æ“ä½œå°†è‡ªåŠ¨å‘ˆç°åœ¨åœ¨æºCanvasä¸Šã€‚

``` html
<!DOCTYPE html>
<html>
<body>
<canvas id="myCanvas" width="600" height="500" style="border:1px solid #d3d3d3;">
  Your browser does not support the HTML5 canvas tag.
</canvas>
<script>
var canvas = document.getElementById("myCanvas");
// var context = canvas.getContext("2d");

// // ç”»çº¿
// context.moveTo(100, 100);
// context.lineTo(300, 100);
// context.lineTo(300, 200);

// // ç”»ç¬¬äºŒæ¡çº¿
// // ç”»ç¬¬äºŒæ¡çº¿
// context.moveTo(100, 300);
// context.lineTo(300, 300);

// // æœ€åè¦æè¾¹æ‰ä¼šå‡ºæ•ˆæœ
// context.stroke();

// // åˆ›å»ºä¸€å¼ æ–°çš„ç»ç’ƒçº¸
// context.beginPath();
// // ç”»ç¬¬ä¸‰æ¡çº¿
// context.moveTo(400, 100);
// context.lineTo(400, 300);
// context.lineTo(500, 300);
// context.lineTo(500, 200);

// // åªè¦æ‰§è¡Œstrokeï¼Œéƒ½ä¼šç»ç’ƒçº¸ä¸Šçš„å›¾å½¢é‡å¤å°åˆ·ä¸€æ¬¡
// context.stroke();

// // å¡«å……
// context.fill();
// context.fillStyle = "gray";

// // è®¾ç½®æè¾¹è‰²
// context.strokeStyle = "red"; // é¢œè‰²çš„å†™æ³•å’Œcsså†™æ³•æ˜¯ä¸€æ ·çš„
// context.stroke();

// //å¡«å……
// //è®¾ç½®å¡«å……è‰²
// context.fillStyle = "yellowgreen";
// context.fill();

// //æŠŠè·¯å¾„é—­åˆ
// context.closePath();

// //è®¾ç½®çº¿æ¡çš„ç²—ç»†ï¼Œ ä¸éœ€è¦åŠ px
// context.lineWidth = 15;
// //çº¿æ¡çš„å¤´éƒ¨çš„è®¾ç½®
// context.lineCap = "round"; //é»˜è®¤æ˜¯buttï¼Œ è®°ä½round

// æ³¨: å¦‚æœå°†canvasè½¬åŒ–æˆç¦»å±canvasæ—¶ï¼Œå°±ä¸èƒ½ä½¿ç”¨åŸcanvasçš„cantextæ¥ç»˜åˆ¶å›¾æ¡ˆï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼Œå·²ç»ç»˜åˆ¶äº†çš„canvasä¸åŒé€šè¿‡transferControlToOffscreenè½¬æ¢æˆOffscreenCanvas
// Uncaught DOMException: Failed to execute 'transferControlToOffscreen' on 'HTMLCanvasElement': Cannot transfer control from a canvas that has a rendering context.
const offscreen = canvas.transferControlToOffscreen();
const worker = new Worker('worker.js');
worker.postMessage({ canvas: offscreen }, [offscreen]);
</script>
</body>
</html>
```

OffscreenCanvas æ˜¯å¯è½¬ç§»çš„ï¼Œé™¤äº†å°†å…¶æŒ‡å®šä¸ºä¼ é€’ä¿¡æ¯ä¸­çš„å­—æ®µä¹‹ä¸€ä»¥å¤–ï¼Œè¿˜éœ€è¦å°†å…¶ä½œä¸ºpostMessageï¼ˆä¼ é€’ä¿¡æ¯ç»™Workerçš„æ–¹æ³•ï¼‰ä¸­çš„ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’å‡ºå»ï¼Œä»¥ä¾¿å¯ä»¥åœ¨Workerçº¿ç¨‹çš„contextï¼ˆä¸Šä¸‹æ–‡ï¼‰ä¸­ä½¿ç”¨å®ƒã€‚

``` js
// worker.js

self.onmessage = function (event) {
  // è·å–ä¼ é€è¿‡æ¥çš„ç¦»å±Canvas(OffscreenCanvas)
  var canvas = event.data.canvas;
  var context = canvas.getContext('2d');

  // ç”»ä¸€ä¸ªæ›²å¾„çƒä½“
  var c1 = {x: 240, y: 160, r: 0};
  var c2 = {x: 300, y: 200, r: 120};

  var gradient = context.createRadialGradient(c1.x, c1.y, c1.r, c2.x, c2.y, c2.r);
  gradient.addColorStop(1, "gray");
  gradient.addColorStop(0, "lightgray");

  //2. å°†æ¸å˜å¯¹è±¡è®¾ä¸ºå¡«å……è‰²
  context.fillStyle = gradient;

  //3. ç”»åœ†å¹¶å¡«å……
  context.arc(c2.x, c2.y, c2.r, 0, 2*Math.PI);
  context.fill();
}
```

æ•ˆæœå¦‚ä¸‹æ‰€ç¤º:

![WebWorkerä¸­OffscreenCanvasç»˜åˆ¶å¾„å‘æ¸å˜ç”»çƒ](https://user-images.githubusercontent.com/8088864/126027866-d78a65fc-8f0f-4a7e-9adf-7eb09a03b956.png)

ä»»åŠ¡ç¹å¿™çš„ä¸»çº¿ç¨‹ä¹Ÿä¸ä¼šå½±å“åœ¨Workerä¸Šè¿è¡Œçš„åŠ¨ç”»ã€‚æ‰€ä»¥å³ä½¿ä¸»çº¿ç¨‹éå¸¸ç¹å¿™ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡æ­¤åŠŸèƒ½æ¥é¿å…æ‰å¸§å¹¶ä¿è¯æµç•…çš„åŠ¨ç”»

### WebRTCçš„YUVåª’ä½“æµæ•°æ®çš„ç¦»å±æ¸²æŸ“

ä» WebRTC ä¸­æ‹¿åˆ°çš„æ˜¯ YUV çš„åŸå§‹è§†é¢‘æµï¼Œå°†åŸå§‹çš„ YUV è§†é¢‘å¸§ç›´æ¥è½¬å‘è¿‡æ¥ï¼Œé€šè¿‡ç¬¬ä¸‰æ–¹åº“ç›´æ¥åœ¨ Cavans ä¸Šæ¸²æŸ“ã€‚

å¯ä»¥ä½¿ç”¨[yuv-canvas](https://github.com/brion/yuv-canvas)å’Œ[yuv-buffer](https://github.com/brion/yuv-buffer)ç¬¬ä¸‰æ–¹åº“æ¥æ¸²æŸ“YUVçš„åŸå§‹è§†é¢‘æµã€‚

ä¸»è¿›ç¨‹render.js

``` js
"use strict";
exports.__esModule = true;
var isEqual = require('lodash.isequal');
var YUVBuffer = require('yuv-buffer');
var YUVCanvas = require('yuv-canvas');
var Renderer = /** @class */ (function () {
    function Renderer(workSource) {
        var _this = this;
        this._sendCanvas = function () {
            _this.canvasSent = true;
            _this.worker && _this.worker.postMessage({
                type: 'constructor',
                data: {
                    canvas: _this.offCanvas,
                    id: (_this.element && _this.element.id) || (Math.random().toString(16).slice(2) + Math.random().toString(16).slice(2))
                }
            }, [_this.offCanvas]);
        };
        /**
         * åˆ¤æ–­ä½¿ç”¨æ¸²æŸ“çš„æ–¹å¼
         */
        this._checkRendererWay = function () {
            if (_this.workerReady && _this.worker && _this.offCanvas && _this.enableWorker) {
                return 'worker';
            }
            else {
                return 'software';
            }
        };
        // workerCanvasæ¸²æŸ“
        this._workDrawFrame = function (width, height, yUint8Array, uUint8Array, vUint8Array) {
            if (_this.canvasWrapper && _this.canvasWrapper.style.display !== 'none') {
                _this.canvasWrapper.style.display = 'none';
            }
            if (_this.workerCanvasWrapper && _this.workerCanvasWrapper.style.display === 'none') {
                _this.workerCanvasWrapper.style.display = 'flex';
            }
            _this.worker && _this.worker.postMessage({
                type: 'drawFrame',
                data: {
                    width: width,
                    height: height,
                    yUint8Array: yUint8Array,
                    uUint8Array: uUint8Array,
                    vUint8Array: vUint8Array
                }
            }, [yUint8Array, uUint8Array, vUint8Array]);
        };
        // å®é™…æ¸²æŸ“Canvas
        this._softwareDrawFrame = function (width, height, yUint8Array, uUint8Array, vUint8Array) {
            if (_this.workerCanvasWrapper && _this.workerCanvasWrapper.style.display !== 'none') {
                _this.workerCanvasWrapper.style.display = 'none';
            }
            if (_this.canvasWrapper && _this.canvasWrapper.style.display === 'none') {
                _this.canvasWrapper.style.display = 'flex';
            }
            var format = YUVBuffer.format({
                width: width,
                height: height,
                chromaWidth: width / 2,
                chromaHeight: height / 2
            });
            var y = YUVBuffer.lumaPlane(format, yUint8Array);
            var u = YUVBuffer.chromaPlane(format, uUint8Array);
            var v = YUVBuffer.chromaPlane(format, vUint8Array);
            var frame = YUVBuffer.frame(format, y, u, v);
            _this.yuv.drawFrame(frame);
        };
        this.cacheCanvasOpts = {};
        this.yuv = {};
        this.ready = false;
        this.contentMode = 0;
        this.container = {};
        this.canvasWrapper;
        this.canvas = {};
        this.element = {};
        this.offCanvas = {};
        this.enableWorker = !!workSource;
        if (this.enableWorker) {
            this.worker = new Worker(workSource);
            this.workerReady = false;
            this.canvasSent = false;
            this.worker.onerror = function (evt) {
                console.error('[WorkerRenderer]: the renderer worker catch error: ', evt);
                _this.workerReady = false;
                _this.enableWorker = false;
            };
            this.worker.onmessage = function (evt) {
                var data = evt.data;
                switch (data.type) {
                    case 'ready': {
                        console.log('[WorkerRenderer]: the renderer worker was ready');
                        _this.workerReady = true;
                        if (_this.offCanvas) {
                            _this._sendCanvas();
                        }
                        break;
                    }
                    case 'exited': {
                        console.log('[WorkerRenderer]: the renderer worker was exited');
                        _this.workerReady = false;
                        _this.enableWorker = false;
                        break;
                    }
                }
            };
        }
    }
    Renderer.prototype._calcZoom = function (vertical, contentMode, width, height, clientWidth, clientHeight) {
        if (vertical === void 0) { vertical = false; }
        if (contentMode === void 0) { contentMode = 0; }
        var localRatio = clientWidth / clientHeight;
        var tempRatio = width / height;
        if (isNaN(localRatio) || isNaN(tempRatio)) {
            return 1;
        }
        if (!contentMode) {
            if (vertical) {
                return localRatio > tempRatio ?
                    clientHeight / height : clientWidth / width;
            }
            else {
                return localRatio < tempRatio ?
                    clientHeight / height : clientWidth / width;
            }
        }
        else {
            if (vertical) {
                return localRatio < tempRatio ?
                    clientHeight / height : clientWidth / width;
            }
            else {
                return localRatio > tempRatio ?
                    clientHeight / height : clientWidth / width;
            }
        }
    };
    Renderer.prototype.getBindingElement = function () {
        return this.element;
    };
    Renderer.prototype.bind = function (element) {
        // record element
        this.element = element;
        // create container
        var container = document.createElement('div');
        container.className += ' video-canvas-container';
        Object.assign(container.style, {
            width: '100%',
            height: '100%',
            display: 'flex',
            justifyContent: 'center',
            alignItems: 'center',
            position: 'relative'
        });
        this.container = container;
        element && element.appendChild(this.container);
        // åˆ›å»ºä¸¤ä¸ªcanvasï¼Œä¸€ä¸ªåœ¨ä¸»çº¿ç¨‹ä¸­æ¸²æŸ“ï¼Œå¦‚æœweb workerä¸­çš„ç¦»å±canvasæ¸²æŸ“è¿›ç¨‹å‡ºé”™äº†ï¼Œè¿˜å¯ä»¥åˆ‡æ¢åˆ°ä¸»è¿›ç¨‹çš„canvasè¿›è¡Œæ¸²æŸ“
        var canvasWrapper = document.createElement('div');
        canvasWrapper.className += ' video-canvas-wrapper canvas-renderer';
        Object.assign(canvasWrapper.style, {
            width: '100%',
            height: '100%',
            justifyContent: 'center',
            alignItems: 'center',
            position: 'absolute',
            left: '0px',
            right: '0px',
            display: 'none'
        });
        this.canvasWrapper = canvasWrapper;
        this.container.appendChild(this.canvasWrapper);
        var workerCanvasWrapper = document.createElement('div');
        workerCanvasWrapper.className += ' video-canvas-wrapper webworker-renderer';
        Object.assign(workerCanvasWrapper.style, {
            width: '100%',
            height: '100%',
            justifyContent: 'center',
            alignItems: 'center',
            position: 'absolute',
            left: '0px',
            right: '0px',
            display: 'none'
        });
        this.workerCanvasWrapper = workerCanvasWrapper;
        this.container.appendChild(this.workerCanvasWrapper);
        // create canvas
        this.canvas = document.createElement('canvas');
        this.workerCanvas = document.createElement('canvas');
        this.canvasWrapper.appendChild(this.canvas);
        this.workerCanvasWrapper.appendChild(this.workerCanvas);
        // åˆ›å»º OffscreenCanvas å¯¹è±¡
        this.offCanvas = this.workerCanvas.transferControlToOffscreen();
        if (!this.canvasSent && this.offCanvas && this.worker && this.workerReady) {
            this._sendCanvas();
        }
        this.yuv = YUVCanvas.attach(this.canvas, { webGL: false });
    };
    Renderer.prototype.unbind = function () {
        this.canvasWrapper && this.canvasWrapper.removeChild(this.canvas);
        this.workerCanvasWrapper && this.workerCanvasWrapper.removeChild(this.workerCanvas);
        this.container && this.container.removeChild(this.canvasWrapper);
        this.container && this.container.removeChild(this.workerCanvasWrapper);
        this.element && this.element.removeChild(this.container);
        this.worker && this.worker.terminate();
        this.workerReady = false;
        this.canvasSent = false;
        this.yuv = null;
        this.container = null;
        this.workerCanvasWrapper = null;
        this.canvasWrapper = null;
        this.element = null;
        this.canvas = null;
        this.workerCanvas = null;
        this.offCanvas = null;
        this.worker = null;
    };
    Renderer.prototype.refreshCanvas = function () {
        // Not implemented for software renderer
    };
    Renderer.prototype.updateCanvas = function (options) {
        if (options === void 0) { options = {
            width: 0,
            height: 0,
            rotation: 0,
            mirrorView: false,
            contentMode: 0,
            clientWidth: 0,
            clientHeight: 0
        }; }
        // check if display options changed
        if (isEqual(this.cacheCanvasOpts, options)) {
            return;
        }
        this.cacheCanvasOpts = Object.assign({}, options);
        // check for rotation
        if (options.rotation === 0 || options.rotation === 180) {
            this.canvas.width = options.width;
            this.canvas.height = options.height;
            // canvas è°ƒç”¨ transferControlToOffscreen æ–¹æ³•åæ— æ³•ä¿®æ”¹canvasçš„å®½åº¦å’Œé«˜åº¦ï¼Œåªå…è®¸ä¿®æ”¹canvasçš„styleå±æ€§
            this.workerCanvas.style.width = options.width + "px";
            this.workerCanvas.style.height = options.height + "px";
        }
        else if (options.rotation === 90 || options.rotation === 270) {
            this.canvas.height = options.width;
            this.canvas.width = options.height;
            this.workerCanvas.style.height = options.width + "px";
            this.workerCanvas.style.width = options.height + "px";
        }
        else {
            throw new Error('Invalid value for rotation. Only support 0, 90, 180, 270');
        }
        var transformItems = [];
        transformItems.push("rotateZ(" + options.rotation + "deg)");
        var scale = this._calcZoom(options.rotation === 90 || options.rotation === 270, options.contentMode, options.width, options.height, options.clientWidth, options.clientHeight);
        // transformItems.push(`scale(${scale})`)
        this.canvas.style.zoom = scale;
        this.workerCanvas.style.zoom = scale;
        // check for mirror
        if (options.mirrorView) {
            // this.canvas.style.transform = 'rotateY(180deg)';
            transformItems.push('rotateY(180deg)');
        }
        if (transformItems.length > 0) {
            var transform = "" + transformItems.join(' ');
            this.canvas.style.transform = transform;
            this.workerCanvas.style.transform = transform;
        }
    };
    Renderer.prototype.drawFrame = function (imageData) {
        if (!this.ready) {
            this.ready = true;
        }
        var dv = new DataView(imageData.header);
        // let format = dv.getUint8(0);
        var mirror = dv.getUint8(1);
        var contentWidth = dv.getUint16(2);
        var contentHeight = dv.getUint16(4);
        var left = dv.getUint16(6);
        var top = dv.getUint16(8);
        var right = dv.getUint16(10);
        var bottom = dv.getUint16(12);
        var rotation = dv.getUint16(14);
        // let ts = dv.getUint32(16);
        var width = contentWidth + left + right;
        var height = contentHeight + top + bottom;
        this.updateCanvas({
            width: width, height: height, rotation: rotation,
            mirrorView: !!mirror,
            contentMode: this.contentMode,
            clientWidth: this.container && this.container.clientWidth,
            clientHeight: this.container && this.container.clientHeight
        });
        if (this._checkRendererWay() === 'software') {
            // å®é™…æ¸²æŸ“canvas
            this._softwareDrawFrame(width, height, imageData.yUint8Array, imageData.uUint8Array, imageData.vUint8Array);
        }
        else {
            this._workDrawFrame(width, height, imageData.yUint8Array, imageData.uUint8Array, imageData.vUint8Array);
        }
    };
    /**
     * æ¸…ç©ºæ•´ä¸ªCanvasé¢æ¿
     *
     * @memberof Renderer
     */
    Renderer.prototype.clearFrame = function () {
        if (this._checkRendererWay() === 'software') {
            this.yuv && this.yuv.clear();
        }
        else {
            this.worker && this.worker.postMessage({
                type: 'clearFrame'
            });
        }
    };
    Renderer.prototype.setContentMode = function (mode) {
        if (mode === void 0) { mode = 0; }
        this.contentMode = mode;
    };
    return Renderer;
}());

exports["default"] = Renderer;
```

æ¸²æŸ“Workerçš„ä»£ç å¦‚ä¸‹æ‰€ç¤º:

``` js
// render worker

(function() {
  const dateFormat = function(date, formatter = 'YYYY-MM-DD hh:mm:ss SSS') {
    if (!date) {
      return date;
    }

    let time;

    try {
      time = new Date(date);
    } catch (e) {
      return date;
    }

    const oDate = {
      Y: time.getFullYear(),
      M: time.getMonth() + 1,
      D: time.getDate(),
      h: time.getHours(),
      m: time.getMinutes(),
      s: time.getSeconds(),
      S: time.getMilliseconds()
    };

    return formatter.replace(/(Y|M|D|h|m|s|S)+/g, (res, key) => {
      let len = 2;

      switch (res.length) {
        case 1:
          len = res.slice(1, 0) === 'Y' ? 4 : 2;
          break;
        case 2:
          len = 2;
          break;
        case 3:
          len = 3;
          break;
        case 4:
          len = 4;
          break;
        default:
          len = 2;
      }
      return (`0${oDate[key]}`).slice(-len);
    });
  }

  let yuv;

  try {
    importScripts('./yuv-buffer/yuv-buffer.js');
    importScripts('./yuv-canvas/shaders.js');
    importScripts('./yuv-canvas/depower.js');
    importScripts('./yuv-canvas/YCbCr.js');
    importScripts('./yuv-canvas/FrameSink.js');
    importScripts('./yuv-canvas/SoftwareFrameSink.js');
    importScripts('./yuv-canvas/WebGLFrameSink.js');
    importScripts('./yuv-canvas/yuv-canvas.js');

    self.addEventListener('message', function (e) {
      const data = e.data;
      switch (data.type) {
        case 'constructor':
          console.log(`${dateFormat(new Date())} RENDER_WORKER [INFO]: received canvas: `, data.data.canvas, data.data.id);
          yuv = YUVCanvas.attach(data.data.canvas, { webGL: false });
          break;
        case 'drawFrame':
          // è€ƒè™‘æ˜¯å¦ä½¿ç”¨requestAnimationFrameè¿›è¡Œæ¸²æŸ“ï¼Œæ§åˆ¶æ¯ä¸€å¸§æ˜¾ç¤ºçš„é¢‘ç‡
          const width = data.data.width;
          const height = data.data.height;
          const yUint8Array = data.data.yUint8Array;
          const uUint8Array = data.data.uUint8Array;
          const vUint8Array = data.data.vUint8Array;
          const format = YUVBuffer.format({
            width: width,
            height: height,
            chromaWidth: width / 2,
            chromaHeight: height / 2
          });
          const y = YUVBuffer.lumaPlane(format, yUint8Array);
          const u = YUVBuffer.chromaPlane(format, uUint8Array);
          const v = YUVBuffer.chromaPlane(format, vUint8Array);
          const frame = YUVBuffer.frame(format, y, u, v);
          yuv && yuv.drawFrame(frame);
          break;
        case 'clearFrame': {
          yuv && yuv.clear(frame);
          break;
        }
        default:
          console.log(`${dateFormat(new Date())} RENDER_WORKER [INFO]: [RendererWorker]: Unknown message: `, data);
      };
    }, false);

    self.postMessage({
      type: 'ready',
    });
  } catch (error) {
    self.postMessage({
      type: 'exited',
    });

    console.log(`${dateFormat(new Date())} RENDER_WORKER [INFO]: [RendererWorker]: catch error`, error);
  }
})();

```

### æ€»ç»“

å¦‚æœä½ å¯¹å›¾åƒç»˜ç”»ä½¿ç”¨å¾—éå¸¸å¤šï¼ŒOffscreenCanvaså¯ä»¥æœ‰æ•ˆçš„æé«˜ä½ APPçš„æ€§èƒ½ã€‚å®ƒä½¿å¾—Workerå¯ä»¥å¤„ç†canvasçš„æ¸²æŸ“ç»˜åˆ¶ï¼Œè®©ä½ çš„APPæ›´å¥½åœ°åˆ©ç”¨äº†å¤šæ ¸ç³»ç»Ÿã€‚

OffscreenCanvasåœ¨Chrome 69ä¸­å·²ç»ä¸éœ€è¦å¼€å¯flagï¼ˆå®éªŒæ€§åŠŸèƒ½ï¼‰å°±å¯ä»¥ä½¿ç”¨äº†ã€‚å®ƒä¹Ÿæ­£åœ¨è¢« Firefox å®ç°ã€‚ç”±äºå…¶APIä¸æ™®é€šcanvaså…ƒç´ éå¸¸ç›¸ä¼¼ï¼Œæ‰€ä»¥ä½ å¯ä»¥è½»æ¾åœ°å¯¹å…¶è¿›è¡Œç‰¹å¾æ£€æµ‹å¹¶å¾ªåºæ¸è¿›åœ°ä½¿ç”¨å®ƒï¼Œè€Œä¸ä¼šç ´åç°æœ‰çš„APPæˆ–åº“çš„è¿è¡Œé€»è¾‘ã€‚OffscreenCanvasåœ¨ä»»ä½•æ¶‰åŠåˆ°å›¾å½¢è®¡ç®—ä»¥åŠåŠ¨ç”»è¡¨ç°ä¸”ä¸DOMå…³ç³»å¹¶ä¸å¯†åˆ‡ï¼ˆå³ä¾èµ–DOM APIä¸å¤šï¼‰çš„æƒ…å†µä¸‹ï¼Œå®ƒéƒ½å…·æœ‰æ€§èƒ½ä¼˜åŠ¿ã€‚


## XMLHttpRequest é€šç”¨å±æ€§å’Œæ–¹æ³•

1. `readyState`:è¡¨ç¤ºè¯·æ±‚çŠ¶æ€çš„æ•´æ•°ï¼Œå–å€¼ï¼š

- UNSENTï¼ˆ0ï¼‰ï¼šå¯¹è±¡å·²åˆ›å»º
- OPENEDï¼ˆ1ï¼‰ï¼šopen()æˆåŠŸè°ƒç”¨ï¼Œåœ¨è¿™ä¸ªçŠ¶æ€ä¸‹ï¼Œå¯ä»¥ä¸º xhr è®¾ç½®è¯·æ±‚å¤´ï¼Œæˆ–è€…ä½¿ç”¨ send()å‘é€è¯·æ±‚
- HEADERS_RECEIVED(2)ï¼šæ‰€æœ‰é‡å®šå‘å·²ç»è‡ªåŠ¨å®Œæˆè®¿é—®ï¼Œå¹¶ä¸”æœ€ç»ˆå“åº”çš„ HTTP å¤´å·²ç»æ”¶åˆ°
- LOADING(3)ï¼šå“åº”ä½“æ­£åœ¨æ¥æ”¶
- DONE(4)ï¼šæ•°æ®ä¼ è¾“å®Œæˆæˆ–è€…ä¼ è¾“äº§ç”Ÿé”™è¯¯

3. `onreadystatechange`ï¼šreadyState æ”¹å˜æ—¶è°ƒç”¨çš„å‡½æ•°
4. `status`ï¼šæœåŠ¡å™¨è¿”å›çš„ HTTP çŠ¶æ€ç ï¼ˆå¦‚ï¼Œ200ï¼Œ 404ï¼‰
5. `statusText`:æœåŠ¡å™¨è¿”å›çš„ HTTP çŠ¶æ€ä¿¡æ¯ï¼ˆå¦‚ï¼ŒOKï¼ŒNo Contentï¼‰
6. `responseText`:ä½œä¸ºå­—ç¬¦ä¸²å½¢å¼çš„æ¥è‡ªæœåŠ¡å™¨çš„å®Œæ•´å“åº”
7. `responseXML`: Document å¯¹è±¡ï¼Œè¡¨ç¤ºæœåŠ¡å™¨çš„å“åº”è§£ææˆçš„ XML æ–‡æ¡£
8. `abort()`:å–æ¶ˆå¼‚æ­¥ HTTP è¯·æ±‚
9. `getAllResponseHeaders()`: è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ŒåŒ…å«å“åº”ä¸­æœåŠ¡å™¨å‘é€çš„å…¨éƒ¨ HTTP æŠ¥å¤´ã€‚æ¯ä¸ªæŠ¥å¤´éƒ½æ˜¯ä¸€ä¸ªç”¨å†’å·åˆ†éš”å¼€çš„å/å€¼å¯¹ï¼Œå¹¶ä¸”ä½¿ç”¨ä¸€ä¸ªå›è½¦/æ¢è¡Œæ¥åˆ†éš”æŠ¥å¤´è¡Œ
10. `getResponseHeader(headerName)`:è¿”å› headName å¯¹åº”çš„æŠ¥å¤´å€¼
11. `open(method, url, asynchronous [, user, password])`:åˆå§‹åŒ–å‡†å¤‡å‘é€åˆ°æœåŠ¡å™¨ä¸Šçš„è¯·æ±‚ã€‚method æ˜¯ HTTP æ–¹æ³•ï¼Œä¸åŒºåˆ†å¤§å°å†™ï¼›url æ˜¯è¯·æ±‚å‘é€çš„ç›¸å¯¹æˆ–ç»å¯¹ URLï¼›asynchronous è¡¨ç¤ºè¯·æ±‚æ˜¯å¦å¼‚æ­¥ï¼›user å’Œ password æä¾›èº«ä»½éªŒè¯
12. `setRequestHeader(name, value)`:è®¾ç½® HTTP æŠ¥å¤´
13. `send(body)`:å¯¹æœåŠ¡å™¨è¯·æ±‚è¿›è¡Œåˆå§‹åŒ–ã€‚å‚æ•° body åŒ…å«è¯·æ±‚çš„ä¸»ä½“éƒ¨åˆ†ï¼Œå¯¹äº POST è¯·æ±‚ä¸ºé”®å€¼å¯¹å­—ç¬¦ä¸²ï¼›å¯¹äº GET è¯·æ±‚ï¼Œä¸º null

## offsetWidth/offsetHeight,clientWidth/clientHeight ä¸ scrollWidth/scrollHeight çš„åŒºåˆ«

- offsetWidth/offsetHeight è¿”å›å€¼åŒ…å«**content + padding + border**ï¼Œæ•ˆæœä¸ e.getBoundingClientRect()ç›¸åŒ
- clientWidth/clientHeight è¿”å›å€¼åªåŒ…å«**content + padding**ï¼Œå¦‚æœæœ‰æ»šåŠ¨æ¡ï¼Œä¹Ÿ**ä¸åŒ…å«æ»šåŠ¨æ¡**
- scrollWidth/scrollHeight è¿”å›å€¼åŒ…å«**content + padding + æº¢å‡ºå†…å®¹çš„å°ºå¯¸**

[Measuring Element Dimension and Location with CSSOM in Windows Internet Explorer 9](<http://msdn.microsoft.com/en-us/library/ie/hh781509(v=vs.85).aspx>)

![å…ƒç´ å°ºå¯¸](https://user-images.githubusercontent.com/8088864/126057392-4ee53f39-9730-4aae-aa18-2f25236b6dd2.png)

## focus/blur ä¸ focusin/focusout çš„åŒºåˆ«ä¸è”ç³»

1. focus/blur ä¸å†’æ³¡ï¼Œfocusin/focusout å†’æ³¡
2. focus/blur å…¼å®¹æ€§å¥½ï¼Œfocusin/focusout åœ¨é™¤ FireFox å¤–çš„æµè§ˆå™¨ä¸‹éƒ½ä¿æŒè‰¯å¥½å…¼å®¹æ€§ï¼Œå¦‚éœ€ä½¿ç”¨äº‹ä»¶æ‰˜ç®¡ï¼Œå¯è€ƒè™‘åœ¨ FireFox ä¸‹ä½¿ç”¨äº‹ä»¶æ•è· elem.addEventListener('focus', handler, true)
3. å¯è·å¾—ç„¦ç‚¹çš„å…ƒç´ ï¼š
   1. window
   2. é“¾æ¥è¢«ç‚¹å‡»æˆ–é”®ç›˜æ“ä½œ
   3. è¡¨å•ç©ºé—´è¢«ç‚¹å‡»æˆ–é”®ç›˜æ“ä½œ
   4. è®¾ç½®`tabindex`å±æ€§çš„å…ƒç´ è¢«ç‚¹å‡»æˆ–é”®ç›˜æ“ä½œ

## mouseover/mouseout ä¸ mouseenter/mouseleave çš„åŒºåˆ«ä¸è”ç³»

1. mouseover/mouseout æ˜¯æ ‡å‡†äº‹ä»¶ï¼Œ**æ‰€æœ‰æµè§ˆå™¨éƒ½æ”¯æŒ**ï¼›mouseenter/mouseleave æ˜¯ IE5.5 å¼•å…¥çš„ç‰¹æœ‰äº‹ä»¶åæ¥è¢« DOM3 æ ‡å‡†é‡‡çº³ï¼Œç°ä»£æ ‡å‡†æµè§ˆå™¨ä¹Ÿæ”¯æŒ
2. mouseover/mouseout æ˜¯**å†’æ³¡**äº‹ä»¶ï¼›mouseenter/mouseleave**ä¸å†’æ³¡**ã€‚éœ€è¦ä¸º**å¤šä¸ªå…ƒç´ ç›‘å¬é¼ æ ‡ç§»å…¥/å‡ºäº‹ä»¶æ—¶ï¼Œæ¨è mouseover/mouseout æ‰˜ç®¡ï¼Œæé«˜æ€§èƒ½**
3. æ ‡å‡†äº‹ä»¶æ¨¡å‹ä¸­ **event.target** è¡¨ç¤ºæ­£åœ¨å‘ç”Ÿç§»å…¥/ç§»å‡ºçš„å…ƒç´ ï¼Œ**event.relatedTarget**è¡¨ç¤ºå¯¹åº”ç§»å…¥/ç§»å‡ºçš„ç›®æ ‡å…ƒç´ ï¼›åœ¨è€ IE ä¸­ **event.srcElement** è¡¨ç¤ºæ­£åœ¨å‘ç”Ÿç§»å…¥/ç§»å‡ºçš„å…ƒç´ ï¼Œ**event.toElement**è¡¨ç¤ºç§»å‡ºçš„ç›®æ ‡å…ƒç´ ï¼Œ**event.fromElement**è¡¨ç¤ºç§»å…¥æ—¶çš„æ¥æºå…ƒç´ 

ä¾‹å­ï¼šé¼ æ ‡ä» div#target å…ƒç´ ç§»å‡ºæ—¶è¿›è¡Œå¤„ç†ï¼Œåˆ¤æ–­é€»è¾‘å¦‚ä¸‹ï¼š
``` html
    <div id="target"><span>test</span></div>

    <script type="text/javascript">
    var target = document.getElementById('target');
    if (target.addEventListener) {
      target.addEventListener('mouseout', mouseoutHandler, false);
    } else if (target.attachEvent) {
      target.attachEvent('onmouseout', mouseoutHandler);
    }

    function mouseoutHandler(e) {
      e = e || window.event;
      var target = e.target || e.srcElement;

      // åˆ¤æ–­ç§»å‡ºé¼ æ ‡çš„å…ƒç´ æ˜¯å¦ä¸ºç›®æ ‡å…ƒç´ 
      if (target.id !== 'target') {
        return;
      }

      // åˆ¤æ–­é¼ æ ‡æ˜¯ç§»å‡ºå…ƒç´ è¿˜æ˜¯ç§»åˆ°å­å…ƒç´ 
      var relatedTarget = e.relatedTarget || e.toElement;
      while (relatedTarget !== target
        && relatedTarget.nodeName.toUpperCase() !== 'BODY') {
        relatedTarget = relatedTarget.parentNode;
      }

      // å¦‚æœç›¸ç­‰ï¼Œè¯´æ˜é¼ æ ‡åœ¨å…ƒç´ å†…éƒ¨ç§»åŠ¨
      if (relatedTarget === target) {
        return;
      }

      // æ‰§è¡Œéœ€è¦æ“ä½œ
      //alert('é¼ æ ‡ç§»å‡º');

    }
    </script>
```

## HTMLè¯­ä¹‰åŒ–

- HTMLæ ‡ç­¾çš„è¯­ä¹‰åŒ–æ˜¯æŒ‡ï¼šé€šè¿‡ä½¿ç”¨åŒ…å«è¯­ä¹‰çš„æ ‡ç­¾ï¼ˆå¦‚h1-h6ï¼‰æ°å½“åœ°è¡¨ç¤ºæ–‡æ¡£ç»“æ„
- csså‘½åçš„è¯­ä¹‰åŒ–æ˜¯æŒ‡ï¼šä¸ºhtmlæ ‡ç­¾æ·»åŠ æœ‰æ„ä¹‰çš„class

- ä¸ºä»€ä¹ˆéœ€è¦è¯­ä¹‰åŒ–ï¼š
  - å»æ‰æ ·å¼åé¡µé¢å‘ˆç°æ¸…æ™°çš„ç»“æ„
  - ç›²äººä½¿ç”¨è¯»å±å™¨æ›´å¥½åœ°é˜…è¯»
  - æœç´¢å¼•æ“æ›´å¥½åœ°ç†è§£é¡µé¢ï¼Œæœ‰åˆ©äºæ”¶å½•
  - ä¾¿å›¢é˜Ÿé¡¹ç›®çš„å¯æŒç»­è¿ä½œåŠç»´æŠ¤

## ç®€è¿°ä¸€ä¸‹ä½ å¯¹HTMLè¯­ä¹‰åŒ–çš„ç†è§£ï¼Ÿ
- ç”¨æ­£ç¡®çš„æ ‡ç­¾åšæ­£ç¡®çš„äº‹æƒ…ã€‚
- htmlè¯­ä¹‰åŒ–è®©é¡µé¢çš„å†…å®¹ç»“æ„åŒ–ï¼Œç»“æ„æ›´æ¸…æ™°ï¼Œä¾¿äºå¯¹æµè§ˆå™¨ã€æœç´¢å¼•æ“è§£æ;
- å³ä½¿åœ¨æ²¡æœ‰æ ·å¼CSSæƒ…å†µä¸‹ä¹Ÿä»¥ä¸€ç§æ–‡æ¡£æ ¼å¼æ˜¾ç¤ºï¼Œå¹¶ä¸”æ˜¯å®¹æ˜“é˜…è¯»çš„;
- æœç´¢å¼•æ“çš„çˆ¬è™«ä¹Ÿä¾èµ–äºHTMLæ ‡è®°æ¥ç¡®å®šä¸Šä¸‹æ–‡å’Œå„ä¸ªå…³é”®å­—çš„æƒé‡ï¼Œåˆ©äºSEO;
- ä½¿é˜…è¯»æºä»£ç çš„äººå¯¹ç½‘ç«™æ›´å®¹æ˜“å°†ç½‘ç«™åˆ†å—ï¼Œä¾¿äºé˜…è¯»ç»´æŠ¤ç†è§£

## Doctypeä½œç”¨ï¼Ÿæ ‡å‡†æ¨¡å¼ä¸å…¼å®¹æ¨¡å¼å„æœ‰ä»€ä¹ˆåŒºåˆ«?

- `<!DOCTYPE>`å£°æ˜ä½äºä½`äºHTML`æ–‡æ¡£ä¸­çš„ç¬¬ä¸€è¡Œï¼Œå¤„äº `<html>` æ ‡ç­¾ä¹‹å‰ã€‚å‘ŠçŸ¥æµè§ˆå™¨çš„è§£æå™¨ç”¨ä»€ä¹ˆæ–‡æ¡£æ ‡å‡†è§£æè¿™ä¸ªæ–‡æ¡£ã€‚`DOCTYPE`ä¸å­˜åœ¨æˆ–æ ¼å¼ä¸æ­£ç¡®ä¼šå¯¼è‡´æ–‡æ¡£ä»¥å…¼å®¹æ¨¡å¼å‘ˆç°
- æ ‡å‡†æ¨¡å¼çš„æ’ç‰ˆ å’ŒJSè¿ä½œæ¨¡å¼éƒ½æ˜¯ä»¥è¯¥æµè§ˆå™¨æ”¯æŒçš„æœ€é«˜æ ‡å‡†è¿è¡Œã€‚åœ¨å…¼å®¹æ¨¡å¼ä¸­ï¼Œé¡µé¢ä»¥å®½æ¾çš„å‘åå…¼å®¹çš„æ–¹å¼æ˜¾ç¤º,æ¨¡æ‹Ÿè€å¼æµè§ˆå™¨çš„è¡Œä¸ºä»¥é˜²æ­¢ç«™ç‚¹æ— æ³•å·¥ä½œ

## HTML5 ä¸ºä»€ä¹ˆåªéœ€è¦å†™ <!DOCTYPE HTML>ï¼Ÿ

- HTML5 ä¸åŸºäº SGMLï¼Œå› æ­¤ä¸éœ€è¦å¯¹DTDè¿›è¡Œå¼•ç”¨ï¼Œä½†æ˜¯éœ€è¦doctypeæ¥è§„èŒƒæµè§ˆå™¨çš„è¡Œä¸ºï¼ˆè®©æµè§ˆå™¨æŒ‰ç…§å®ƒä»¬åº”è¯¥çš„æ–¹å¼æ¥è¿è¡Œï¼‰
- è€ŒHTML4.01åŸºäºSGML,æ‰€ä»¥éœ€è¦å¯¹DTDè¿›è¡Œå¼•ç”¨ï¼Œæ‰èƒ½å‘ŠçŸ¥æµè§ˆå™¨æ–‡æ¡£æ‰€ä½¿ç”¨çš„æ–‡æ¡£ç±»å‹

## è¡Œå†…å…ƒç´ æœ‰å“ªäº›ï¼Ÿå—çº§å…ƒç´ æœ‰å“ªäº›ï¼Ÿ ç©º(void)å…ƒç´ æœ‰é‚£äº›ï¼Ÿ

- è¡Œå†…å…ƒç´ æœ‰ï¼š`a b span img input select strong`ï¼ˆå¼ºè°ƒçš„è¯­æ°”ï¼‰
- å—çº§å…ƒç´ æœ‰ï¼š`div ul ol li dl dt dd h1 h2 h3 h4â€¦p`
- å¸¸è§çš„ç©ºå…ƒç´ :` <br> <hr> <img> <input> <link> <meta>`

## ä»‹ç»ä¸€ä¸‹ä½ å¯¹æµè§ˆå™¨å†…æ ¸çš„ç†è§£ï¼Ÿ

- ä¸»è¦åˆ†æˆä¸¤éƒ¨åˆ†ï¼šæ¸²æŸ“å¼•æ“(`layout engineer`æˆ–`Rendering Engine`)å’Œ`JS`å¼•æ“

- æ¸²æŸ“å¼•æ“ï¼šè´Ÿè´£å–å¾—ç½‘é¡µçš„å†…å®¹ï¼ˆHTMLã€XMLã€å›¾åƒç­‰ç­‰ï¼‰ã€æ•´ç†è®¯æ¯ï¼ˆä¾‹å¦‚åŠ å…¥CSSç­‰ï¼‰ï¼Œä»¥åŠè®¡ç®—ç½‘é¡µçš„æ˜¾ç¤ºæ–¹å¼ï¼Œç„¶åä¼šè¾“å‡ºè‡³æ˜¾ç¤ºå™¨æˆ–æ‰“å°æœºã€‚æµè§ˆå™¨çš„å†…æ ¸çš„ä¸åŒå¯¹äºç½‘é¡µçš„è¯­æ³•è§£é‡Šä¼šæœ‰ä¸åŒï¼Œæ‰€ä»¥æ¸²æŸ“çš„æ•ˆæœä¹Ÿä¸ç›¸åŒã€‚æ‰€æœ‰ç½‘é¡µæµè§ˆå™¨ã€ç”µå­é‚®ä»¶å®¢æˆ·ç«¯ä»¥åŠå…¶å®ƒéœ€è¦ç¼–è¾‘ã€æ˜¾ç¤ºç½‘ç»œå†…å®¹çš„åº”ç”¨ç¨‹åºéƒ½éœ€è¦å†…æ ¸
- JSå¼•æ“åˆ™ï¼šè§£æå’Œæ‰§è¡Œjavascriptæ¥å®ç°ç½‘é¡µçš„åŠ¨æ€æ•ˆæœ
- æœ€å¼€å§‹æ¸²æŸ“å¼•æ“å’ŒJSå¼•æ“å¹¶æ²¡æœ‰åŒºåˆ†çš„å¾ˆæ˜ç¡®ï¼Œåæ¥JSå¼•æ“è¶Šæ¥è¶Šç‹¬ç«‹ï¼Œå†…æ ¸å°±å€¾å‘äºåªæŒ‡æ¸²æŸ“å¼•æ“

## ä»‹ç»ä¸€ä¸‹ä½ å¯¹æµè§ˆå™¨å†…æ ¸çš„ç†è§£ï¼Ÿ

* æµè§ˆå™¨å†…æ ¸ä¸»è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šæ¸²æŸ“å¼•æ“(layout engineer æˆ– Rendering Engine) å’Œ JSå¼•æ“
* æ¸²æŸ“å¼•æ“è´Ÿè´£å–å¾—ç½‘é¡µçš„å†…å®¹è¿›è¡Œå¸ƒå±€è®¡å’Œæ ·å¼æ¸²æŸ“ï¼Œç„¶åä¼šè¾“å‡ºè‡³æ˜¾ç¤ºå™¨æˆ–æ‰“å°æœº
* JSå¼•æ“åˆ™è´Ÿè´£è§£æå’Œæ‰§è¡ŒJSè„šæœ¬æ¥å®ç°ç½‘é¡µçš„åŠ¨æ€æ•ˆæœå’Œç”¨æˆ·äº¤äº’
* æœ€å¼€å§‹æ¸²æŸ“å¼•æ“å’ŒJSå¼•æ“å¹¶æ²¡æœ‰åŒºåˆ†çš„å¾ˆæ˜ç¡®ï¼Œåæ¥JSå¼•æ“è¶Šæ¥è¶Šç‹¬ç«‹ï¼Œå†…æ ¸å°±å€¾å‘äºåªæŒ‡æ¸²æŸ“å¼•æ“

## å¸¸è§çš„æµè§ˆå™¨å†…æ ¸æœ‰å“ªäº›ï¼Ÿ

- `Trident`å†…æ ¸ï¼š`IE,MaxThon,TT,The World,360`,æœç‹—æµè§ˆå™¨ç­‰ã€‚[åˆç§°MSHTML]
- `Gecko`å†…æ ¸ï¼š`Netscape6`åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œ`FF,MozillaSuite/SeaMonkey`ç­‰
- `Presto`å†…æ ¸ï¼š`Opera7`åŠä»¥ä¸Šã€‚      [`Opera`å†…æ ¸åŸä¸ºï¼šPrestoï¼Œç°ä¸ºï¼š`Blink`;]
- `Webkit`å†…æ ¸ï¼š`Safari,Chrome`ç­‰ã€‚   [ `Chrome`çš„`Blink`ï¼ˆ`WebKit`çš„åˆ†æ”¯ï¼‰]

## å¸¸è§çš„æµè§ˆå™¨å†…æ ¸æœ‰å“ªäº›ï¼Ÿ

* Blinkå†…æ ¸ï¼šæ–°ç‰ˆ Chromeã€æ–°ç‰ˆ Opera
* Webkitå†…æ ¸ï¼šSafariã€åŸChrome
* Geckoå†…æ ¸ï¼šFireFoxã€Netscape6åŠä»¥ä¸Šç‰ˆæœ¬
* Tridentå†…æ ¸ï¼ˆåˆç§°MSHTMLå†…æ ¸ï¼‰ï¼šIEã€å›½äº§æµè§ˆå™¨
* Prestoå†…æ ¸ï¼šåŸOpera7åŠä»¥ä¸Š

## ä»€ä¹ˆæ˜¯ WebKit ï¼Ÿ

* WebKit æ˜¯ä¸€ä¸ªå¼€æºçš„æµè§ˆå™¨å†…æ ¸ï¼Œç”±æ¸²æŸ“å¼•æ“(WebCore)å’ŒJSè§£é‡Šå¼•æ“(JSCore)ç»„æˆ
* é€šå¸¸æ‰€è¯´çš„ WebKit æŒ‡çš„æ˜¯ WebKit(WebCore)ï¼Œä¸»è¦å·¥ä½œæ˜¯è¿›è¡Œ HTML/CSS æ¸²æŸ“
* WebKit ä¸€ç›´æ˜¯ Safari å’Œ Chrome(ä¹‹å‰) ä½¿ç”¨çš„æµè§ˆå™¨å†…æ ¸ï¼Œåæ¥ Chrome æ”¹ç”¨Blink å†…æ ¸

## html5æœ‰å“ªäº›æ–°ç‰¹æ€§ã€ç§»é™¤äº†é‚£äº›å…ƒç´ ï¼Ÿå¦‚ä½•å¤„ç†HTML5æ–°æ ‡ç­¾çš„æµè§ˆå™¨å…¼å®¹é—®é¢˜ï¼Ÿå¦‚ä½•åŒºåˆ† HTML å’Œ HTML5ï¼Ÿ

- HTML5 ç°åœ¨å·²ç»ä¸æ˜¯ SGML çš„å­é›†ï¼Œä¸»è¦æ˜¯å…³äºå›¾åƒï¼Œä½ç½®ï¼Œå­˜å‚¨ï¼Œå¤šä»»åŠ¡ç­‰åŠŸèƒ½çš„å¢åŠ 
  - ç»˜ç”» canvas
  - ç”¨äºåª’ä»‹å›æ”¾çš„ video å’Œ audio å…ƒç´ 
  - æœ¬åœ°ç¦»çº¿å­˜å‚¨ localStorage é•¿æœŸå­˜å‚¨æ•°æ®ï¼Œæµè§ˆå™¨å…³é—­åæ•°æ®ä¸ä¸¢å¤±
  - sessionStorage çš„æ•°æ®åœ¨æµè§ˆå™¨å…³é—­åè‡ªåŠ¨åˆ é™¤
  - è¯­æ„åŒ–æ›´å¥½çš„å†…å®¹å…ƒç´ ï¼Œæ¯”å¦‚ articleã€footerã€headerã€navã€section
  - è¡¨å•æ§ä»¶ï¼Œcalendarã€dateã€timeã€emailã€urlã€search
  - æ–°çš„æŠ€æœ¯webworker, websocket, Geolocation

- ç§»é™¤çš„å…ƒç´ ï¼š
  - çº¯è¡¨ç°çš„å…ƒç´ ï¼šbasefontï¼Œbigï¼Œcenterï¼Œfont, sï¼Œstrikeï¼Œttï¼Œu
  - å¯¹å¯ç”¨æ€§äº§ç”Ÿè´Ÿé¢å½±å“çš„å…ƒç´ ï¼šframeï¼Œframesetï¼Œnoframes

- æ”¯æŒHTML5æ–°æ ‡ç­¾ï¼š
  - IE8/IE7/IE6æ”¯æŒé€šè¿‡document.createElementæ–¹æ³•äº§ç”Ÿçš„æ ‡ç­¾
  - å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‰¹æ€§è®©è¿™äº›æµè§ˆå™¨æ”¯æŒHTML5æ–°æ ‡ç­¾
  - æµè§ˆå™¨æ”¯æŒæ–°æ ‡ç­¾åï¼Œè¿˜éœ€è¦æ·»åŠ æ ‡ç­¾é»˜è®¤çš„æ ·å¼

- å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨æˆç†Ÿçš„æ¡†æ¶ã€æ¯”å¦‚html5shim

```
<!--[if lt IE 9]>
<script> src="http://html5shim.googlecode.com
/svn/trunk/html5.js"</script><![endif]-->
```

- å¦‚ä½•åŒºåˆ†HTML5ï¼š DOCTYPEå£°æ˜\æ–°å¢çš„ç»“æ„å…ƒç´ \åŠŸèƒ½å…ƒç´ 

## HTML5æœ‰å“ªäº›æ–°ç‰¹æ€§ï¼Ÿ

* æ–°å¢é€‰æ‹©å™¨ document.querySelectorã€document.querySelectorAll
* æ‹–æ‹½é‡Šæ”¾(Drag and drop) API
* åª’ä½“æ’­æ”¾çš„ video å’Œ audio
* æœ¬åœ°å­˜å‚¨ localStorage å’Œ sessionStorage
* ç¦»çº¿åº”ç”¨ manifest
* æ¡Œé¢é€šçŸ¥ Notifications
* è¯­æ„åŒ–æ ‡ç­¾ articleã€footerã€headerã€navã€section
* å¢å¼ºè¡¨å•æ§ä»¶ calendarã€dateã€timeã€emailã€urlã€search
* åœ°ç†ä½ç½® Geolocation
* å¤šä»»åŠ¡ webworker
* å…¨åŒå·¥é€šä¿¡åè®® websocket
* å†å²ç®¡ç† history
* è·¨åŸŸèµ„æºå…±äº«(CORS) Access-Control-Allow-Origin
* é¡µé¢å¯è§æ€§æ”¹å˜äº‹ä»¶ visibilitychange
* è·¨çª—å£é€šä¿¡ PostMessage
* Form Data å¯¹è±¡
* ç»˜ç”» canvas

## HTML5ç§»é™¤äº†é‚£äº›å…ƒç´ ï¼Ÿ

* çº¯è¡¨ç°çš„å…ƒç´ ï¼šbasefontã€bigã€centerã€fontã€sã€strikeã€ttã€u
* å¯¹å¯ç”¨æ€§äº§ç”Ÿè´Ÿé¢å½±å“çš„å…ƒç´ ï¼šframeã€framesetã€noframes

## å¦‚ä½•å¤„ç†HTML5æ–°æ ‡ç­¾çš„æµè§ˆå™¨å…¼å®¹é—®é¢˜ï¼Ÿ

* é€šè¿‡ document.createElement åˆ›å»ºæ–°æ ‡ç­¾
* ä½¿ç”¨å«ç‰‡ html5shim.js

## å¦‚ä½•åŒºåˆ† HTML å’Œ HTML5ï¼Ÿ

DOCTYPEå£°æ˜ã€æ–°å¢çš„ç»“æ„å…ƒç´ ã€åŠŸèƒ½å…ƒç´ 

## åº”ç”¨ç¨‹åºå­˜å‚¨å’Œç¦»çº¿ web åº”ç”¨

HTML5 æ–°å¢åº”ç”¨ç¨‹åºç¼“å­˜ï¼Œå…è®¸ web åº”ç”¨å°†åº”ç”¨ç¨‹åºè‡ªèº«ä¿å­˜åˆ°ç”¨æˆ·æµè§ˆå™¨ä¸­ï¼Œç”¨æˆ·ç¦»çº¿çŠ¶æ€ä¹Ÿèƒ½è®¿é—®ã€‚
1. ä¸º html å…ƒç´ è®¾ç½® manifest å±æ€§:`<html manifest="myapp.appcache" >`ï¼Œå…¶ä¸­åç¼€ååªæ˜¯ä¸€ä¸ªçº¦å®šï¼ŒçœŸæ­£è¯†åˆ«æ–¹å¼æ˜¯é€šè¿‡`text/cache-manifest`ä½œä¸º MIME ç±»å‹ã€‚æ‰€ä»¥éœ€è¦é…ç½®æœåŠ¡å™¨ä¿è¯è®¾ç½®æ­£ç¡®
2. manifest æ–‡ä»¶é¦–è¡Œä¸º`CACHE MANIFEST`ï¼Œå…¶ä½™å°±æ˜¯è¦ç¼“å­˜çš„ URL åˆ—è¡¨ï¼Œæ¯ä¸ªä¸€è¡Œï¼Œç›¸å¯¹è·¯å¾„éƒ½ç›¸å¯¹äº manifest æ–‡ä»¶çš„ urlã€‚æ³¨é‡Šä»¥#å¼€å¤´
3. url åˆ†ä¸ºä¸‰ç§ç±»å‹ï¼š
  - `CACHE`ï¼šä¸ºé»˜è®¤ç±»å‹ï¼Œåˆ—ä¸¾çš„æ‰€æœ‰çš„æ–‡ä»¶éƒ½ä¼šè¢«ç¼“å­˜ã€‚
  - `NETWORK`ï¼šå¼€å¤´çš„åŒºåŸŸåˆ—ä¸¾çš„æ–‡ä»¶ï¼Œæ€»æ˜¯ä»çº¿ä¸Šè·å–ï¼Œè¡¨ç¤ºèµ„æºä»ä¸ç¼“å­˜ã€‚
    å¤´ä¿¡æ¯æ”¯æŒé€šé…ç¬¦"*"ï¼Œè¡¨ç¤ºä»»ä½•æœªæ˜ç¡®åˆ—ä¸¾çš„èµ„æºï¼Œéƒ½å°†é€šè¿‡ç½‘ç»œåŠ è½½ã€‚
  - `FALLBACK`ï¼šå¼€å¤´çš„åŒºåŸŸä¸­çš„å†…å®¹ï¼Œæä¾›äº†è·å–ä¸åˆ°ç¼“å­˜èµ„æºæ—¶çš„å¤‡é€‰èµ„æºè·¯å¾„ã€‚
    è¯¥åŒºåŸŸä¸­çš„å†…å®¹ï¼Œæ¯ä¸€è¡ŒåŒ…å«ä¸¤ä¸ªURLï¼ˆç¬¬ä¸€ä¸ªURLæ˜¯ä¸€ä¸ªå‰ç¼€ï¼Œä»»ä½•åŒ¹é…çš„èµ„æºéƒ½ä¸è¢«ç¼“å­˜ï¼Œç¬¬äºŒä¸ªURLè¡¨ç¤ºéœ€è¦è¢«ç¼“å­˜çš„èµ„æºï¼Œå¦‚æœä»ç½‘ç»œä¸­è½½å…¥ç¬¬ä¸€ä¸ª URL å¤±è´¥çš„è¯ï¼Œå°±ä¼šç”¨ç¬¬äºŒä¸ª URL æŒ‡å®šçš„ç¼“å­˜èµ„æºæ¥æ›¿ä»£ï¼‰

ä»¥ä¸‹æ˜¯ä¸€ä¸ªæ–‡ä»¶ä¾‹å­ï¼š

```
CACHE MANIFEST

CACHE:
myapp.html
myapp.css
myapp.js

FALLBACK:
videos/ offline_help.html

NETWORK:
cgi/
```

## HTML5çš„ç¦»çº¿å‚¨å­˜æ€ä¹ˆä½¿ç”¨ï¼Œå·¥ä½œåŸç†èƒ½ä¸èƒ½è§£é‡Šä¸€ä¸‹ï¼Ÿ

- åœ¨ç”¨æˆ·æ²¡æœ‰ä¸å› ç‰¹ç½‘è¿æ¥æ—¶ï¼Œå¯ä»¥æ­£å¸¸è®¿é—®ç«™ç‚¹æˆ–åº”ç”¨ï¼Œåœ¨ç”¨æˆ·ä¸å› ç‰¹ç½‘è¿æ¥æ—¶ï¼Œæ›´æ–°ç”¨æˆ·æœºå™¨ä¸Šçš„ç¼“å­˜æ–‡ä»¶

- åŸç†ï¼šHTML5çš„ç¦»çº¿å­˜å‚¨æ˜¯åŸºäºä¸€ä¸ªæ–°å»ºçš„.appcacheæ–‡ä»¶çš„ç¼“å­˜æœºåˆ¶(ä¸æ˜¯å­˜å‚¨æŠ€æœ¯)ï¼Œé€šè¿‡è¿™ä¸ªæ–‡ä»¶ä¸Šçš„è§£ææ¸…å•ç¦»çº¿å­˜å‚¨èµ„æºï¼Œè¿™äº›èµ„æºå°±ä¼šåƒcookieä¸€æ ·è¢«å­˜å‚¨äº†ä¸‹æ¥ã€‚ä¹‹åå½“ç½‘ç»œåœ¨å¤„äºç¦»çº¿çŠ¶æ€ä¸‹æ—¶ï¼Œæµè§ˆå™¨ä¼šé€šè¿‡è¢«ç¦»çº¿å­˜å‚¨çš„æ•°æ®è¿›è¡Œé¡µé¢å±•ç¤º

- å¦‚ä½•ä½¿ç”¨ï¼š
  - é¡µé¢å¤´éƒ¨åƒä¸‹é¢ä¸€æ ·åŠ å…¥ä¸€ä¸ªmanifestçš„å±æ€§ï¼›
  - åœ¨cache.manifestæ–‡ä»¶çš„ç¼–å†™ç¦»çº¿å­˜å‚¨çš„èµ„æº
  - åœ¨ç¦»çº¿çŠ¶æ€æ—¶ï¼Œæ“ä½œwindow.applicationCacheè¿›è¡Œéœ€æ±‚å®ç°
```
CACHE MANIFEST
    #v0.11
    CACHE:
    js/app.js
    css/style.css
    NETWORK:
    resourse/logo.png
    FALLBACK:
    / /offline.html
```

## æµè§ˆå™¨æ˜¯æ€ä¹ˆå¯¹HTML5çš„ç¦»çº¿å‚¨å­˜èµ„æºè¿›è¡Œç®¡ç†å’ŒåŠ è½½çš„å‘¢ï¼Ÿ

- åœ¨çº¿çš„æƒ…å†µä¸‹ï¼Œæµè§ˆå™¨å‘ç°htmlå¤´éƒ¨æœ‰manifestå±æ€§ï¼Œå®ƒä¼šè¯·æ±‚manifestæ–‡ä»¶ï¼Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è®¿é—®appï¼Œé‚£ä¹ˆæµè§ˆå™¨å°±ä¼šæ ¹æ®manifestæ–‡ä»¶çš„å†…å®¹ä¸‹è½½ç›¸åº”çš„èµ„æºå¹¶ä¸”è¿›è¡Œç¦»çº¿å­˜å‚¨ã€‚å¦‚æœå·²ç»è®¿é—®è¿‡appå¹¶ä¸”èµ„æºå·²ç»ç¦»çº¿å­˜å‚¨äº†ï¼Œé‚£ä¹ˆæµè§ˆå™¨å°±ä¼šä½¿ç”¨ç¦»çº¿çš„èµ„æºåŠ è½½é¡µé¢ï¼Œç„¶åæµè§ˆå™¨ä¼šå¯¹æ¯”æ–°çš„manifestæ–‡ä»¶ä¸æ—§çš„manifestæ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶æ²¡æœ‰å‘ç”Ÿæ”¹å˜ï¼Œå°±ä¸åšä»»ä½•æ“ä½œï¼Œå¦‚æœæ–‡ä»¶æ”¹å˜äº†ï¼Œé‚£ä¹ˆå°±ä¼šé‡æ–°ä¸‹è½½æ–‡ä»¶ä¸­çš„èµ„æºå¹¶è¿›è¡Œç¦»çº¿å­˜å‚¨ã€‚

- ç¦»çº¿çš„æƒ…å†µä¸‹ï¼Œæµè§ˆå™¨å°±ç›´æ¥ä½¿ç”¨ç¦»çº¿å­˜å‚¨çš„èµ„æºã€‚

## è¯·æè¿°ä¸€ä¸‹ cookiesï¼ŒsessionStorage å’Œ localStorage çš„åŒºåˆ«ï¼Ÿ

- cookieæ˜¯ç½‘ç«™ä¸ºäº†æ ‡ç¤ºç”¨æˆ·èº«ä»½è€Œå‚¨å­˜åœ¨ç”¨æˆ·æœ¬åœ°ç»ˆç«¯ï¼ˆClient Sideï¼‰ä¸Šçš„æ•°æ®ï¼ˆé€šå¸¸ç»è¿‡åŠ å¯†ï¼‰
- cookieæ•°æ®å§‹ç»ˆåœ¨åŒæºçš„httpè¯·æ±‚ä¸­æºå¸¦ï¼ˆå³ä½¿ä¸éœ€è¦ï¼‰ï¼Œè®°ä¼šåœ¨æµè§ˆå™¨å’ŒæœåŠ¡å™¨é—´æ¥å›ä¼ é€’
- `sessionStorage`å’Œ`localStorage`ä¸ä¼šè‡ªåŠ¨æŠŠæ•°æ®å‘ç»™æœåŠ¡å™¨ï¼Œä»…åœ¨æœ¬åœ°ä¿å­˜
- å­˜å‚¨å¤§å°ï¼š
  - `cookie`æ•°æ®å¤§å°ä¸èƒ½è¶…è¿‡4k
  - `sessionStorage`å’Œ`localStorage`è™½ç„¶ä¹Ÿæœ‰å­˜å‚¨å¤§å°çš„é™åˆ¶ï¼Œä½†æ¯”cookieå¤§å¾—å¤šï¼Œå¯ä»¥è¾¾åˆ°5Mæˆ–æ›´å¤§

- æœ‰æœŸæ—¶é—´ï¼š
  - `localStorage` å­˜å‚¨æŒä¹…æ•°æ®ï¼Œæµè§ˆå™¨å…³é—­åæ•°æ®ä¸ä¸¢å¤±é™¤éä¸»åŠ¨åˆ é™¤æ•°æ®
  - `sessionStorage`  æ•°æ®åœ¨å½“å‰æµè§ˆå™¨çª—å£å…³é—­åè‡ªåŠ¨åˆ é™¤
  - `cookie`  è®¾ç½®çš„`cookie`è¿‡æœŸæ—¶é—´ä¹‹å‰ä¸€ç›´æœ‰æ•ˆï¼Œå³ä½¿çª—å£æˆ–æµè§ˆå™¨å…³é—­

## sessionStorage,localStorage,cookie åŒºåˆ«

1. éƒ½ä¼šåœ¨æµè§ˆå™¨ç«¯ä¿å­˜ï¼Œæœ‰å¤§å°é™åˆ¶ï¼ŒåŒæºé™åˆ¶
2. cookie ä¼šåœ¨è¯·æ±‚æ—¶å‘é€åˆ°æœåŠ¡å™¨ï¼Œä½œä¸ºä¼šè¯æ ‡è¯†ï¼ŒæœåŠ¡å™¨å¯ä¿®æ”¹ cookieï¼›web storage ä¸ä¼šå‘é€åˆ°æœåŠ¡å™¨
3. cookie æœ‰ path æ¦‚å¿µï¼Œå­è·¯å¾„å¯ä»¥è®¿é—®çˆ¶è·¯å¾„ cookieï¼Œçˆ¶è·¯å¾„ä¸èƒ½è®¿é—®å­è·¯å¾„ cookie
4. æœ‰æ•ˆæœŸï¼šcookie åœ¨è®¾ç½®çš„æœ‰æ•ˆæœŸå†…æœ‰æ•ˆï¼Œé»˜è®¤ä¸ºæµè§ˆå™¨å…³é—­ï¼›sessionStorage åœ¨çª—å£å…³é—­å‰æœ‰æ•ˆï¼ŒlocalStorage é•¿æœŸæœ‰æ•ˆï¼Œç›´åˆ°ç”¨æˆ·åˆ é™¤
5. å…±äº«ï¼šsessionStorage ä¸èƒ½å…±äº«ï¼ŒlocalStorage åœ¨åŒæºæ–‡æ¡£ä¹‹é—´å…±äº«ï¼Œcookie åœ¨åŒæºä¸”ç¬¦åˆ path è§„åˆ™çš„æ–‡æ¡£ä¹‹é—´å…±äº«
6. localStorage çš„ä¿®æ”¹ä¼šä¿ƒå‘å…¶ä»–æ–‡æ¡£çª—å£çš„ update äº‹ä»¶
7. cookie æœ‰ secure å±æ€§è¦æ±‚ HTTPS ä¼ è¾“
8. æµè§ˆå™¨ä¸èƒ½ä¿å­˜è¶…è¿‡ 300 ä¸ª cookieï¼Œå•ä¸ªæœåŠ¡å™¨ä¸èƒ½è¶…è¿‡ 20 ä¸ªï¼Œæ¯ä¸ª cookie ä¸èƒ½è¶…è¿‡ 4kã€‚web storage å¤§å°æ”¯æŒèƒ½è¾¾åˆ° 5M

## å®¢æˆ·ç«¯å­˜å‚¨ localStorage å’Œ sessionStorage

- localStorage æœ‰æ•ˆæœŸä¸ºæ°¸ä¹…ï¼ŒsessionStorage æœ‰æ•ˆæœŸä¸ºé¡¶å±‚çª—å£å…³é—­å‰
- åŒæºæ–‡æ¡£å¯ä»¥è¯»å–å¹¶ä¿®æ”¹ localStorage æ•°æ®ï¼ŒsessionStorage åªå…è®¸åŒä¸€ä¸ªçª—å£ä¸‹çš„æ–‡æ¡£è®¿é—®ï¼Œå¦‚é€šè¿‡ iframe å¼•å…¥çš„åŒæºæ–‡æ¡£ã€‚
- Storage å¯¹è±¡é€šå¸¸è¢«å½“åšæ™®é€š javascript å¯¹è±¡ä½¿ç”¨ï¼š**é€šè¿‡è®¾ç½®å±æ€§æ¥å­˜å–å­—ç¬¦ä¸²å€¼**ï¼Œä¹Ÿå¯ä»¥é€šè¿‡**setItem(key, value)è®¾ç½®**ï¼Œ**getItem(key)è¯»å–**ï¼Œ**removeItem(key)åˆ é™¤**ï¼Œ**clear()åˆ é™¤æ‰€æœ‰æ•°æ®**ï¼Œ**length è¡¨ç¤ºå·²å­˜å‚¨çš„æ•°æ®é¡¹æ•°ç›®**ï¼Œ**key(index)è¿”å›å¯¹åº”ç´¢å¼•çš„ key**

```
localStorage.setItem('x', 1); // storge x->1
localStorage.getItem('x); // return value of x

// æšä¸¾æ‰€æœ‰å­˜å‚¨çš„é”®å€¼å¯¹
for (var i = 0, len = localStorage.length; i < len; ++i ) {
    var name = localStorage.key(i);
    var value = localStorage.getItem(name);
}

localStorage.removeItem('x'); // remove x
localStorage.clear();  // remove all data
```

## localStorage

**æµè§ˆå™¨æœ¬åœ°å­˜å‚¨**

- åœ¨è¾ƒé«˜ç‰ˆæœ¬çš„æµè§ˆå™¨ä¸­ï¼Œjsæä¾›äº†sessionStorageå’ŒglobalStorageã€‚åœ¨HTML5ä¸­æä¾›äº†localStorageæ¥å–ä»£globalStorage
- html5ä¸­çš„Web StorageåŒ…æ‹¬äº†ä¸¤ç§å­˜å‚¨æ–¹å¼ï¼šsessionStorageå’ŒlocalStorage
- sessionStorageç”¨äºæœ¬åœ°å­˜å‚¨ä¸€ä¸ªä¼šè¯ï¼ˆsessionï¼‰ä¸­çš„æ•°æ®ï¼Œè¿™äº›æ•°æ®åªæœ‰åœ¨åŒä¸€ä¸ªä¼šè¯ä¸­çš„é¡µé¢æ‰èƒ½è®¿é—®å¹¶ä¸”å½“ä¼šè¯ç»“æŸåæ•°æ®ä¹Ÿéšä¹‹é”€æ¯ã€‚å› æ­¤sessionStorageä¸æ˜¯ä¸€ç§æŒä¹…åŒ–çš„æœ¬åœ°å­˜å‚¨ï¼Œä»…ä»…æ˜¯ä¼šè¯çº§åˆ«çš„å­˜å‚¨
- è€ŒlocalStorageç”¨äºæŒä¹…åŒ–çš„æœ¬åœ°å­˜å‚¨ï¼Œé™¤éä¸»åŠ¨åˆ é™¤æ•°æ®ï¼Œå¦åˆ™æ•°æ®æ˜¯æ°¸è¿œä¸ä¼šè¿‡æœŸçš„

**web storageå’Œcookieçš„åŒºåˆ«**

- Web Storageçš„æ¦‚å¿µå’Œcookieç›¸ä¼¼ï¼ŒåŒºåˆ«æ˜¯å®ƒæ˜¯ä¸ºäº†æ›´å¤§å®¹é‡å­˜å‚¨è®¾è®¡çš„ã€‚Cookieçš„å¤§å°æ˜¯å—é™çš„ï¼Œå¹¶ä¸”æ¯æ¬¡ä½ è¯·æ±‚ä¸€ä¸ªæ–°çš„é¡µé¢çš„æ—¶å€™Cookieéƒ½ä¼šè¢«å‘é€è¿‡å»ï¼Œè¿™æ ·æ— å½¢ä¸­æµªè´¹äº†å¸¦å®½ï¼Œå¦å¤–cookieè¿˜éœ€è¦æŒ‡å®šä½œç”¨åŸŸï¼Œä¸å¯ä»¥è·¨åŸŸè°ƒç”¨
- é™¤æ­¤ä¹‹å¤–ï¼ŒWebStorageæ‹¥æœ‰setItem,getItem,removeItem,clearç­‰æ–¹æ³•ï¼Œä¸åƒcookieéœ€è¦å‰ç«¯å¼€å‘è€…è‡ªå·±å°è£…setCookieï¼ŒgetCookie
- ä½†æ˜¯cookieä¹Ÿæ˜¯ä¸å¯ä»¥æˆ–ç¼ºçš„ï¼šcookieçš„ä½œç”¨æ˜¯ä¸æœåŠ¡å™¨è¿›è¡Œäº¤äº’ï¼Œä½œä¸ºHTTPè§„èŒƒçš„ä¸€éƒ¨åˆ†è€Œå­˜åœ¨ ï¼Œè€ŒWeb Storageä»…ä»…æ˜¯ä¸ºäº†åœ¨æœ¬åœ°â€œå­˜å‚¨â€æ•°æ®è€Œç”Ÿ
- æµè§ˆå™¨çš„æ”¯æŒé™¤äº†IEï¼—åŠä»¥ä¸‹ä¸æ”¯æŒå¤–ï¼Œå…¶ä»–æ ‡å‡†æµè§ˆå™¨éƒ½å®Œå…¨æ”¯æŒ(ieåŠFFéœ€åœ¨webæœåŠ¡å™¨é‡Œè¿è¡Œ)ï¼Œå€¼å¾—ä¸€æçš„æ˜¯IEæ€»æ˜¯åŠå¥½äº‹ï¼Œä¾‹å¦‚IE7ã€IE6ä¸­çš„userDataå…¶å®å°±æ˜¯javascriptæœ¬åœ°å­˜å‚¨çš„è§£å†³æ–¹æ¡ˆã€‚é€šè¿‡ç®€å•çš„ä»£ç å°è£…å¯ä»¥ç»Ÿä¸€åˆ°æ‰€æœ‰çš„æµè§ˆå™¨éƒ½æ”¯æŒweb storage
- localStorageå’ŒsessionStorageéƒ½å…·æœ‰ç›¸åŒçš„æ“ä½œæ–¹æ³•ï¼Œä¾‹å¦‚setItemã€getItemå’ŒremoveItemç­‰

**cookie å’Œsession çš„åŒºåˆ«ï¼š**

- 1ã€cookieæ•°æ®å­˜æ”¾åœ¨å®¢æˆ·çš„æµè§ˆå™¨ä¸Šï¼Œsessionæ•°æ®æ”¾åœ¨æœåŠ¡å™¨ä¸Šã€‚

- 2ã€cookieä¸æ˜¯å¾ˆå®‰å…¨ï¼Œåˆ«äººå¯ä»¥åˆ†æå­˜æ”¾åœ¨æœ¬åœ°çš„COOKIEå¹¶è¿›è¡ŒCOOKIEæ¬ºéª—

    - è€ƒè™‘åˆ°å®‰å…¨åº”å½“ä½¿ç”¨sessionã€‚

- 3ã€sessionä¼šåœ¨ä¸€å®šæ—¶é—´å†…ä¿å­˜åœ¨æœåŠ¡å™¨ä¸Šã€‚å½“è®¿é—®å¢å¤šï¼Œä¼šæ¯”è¾ƒå ç”¨ä½ æœåŠ¡å™¨çš„æ€§èƒ½

    - è€ƒè™‘åˆ°å‡è½»æœåŠ¡å™¨æ€§èƒ½æ–¹é¢ï¼Œåº”å½“ä½¿ç”¨COOKIEã€‚

- 4ã€å•ä¸ªcookieä¿å­˜çš„æ•°æ®ä¸èƒ½è¶…è¿‡4Kï¼Œå¾ˆå¤šæµè§ˆå™¨éƒ½é™åˆ¶ä¸€ä¸ªç«™ç‚¹æœ€å¤šä¿å­˜20ä¸ªcookieã€‚

- 5ã€æ‰€ä»¥ä¸ªäººå»ºè®®ï¼š

    - å°†ç™»é™†ä¿¡æ¯ç­‰é‡è¦ä¿¡æ¯å­˜æ”¾ä¸ºSESSION

    - å…¶ä»–ä¿¡æ¯å¦‚æœéœ€è¦ä¿ç•™ï¼Œå¯ä»¥æ”¾åœ¨COOKIEä¸­

**æè¿° cookiesã€sessionStorage å’Œ localStorage çš„åŒºåˆ«ï¼Ÿ**

* ä¸æœåŠ¡å™¨äº¤äº’ï¼š
  - cookie æ˜¯ç½‘ç«™ä¸ºäº†æ ‡ç¤ºç”¨æˆ·èº«ä»½è€Œå‚¨å­˜åœ¨ç”¨æˆ·æœ¬åœ°ç»ˆç«¯ä¸Šçš„æ•°æ®ï¼ˆé€šå¸¸ç»è¿‡åŠ å¯†ï¼‰
  - cookie å§‹ç»ˆä¼šåœ¨åŒæº http è¯·æ±‚å¤´ä¸­æºå¸¦ï¼ˆå³ä½¿ä¸éœ€è¦ï¼‰ï¼Œåœ¨æµè§ˆå™¨å’ŒæœåŠ¡å™¨é—´æ¥å›ä¼ é€’
  - sessionStorage å’Œ localStorage ä¸ä¼šè‡ªåŠ¨æŠŠæ•°æ®å‘ç»™æœåŠ¡å™¨ï¼Œä»…åœ¨æœ¬åœ°ä¿å­˜

 * å­˜å‚¨å¤§å°ï¼š

  - cookie æ•°æ®æ ¹æ®ä¸åŒæµè§ˆå™¨é™åˆ¶ï¼Œå¤§å°ä¸€èˆ¬ä¸èƒ½è¶…è¿‡ 4k
  - sessionStorage å’Œ localStorage è™½ç„¶ä¹Ÿæœ‰å­˜å‚¨å¤§å°çš„é™åˆ¶ï¼Œä½†æ¯”cookieå¤§å¾—å¤šï¼Œå¯ä»¥è¾¾åˆ°5Mæˆ–æ›´å¤§

* æœ‰æœŸæ—¶é—´ï¼š
    - localStorage    å­˜å‚¨æŒä¹…æ•°æ®ï¼Œæµè§ˆå™¨å…³é—­åæ•°æ®ä¸ä¸¢å¤±é™¤éä¸»åŠ¨åˆ é™¤æ•°æ®
    - sessionStorage  æ•°æ®åœ¨å½“å‰æµè§ˆå™¨çª—å£å…³é—­åè‡ªåŠ¨åˆ é™¤
    - cookie           è®¾ç½®çš„cookieè¿‡æœŸæ—¶é—´ä¹‹å‰ä¸€ç›´æœ‰æ•ˆï¼Œä¸æµè§ˆå™¨æ˜¯å¦å…³é—­æ— å…³

## cookie åŠå…¶æ“ä½œ

- cookie æ˜¯ web æµè§ˆå™¨å­˜å‚¨çš„å°‘é‡æ•°æ®ï¼Œæœ€æ—©è®¾è®¡ä¸ºæœåŠ¡å™¨ç«¯ä½¿ç”¨ï¼Œä½œä¸º HTTP åè®®çš„æ‰©å±•å®ç°ã€‚cookie æ•°æ®ä¼šè‡ªåŠ¨åœ¨æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´ä¼ è¾“ã€‚
- é€šè¿‡è¯»å†™ cookie æ£€æµ‹æ˜¯å¦æ”¯æŒ
- cookie å±æ€§æœ‰**å**ï¼Œ**å€¼**ï¼Œ**max-age**ï¼Œ**path**, **domain**ï¼Œ**secure**ï¼›
- cookie é»˜è®¤æœ‰æ•ˆæœŸä¸ºæµè§ˆå™¨ä¼šè¯ï¼Œä¸€æ—¦ç”¨æˆ·å…³é—­æµè§ˆå™¨ï¼Œæ•°æ®å°±ä¸¢å¤±ï¼Œé€šè¿‡è®¾ç½®**max-age=seconds**å±æ€§å‘Šè¯‰æµè§ˆå™¨ cookie æœ‰æ•ˆæœŸ
- cookie ä½œç”¨åŸŸé€šè¿‡**æ–‡æ¡£æº**å’Œ**æ–‡æ¡£è·¯å¾„**æ¥ç¡®å®šï¼Œé€šè¿‡**path**å’Œ**domain**è¿›è¡Œé…ç½®ï¼Œweb é¡µé¢åŒç›®å½•æˆ–å­ç›®å½•æ–‡æ¡£éƒ½å¯è®¿é—®
- é€šè¿‡ cookie ä¿å­˜æ•°æ®çš„æ–¹æ³•ä¸ºï¼šä¸º document.cookie è®¾ç½®ä¸€ä¸ªç¬¦åˆç›®æ ‡çš„å­—ç¬¦ä¸²å¦‚ä¸‹
- è¯»å– document.cookie è·å¾—'; 'åˆ†éš”çš„å­—ç¬¦ä¸²ï¼Œkey=value,è§£æå¾—åˆ°ç»“æœ

```
document.cookie = 'name=qiu; max-age=9999; path=/; domain=domain; secure';

document.cookie = 'name=aaa; path=/; domain=domain; secure';
// è¦æ”¹å˜cookieçš„å€¼ï¼Œéœ€è¦ä½¿ç”¨ç›¸åŒçš„åå­—ã€è·¯å¾„å’ŒåŸŸï¼Œæ–°çš„å€¼
// æ¥è®¾ç½®cookieï¼ŒåŒæ ·çš„æ–¹æ³•å¯ä»¥ç”¨æ¥æ”¹å˜æœ‰æ•ˆæœŸ

// è®¾ç½®max-ageä¸º0å¯ä»¥åˆ é™¤æŒ‡å®šcookie

//è¯»å–cookieï¼Œè®¿é—®document.cookieè¿”å›é”®å€¼å¯¹ç»„æˆçš„å­—ç¬¦ä¸²ï¼Œ
//ä¸åŒé”®å€¼å¯¹ä¹‹é—´ç”¨'; 'åˆ†éš”ã€‚é€šè¿‡è§£æè·å¾—éœ€è¦çš„å€¼
```

[cookieUtil.js](https://github.com/qiu-deqing/google/blob/master/module/js/cookieUtil.js)ï¼šè‡ªå·±å†™çš„ cookie æ“ä½œå·¥å…·

## Cookie

**è¯·ä½ è°ˆè°ˆCookieçš„å¼Šç«¯**

- cookieè™½ç„¶åœ¨æŒä¹…ä¿å­˜å®¢æˆ·ç«¯æ•°æ®æä¾›äº†æ–¹ä¾¿ï¼Œåˆ†æ‹…äº†æœåŠ¡å™¨å­˜å‚¨çš„è´Ÿæ‹…ï¼Œä½†è¿˜æ˜¯æœ‰å¾ˆå¤šå±€é™æ€§çš„
- ç¬¬ä¸€ï¼šæ¯ä¸ªç‰¹å®šçš„åŸŸåä¸‹æœ€å¤šç”Ÿæˆ20ä¸ªcookie

- 1.IE6æˆ–æ›´ä½ç‰ˆæœ¬æœ€å¤š20ä¸ªcookie

- 2.IE7å’Œä¹‹åçš„ç‰ˆæœ¬æœ€åå¯ä»¥æœ‰50ä¸ªcookieã€‚

- 3.Firefoxæœ€å¤š50ä¸ªcookie

- 4.chromeå’ŒSafariæ²¡æœ‰åšç¡¬æ€§é™åˆ¶

**è¯·ä½ è°ˆè°ˆCookieçš„å¼Šç«¯ï¼Ÿ**

* æ¯ä¸ªç‰¹å®šçš„åŸŸåä¸‹æœ€å¤šç”Ÿæˆçš„ cookie ä¸ªæ•°æœ‰é™åˆ¶
* IE å’Œ Opera ä¼šæ¸…ç†è¿‘æœŸæœ€å°‘ä½¿ç”¨çš„ cookieï¼ŒFirefox ä¼šéšæœºæ¸…ç† cookie
* cookie çš„æœ€å¤§å¤§çº¦ä¸º 4096 å­—èŠ‚ï¼Œä¸ºäº†å…¼å®¹æ€§ï¼Œä¸€èˆ¬è®¾ç½®ä¸è¶…è¿‡ 4095 å­—èŠ‚
* å¦‚æœ cookie è¢«äººæ‹¦æˆªäº†ï¼Œå°±å¯ä»¥å–å¾—æ‰€æœ‰çš„ session ä¿¡æ¯

## label çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿæ€ä¹ˆä½¿ç”¨çš„ï¼Ÿ

* labelæ ‡ç­¾æ¥å®šä¹‰è¡¨å•æ§ä»¶çš„å…³ç³»ï¼š
  - å½“ç”¨æˆ·é€‰æ‹©labelæ ‡ç­¾æ—¶ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å°†ç„¦ç‚¹è½¬åˆ°å’Œlabelæ ‡ç­¾ç›¸å…³çš„è¡¨å•æ§ä»¶ä¸Š

* ä½¿ç”¨æ–¹æ³•1ï¼š
  - `<label for="mobile">Number:</label>`
  - `<input type="text" id="mobile"/>`

* ä½¿ç”¨æ–¹æ³•2ï¼š
  - `<label>Date:<input type="text"/></label>`

## Labelçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿæ˜¯æ€ä¹ˆç”¨çš„ï¼Ÿ

- labelæ ‡ç­¾æ¥å®šä¹‰è¡¨å•æ§åˆ¶é—´çš„å…³ç³»,å½“ç”¨æˆ·é€‰æ‹©è¯¥æ ‡ç­¾æ—¶ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å°†ç„¦ç‚¹è½¬åˆ°å’Œæ ‡ç­¾ç›¸å…³çš„è¡¨å•æ§ä»¶

## HTML5 çš„ form çš„è‡ªåŠ¨å®ŒæˆåŠŸèƒ½æ˜¯ä»€ä¹ˆï¼Ÿ

autocomplete å±æ€§è§„å®šè¾“å…¥å­—æ®µæ˜¯å¦åº”è¯¥å¯ç”¨è‡ªåŠ¨å®ŒæˆåŠŸèƒ½ã€‚é»˜è®¤ä¸ºå¯ç”¨ï¼Œè®¾ç½®ä¸º autocomplete=off å¯ä»¥å…³é—­è¯¥åŠŸèƒ½ã€‚

è‡ªåŠ¨å®Œæˆå…è®¸æµè§ˆå™¨é¢„æµ‹å¯¹å­—æ®µçš„è¾“å…¥ã€‚å½“ç”¨æˆ·åœ¨å­—æ®µå¼€å§‹é”®å…¥æ—¶ï¼Œæµè§ˆå™¨åŸºäºä¹‹å‰é”®å…¥è¿‡çš„å€¼ï¼Œåº”è¯¥æ˜¾ç¤ºå‡ºåœ¨å­—æ®µä¸­å¡«å†™çš„é€‰é¡¹ã€‚

autocomplete å±æ€§é€‚ç”¨äº `<form>`ï¼Œä»¥åŠä¸‹é¢çš„ `<input>` ç±»å‹ï¼štext, search, url, telephone, email, password, datepicker, range ä»¥åŠ colorã€‚

## HTML5çš„formå¦‚ä½•å…³é—­è‡ªåŠ¨å®ŒæˆåŠŸèƒ½ï¼Ÿ

- ç»™ä¸æƒ³è¦æç¤ºçš„ form æˆ–æŸä¸ª input è®¾ç½®ä¸º autocomplete=offã€‚


## å¦‚ä½•åœ¨é¡µé¢ä¸Šå®ç°ä¸€ä¸ªåœ†å½¢çš„å¯ç‚¹å‡»åŒºåŸŸï¼Ÿ

- map+areaæˆ–è€…svg
- border-radius
- çº¯jså®ç° éœ€è¦æ±‚ä¸€ä¸ªç‚¹åœ¨ä¸åœ¨åœ†ä¸Šç®€å•ç®—æ³•ã€è·å–é¼ æ ‡åæ ‡ç­‰ç­‰

## å®ç°ä¸ä½¿ç”¨ border ç”»å‡º1pxé«˜çš„çº¿ï¼Œåœ¨ä¸åŒæµè§ˆå™¨çš„æ ‡å‡†æ¨¡å¼ä¸æ€ªå¼‚æ¨¡å¼ä¸‹éƒ½èƒ½ä¿æŒä¸€è‡´çš„æ•ˆæœ

```
<div style="height:1px;overflow:hidden;background:red"></div>
```

## ç½‘é¡µéªŒè¯ç æ˜¯å¹²å˜›çš„ï¼Œæ˜¯ä¸ºäº†è§£å†³ä»€ä¹ˆå®‰å…¨é—®é¢˜

- åŒºåˆ†ç”¨æˆ·æ˜¯è®¡ç®—æœºè¿˜æ˜¯äººçš„å…¬å…±å…¨è‡ªåŠ¨ç¨‹åºã€‚å¯ä»¥é˜²æ­¢æ¶æ„ç ´è§£å¯†ç ã€åˆ·ç¥¨ã€è®ºå›çŒæ°´
- æœ‰æ•ˆé˜²æ­¢é»‘å®¢å¯¹æŸä¸€ä¸ªç‰¹å®šæ³¨å†Œç”¨æˆ·ç”¨ç‰¹å®šç¨‹åºæš´åŠ›ç ´è§£æ–¹å¼è¿›è¡Œä¸æ–­çš„ç™»é™†å°è¯•

## é¡µé¢å¯¼å…¥æ ·å¼æ—¶ï¼Œä½¿ç”¨linkå’Œ@importæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

- `link`å±äº`XHTML`æ ‡ç­¾ï¼Œé™¤äº†åŠ è½½`CSS`å¤–ï¼Œè¿˜èƒ½ç”¨äºå®šä¹‰`RSS`,å®šä¹‰`rel`è¿æ¥å±æ€§ç­‰ä½œç”¨ï¼›è€Œ`@import`æ˜¯`CSS`æä¾›çš„ï¼Œåªèƒ½ç”¨äºåŠ è½½`CSS`
- é¡µé¢è¢«åŠ è½½çš„æ—¶ï¼Œ`link`ä¼šåŒæ—¶è¢«åŠ è½½ï¼Œè€Œ`@import`å¼•ç”¨çš„`CSS`ä¼šç­‰åˆ°é¡µé¢è¢«åŠ è½½å®Œå†åŠ è½½
- `import`æ˜¯`CSS2.1` æå‡ºçš„ï¼Œåªåœ¨`IE5`ä»¥ä¸Šæ‰èƒ½è¢«è¯†åˆ«ï¼Œè€Œ`link`æ˜¯`XHTML`æ ‡ç­¾ï¼Œæ— å…¼å®¹é—®é¢˜

## HTML5çš„ç¦»çº¿å‚¨å­˜å·¥ä½œåŸç†èƒ½ä¸èƒ½è§£é‡Šä¸€ä¸‹ï¼Œæ€ä¹ˆä½¿ç”¨ï¼Ÿ

* HTML5çš„ç¦»çº¿å‚¨å­˜åŸç†ï¼š
  - ç”¨æˆ·åœ¨çº¿æ—¶ï¼Œä¿å­˜æ›´æ–°ç”¨æˆ·æœºå™¨ä¸Šçš„ç¼“å­˜æ–‡ä»¶ï¼›å½“ç”¨æˆ·ç¦»çº¿æ—¶ï¼Œå¯ä»¥æ­£å¸¸è®¿ç¦»çº¿å‚¨å­˜é—®ç«™ç‚¹æˆ–åº”ç”¨å†…å®¹

* HTML5çš„ç¦»çº¿å‚¨å­˜ä½¿ç”¨ï¼š
  - åœ¨æ–‡æ¡£çš„ html æ ‡ç­¾è®¾ç½® manifest å±æ€§ï¼Œå¦‚ manifest="/offline.appcache"
  - åœ¨é¡¹ç›®ä¸­æ–°å»º manifest æ–‡ä»¶ï¼Œmanifest æ–‡ä»¶çš„å‘½åå»ºè®®ï¼šxxx.appcache
  - åœ¨ web æœåŠ¡å™¨é…ç½®æ­£ç¡®çš„ MIME-typeï¼Œå³ text/cache-manifest

## æµè§ˆå™¨æ˜¯æ€ä¹ˆå¯¹HTML5çš„ç¦»çº¿å‚¨å­˜èµ„æºè¿›è¡Œç®¡ç†å’ŒåŠ è½½çš„ï¼Ÿ

* åœ¨çº¿çš„æƒ…å†µä¸‹ï¼Œæµè§ˆå™¨å‘ç° html æ ‡ç­¾æœ‰ manifest å±æ€§ï¼Œå®ƒä¼šè¯·æ±‚ manifest æ–‡ä»¶
* å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è®¿é—®appï¼Œé‚£ä¹ˆæµè§ˆå™¨å°±ä¼šæ ¹æ® manifest æ–‡ä»¶çš„å†…å®¹ä¸‹è½½ç›¸åº”çš„èµ„æºå¹¶ä¸”è¿›è¡Œç¦»çº¿å­˜å‚¨
* å¦‚æœå·²ç»è®¿é—®è¿‡appä¸”èµ„æºå·²ç»ç¦»çº¿å­˜å‚¨äº†ï¼Œæµè§ˆå™¨ä¼šå¯¹æ¯”æ–°çš„ manifest æ–‡ä»¶ä¸æ—§çš„ manifest æ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶æ²¡æœ‰å‘ç”Ÿæ”¹å˜ï¼Œå°±ä¸åšä»»ä½•æ“ä½œã€‚å¦‚æœæ–‡ä»¶æ”¹å˜äº†ï¼Œé‚£ä¹ˆå°±ä¼šé‡æ–°ä¸‹è½½æ–‡ä»¶ä¸­çš„èµ„æºå¹¶è¿›è¡Œç¦»çº¿å­˜å‚¨
* ç¦»çº¿çš„æƒ…å†µä¸‹ï¼Œæµè§ˆå™¨å°±ç›´æ¥ä½¿ç”¨ç¦»çº¿å­˜å‚¨çš„èµ„æºã€‚

## iframe æœ‰é‚£äº›ä¼˜ç‚¹å’Œç¼ºç‚¹ï¼Ÿ

* ä¼˜ç‚¹ï¼š
  - ç”¨æ¥åŠ è½½é€Ÿåº¦è¾ƒæ…¢çš„å†…å®¹ï¼ˆå¦‚å¹¿å‘Šï¼‰
  - å¯ä»¥ä½¿è„šæœ¬å¯ä»¥å¹¶è¡Œä¸‹è½½
  - å¯ä»¥å®ç°è·¨å­åŸŸé€šä¿¡

* ç¼ºç‚¹ï¼š
  - iframe ä¼šé˜»å¡ä¸»é¡µé¢çš„ onload äº‹ä»¶
  - æ— æ³•è¢«ä¸€äº›æœç´¢å¼•æ“ç´¢è¯†åˆ«
  - ä¼šäº§ç”Ÿå¾ˆå¤šé¡µé¢ï¼Œä¸å®¹æ˜“ç®¡ç†

## iframeæœ‰é‚£äº›ç¼ºç‚¹ï¼Ÿ

- iframeä¼šé˜»å¡ä¸»é¡µé¢çš„Onloadäº‹ä»¶
- æœç´¢å¼•æ“çš„æ£€ç´¢ç¨‹åºæ— æ³•è§£è¯»è¿™ç§é¡µé¢ï¼Œä¸åˆ©äºSEO
- iframeå’Œä¸»é¡µé¢å…±äº«è¿æ¥æ± ï¼Œè€Œæµè§ˆå™¨å¯¹ç›¸åŒåŸŸçš„è¿æ¥æœ‰é™åˆ¶ï¼Œæ‰€ä»¥ä¼šå½±å“é¡µé¢çš„å¹¶è¡ŒåŠ è½½
- ä½¿ç”¨`iframe`ä¹‹å‰éœ€è¦è€ƒè™‘è¿™ä¸¤ä¸ªç¼ºç‚¹ã€‚å¦‚æœéœ€è¦ä½¿ç”¨`iframe`ï¼Œæœ€å¥½æ˜¯é€šè¿‡`javascript`åŠ¨æ€ç»™`iframe`æ·»åŠ `src`å±æ€§å€¼ï¼Œè¿™æ ·å¯ä»¥ç»•å¼€ä»¥ä¸Šä¸¤ä¸ªé—®é¢˜

## å¦‚ä½•å®ç°æµè§ˆå™¨å†…å¤šä¸ªæ ‡ç­¾é¡µä¹‹é—´çš„é€šä¿¡ï¼Ÿ(é˜¿é‡Œ)

* iframe + contentWindow
* postMessage
  - å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿè·å¾—å¯¹åº”æ ‡ç­¾é¡µçš„å¼•ç”¨ï¼Œé€šè¿‡ postMessage æ–¹æ³•ä¹Ÿæ˜¯å¯ä»¥å®ç°å¤šä¸ªæ ‡ç­¾é¡µé€šä¿¡çš„ã€‚
* SharedWorker(Web Worker API)
  - ä½¿ç”¨ SharedWorker ï¼ˆåªåœ¨ chrome æµè§ˆå™¨å®ç°äº†ï¼‰ï¼Œä¸¤ä¸ªé¡µé¢å…±äº«åŒä¸€ä¸ªçº¿ç¨‹ï¼Œé€šè¿‡å‘çº¿ç¨‹å‘é€æ•°æ®å’Œæ¥æ”¶æ•°æ®æ¥å®ç°æ ‡ç­¾é¡µä¹‹é—´çš„åŒå‘é€šè¡Œã€‚
* storage äº‹ä»¶(localStorage API)
  - å¯ä»¥è°ƒç”¨ localStorageã€cookies ç­‰æœ¬åœ°å­˜å‚¨æ–¹å¼ï¼ŒlocalStorge å¦ä¸€ä¸ªæµè§ˆä¸Šä¸‹æ–‡é‡Œè¢«æ·»åŠ ã€ä¿®æ”¹æˆ–åˆ é™¤æ—¶ï¼Œå®ƒéƒ½ä¼šè§¦å‘ä¸€ä¸ª storage äº‹ä»¶ï¼Œæˆ‘ä»¬é€šè¿‡ç›‘å¬ storage äº‹ä»¶ï¼Œæ§åˆ¶å®ƒçš„å€¼æ¥è¿›è¡Œé¡µé¢ä¿¡æ¯é€šä¿¡ï¼›
* WebSocket
  - ä½¿ç”¨ WebSocketï¼Œé€šä¿¡çš„æ ‡ç­¾é¡µè¿æ¥åŒä¸€ä¸ªæœåŠ¡å™¨ï¼Œå‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨åï¼ŒæœåŠ¡å™¨æ¨é€æ¶ˆæ¯ç»™æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯ã€‚

## webSocket å¦‚ä½•å…¼å®¹ä½æµè§ˆå™¨ï¼Ÿ(é˜¿é‡Œ)

* Adobe Flash Socket
* ActiveX HTMLFile (IE)
* åŸºäº multipart ç¼–ç å‘é€ XHR
* åŸºäºé•¿è½®è¯¢çš„ XHR

## WEBåº”ç”¨ä»æœåŠ¡å™¨ä¸»åŠ¨æ¨é€Dataåˆ°å®¢æˆ·ç«¯æœ‰é‚£äº›æ–¹å¼ï¼Ÿ
* AJAX è½®è¯¢
* html5 æœåŠ¡å™¨æ¨é€äº‹ä»¶(EventSource)
  - `(new EventSource(SERVER_URL)).addEventListener("message", func);`
* html5 Websocket
 - `(new WebSocket(SERVER_URL)).addEventListener("message", func);`

## é¡µé¢å¯è§æ€§ï¼ˆPage Visibility APIï¼‰ å¯ä»¥æœ‰å“ªäº›ç”¨é€”ï¼Ÿ

- é€šè¿‡ visibilityState çš„å€¼æ£€æµ‹é¡µé¢å½“å‰æ˜¯å¦å¯è§ï¼Œä»¥åŠæ‰“å¼€ç½‘é¡µçš„æ—¶é—´ç­‰;
* åœ¨é¡µé¢è¢«åˆ‡æ¢åˆ°å…¶ä»–åå°è¿›ç¨‹çš„æ—¶å€™ï¼Œè‡ªåŠ¨æš‚åœéŸ³ä¹æˆ–è§†é¢‘çš„æ’­æ”¾
* å½“ç”¨æˆ·æµè§ˆå…¶ä»–é¡µé¢ï¼Œæš‚åœç½‘ç«™é¦–é¡µå¹»ç¯è‡ªåŠ¨æ’­æ”¾
* å®Œæˆç™»é™†åï¼Œæ— åˆ·æ–°è‡ªåŠ¨åŒæ­¥å…¶ä»–é¡µé¢çš„ç™»å½•çŠ¶æ€

## title ä¸ h1 çš„åŒºåˆ«ã€b ä¸ strong çš„åŒºåˆ«ã€i ä¸ em çš„åŒºåˆ«ï¼Ÿ

- `title` è¡¨ç¤ºæ˜¯æ•´ä¸ªé¡µé¢æ ‡é¢˜ï¼Œ`h1` åˆ™è¡¨ç¤ºå±‚æ¬¡æ˜ç¡®çš„æ ‡é¢˜ï¼Œå¯¹é¡µé¢ä¿¡æ¯çš„æŠ“å–æœ‰å¾ˆå¤§çš„å½±å“
- `strong` æ˜¯æ ‡æ˜é‡ç‚¹å†…å®¹ï¼Œæœ‰è¯­æ°”åŠ å¼ºçš„å«ä¹‰ï¼Œä½¿ç”¨é˜…è¯»è®¾å¤‡é˜…è¯»ç½‘ç»œæ—¶ï¼š`<strong>` ä¼šé‡è¯»ï¼Œè€Œ`<B>`æ˜¯å±•ç¤ºå¼ºè°ƒå†…å®¹
- `i` å†…å®¹å±•ç¤ºä¸ºæ–œä½“ï¼Œ`em` è¡¨ç¤ºå¼ºè°ƒçš„æ–‡æœ¬

## æ˜¯å±•ç¤ºå¼ºè°ƒå†…å®¹

* i å†…å®¹å±•ç¤ºä¸ºæ–œä½“ï¼Œem è¡¨ç¤ºå¼ºè°ƒçš„æ–‡æœ¬
* è‡ªç„¶æ ·å¼æ ‡ç­¾ï¼šb, i, u, s, pre
* è¯­ä¹‰æ ·å¼æ ‡ç­¾ï¼šstrong, em, ins, del, code
* åº”è¯¥å‡†ç¡®ä½¿ç”¨è¯­ä¹‰æ ·å¼æ ‡ç­¾, ä½†ä¸èƒ½æ»¥ç”¨ã€‚å¦‚æœä¸èƒ½ç¡®å®šæ—¶ï¼Œé¦–é€‰ä½¿ç”¨è‡ªç„¶æ ·å¼æ ‡ç­¾

## web å¼€å‘ä¸­ä¼šè¯è·Ÿè¸ªçš„æ–¹æ³•æœ‰å“ªäº›

1. cookie
2. session
3. url é‡å†™
4. éšè— input
5. ip åœ°å€

## `<img>`çš„`title`å’Œ`alt`æœ‰ä»€ä¹ˆåŒºåˆ«

1. `title`æ˜¯[global attributes](http://www.w3.org/TR/html-markup/global-attributes.html#common.attrs.core)ä¹‹ä¸€ï¼Œç”¨äºä¸ºå…ƒç´ æä¾›é™„åŠ çš„ advisory informationã€‚é€šå¸¸å½“é¼ æ ‡æ»‘åŠ¨åˆ°å…ƒç´ ä¸Šçš„æ—¶å€™æ˜¾ç¤ºã€‚
2. `alt`æ˜¯`<img>`çš„ç‰¹æœ‰å±æ€§ï¼Œæ˜¯å›¾ç‰‡å†…å®¹çš„ç­‰ä»·æè¿°ï¼Œç”¨äºå›¾ç‰‡æ— æ³•åŠ è½½æ—¶æ˜¾ç¤ºã€è¯»å±å™¨é˜…è¯»å›¾ç‰‡ã€‚å¯æå›¾ç‰‡é«˜å¯è®¿é—®æ€§ï¼Œé™¤äº†çº¯è£…é¥°å›¾ç‰‡å¤–éƒ½å¿…é¡»è®¾ç½®æœ‰æ„ä¹‰çš„å€¼ï¼Œæœç´¢å¼•æ“ä¼šé‡ç‚¹åˆ†æã€‚

## doctype æ˜¯ä»€ä¹ˆ,ä¸¾ä¾‹å¸¸è§ doctype åŠç‰¹ç‚¹

1. `<!doctype>`å£°æ˜å¿…é¡»å¤„äº HTML æ–‡æ¡£çš„å¤´éƒ¨ï¼Œåœ¨`<html>`æ ‡ç­¾ä¹‹å‰ï¼ŒHTML5 ä¸­ä¸åŒºåˆ†å¤§å°å†™
2. `<!doctype>`å£°æ˜ä¸æ˜¯ä¸€ä¸ª HTML æ ‡ç­¾ï¼Œæ˜¯ä¸€ä¸ªç”¨äºå‘Šè¯‰æµè§ˆå™¨å½“å‰ HTML ç‰ˆæœ¬çš„æŒ‡ä»¤
3. ç°ä»£æµè§ˆå™¨çš„ html å¸ƒå±€å¼•æ“é€šè¿‡æ£€æŸ¥ doctype å†³å®šä½¿ç”¨å…¼å®¹æ¨¡å¼è¿˜æ˜¯æ ‡å‡†æ¨¡å¼å¯¹æ–‡æ¡£è¿›è¡Œæ¸²æŸ“ï¼Œä¸€äº›æµè§ˆå™¨æœ‰ä¸€ä¸ªæ¥è¿‘æ ‡å‡†æ¨¡å‹ã€‚
4. åœ¨ HTML4.01 ä¸­`<!doctype>`å£°æ˜æŒ‡å‘ä¸€ä¸ª DTDï¼Œç”±äº HTML4.01 åŸºäº SGMLï¼Œæ‰€ä»¥ DTD æŒ‡å®šäº†æ ‡è®°è§„åˆ™ä»¥ä¿è¯æµè§ˆå™¨æ­£ç¡®æ¸²æŸ“å†…å®¹
5. HTML5 ä¸åŸºäº SGMLï¼Œæ‰€ä»¥ä¸ç”¨æŒ‡å®š DTD

å¸¸è§ dotypeï¼š

1. **HTML4.01 strict**ï¼šä¸å…è®¸ä½¿ç”¨è¡¨ç°æ€§ã€åºŸå¼ƒå…ƒç´ ï¼ˆå¦‚ fontï¼‰ä»¥åŠ framesetã€‚å£°æ˜ï¼š`<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">`
2. **HTML4.01 Transitional**:å…è®¸ä½¿ç”¨è¡¨ç°æ€§ã€åºŸå¼ƒå…ƒç´ ï¼ˆå¦‚ fontï¼‰ï¼Œä¸å…è®¸ä½¿ç”¨ framesetã€‚å£°æ˜ï¼š`<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">`
3. **HTML4.01 Frameset**:å…è®¸è¡¨ç°æ€§å…ƒç´ ï¼ŒåºŸæ°”å…ƒç´ ä»¥åŠ framesetã€‚å£°æ˜ï¼š`<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Frameset//EN" "http://www.w3.org/TR/html4/frameset.dtd">`
4. **XHTML1.0 Strict**:ä¸ä½¿ç”¨å…è®¸è¡¨ç°æ€§ã€åºŸå¼ƒå…ƒç´ ä»¥åŠ framesetã€‚æ–‡æ¡£å¿…é¡»æ˜¯ç»“æ„è‰¯å¥½çš„ XML æ–‡æ¡£ã€‚å£°æ˜ï¼š`<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">`
5. **XHTML1.0 Transitional**:å…è®¸ä½¿ç”¨è¡¨ç°æ€§ã€åºŸå¼ƒå…ƒç´ ï¼Œä¸å…è®¸ framesetï¼Œæ–‡æ¡£å¿…é¡»æ˜¯ç»“æ„è‰¯å¥½çš„ XMl æ–‡æ¡£ã€‚å£°æ˜ï¼š `<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">`
6. **XHTML 1.0 Frameset**:å…è®¸ä½¿ç”¨è¡¨ç°æ€§ã€åºŸå¼ƒå…ƒç´ ä»¥åŠ framesetï¼Œæ–‡æ¡£å¿…é¡»æ˜¯ç»“æ„è‰¯å¥½çš„ XML æ–‡æ¡£ã€‚å£°æ˜ï¼š`<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Frameset//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-frameset.dtd">`
7. **HTML 5**: `<!doctype html>`

## HTML å…¨å±€å±æ€§(global attribute)æœ‰å“ªäº›

å‚è€ƒèµ„æ–™ï¼š[MDN: html global attribute](https://developer.mozilla.org/en-US/docs/Web/HTML/Global_attributes)æˆ–è€…[W3C HTML global-attributes](http://www.w3.org/TR/html-markup/global-attributes.html#common.attrs.core)

- `accesskey`:è®¾ç½®å¿«æ·é”®ï¼Œæä¾›å¿«é€Ÿè®¿é—®å…ƒç´ å¦‚<a href="#" accesskey="a">aaa</a>åœ¨ windows ä¸‹çš„ firefox ä¸­æŒ‰`alt + shift + a`å¯æ¿€æ´»å…ƒç´ 
- `class`:ä¸ºå…ƒç´ è®¾ç½®ç±»æ ‡è¯†ï¼Œå¤šä¸ªç±»åç”¨ç©ºæ ¼åˆ†å¼€ï¼ŒCSS å’Œ javascript å¯é€šè¿‡ class å±æ€§è·å–å…ƒç´ 
- `contenteditable`: æŒ‡å®šå…ƒç´ å†…å®¹æ˜¯å¦å¯ç¼–è¾‘
- `contextmenu`: è‡ªå®šä¹‰é¼ æ ‡å³é”®å¼¹å‡ºèœå•å†…å®¹
- `data-*`: ä¸ºå…ƒç´ å¢åŠ è‡ªå®šä¹‰å±æ€§
- `dir`: è®¾ç½®å…ƒç´ æ–‡æœ¬æ–¹å‘
- `draggable`: è®¾ç½®å…ƒç´ æ˜¯å¦å¯æ‹–æ‹½
- `dropzone`: è®¾ç½®å…ƒç´ æ‹–æ”¾ç±»å‹ï¼š copy, move, link
- `hidden`: è¡¨ç¤ºä¸€ä¸ªå…ƒç´ æ˜¯å¦ä¸æ–‡æ¡£ã€‚æ ·å¼ä¸Šä¼šå¯¼è‡´å…ƒç´ ä¸æ˜¾ç¤ºï¼Œä½†æ˜¯ä¸èƒ½ç”¨è¿™ä¸ªå±æ€§å®ç°æ ·å¼æ•ˆæœ
- `id`: å…ƒç´  idï¼Œæ–‡æ¡£å†…å”¯ä¸€
- `lang`: å…ƒç´ å†…å®¹çš„çš„è¯­è¨€
- `spellcheck`: æ˜¯å¦å¯åŠ¨æ‹¼å†™å’Œè¯­æ³•æ£€æŸ¥
- `style`: è¡Œå†… css æ ·å¼
- `tabindex`: è®¾ç½®å…ƒç´ å¯ä»¥è·å¾—ç„¦ç‚¹ï¼Œé€šè¿‡ tab å¯ä»¥å¯¼èˆª
- `title`: å…ƒç´ ç›¸å…³çš„å»ºè®®ä¿¡æ¯
- `translate`: å…ƒç´ å’Œå­å­™èŠ‚ç‚¹å†…å®¹æ˜¯å¦éœ€è¦æœ¬åœ°åŒ–

## ä»€ä¹ˆæ˜¯ web è¯­ä¹‰åŒ–,æœ‰ä»€ä¹ˆå¥½å¤„

web è¯­ä¹‰åŒ–æ˜¯æŒ‡é€šè¿‡ HTML æ ‡è®°è¡¨ç¤ºé¡µé¢åŒ…å«çš„ä¿¡æ¯ï¼ŒåŒ…å«äº† HTML æ ‡ç­¾çš„è¯­ä¹‰åŒ–å’Œ css å‘½åçš„è¯­ä¹‰åŒ–ã€‚
HTML æ ‡ç­¾çš„è¯­ä¹‰åŒ–æ˜¯æŒ‡ï¼šé€šè¿‡ä½¿ç”¨åŒ…å«è¯­ä¹‰çš„æ ‡ç­¾ï¼ˆå¦‚ h1-h6ï¼‰æ°å½“åœ°è¡¨ç¤ºæ–‡æ¡£ç»“æ„
css å‘½åçš„è¯­ä¹‰åŒ–æ˜¯æŒ‡ï¼šä¸º html æ ‡ç­¾æ·»åŠ æœ‰æ„ä¹‰çš„ classï¼Œid è¡¥å……æœªè¡¨è¾¾çš„è¯­ä¹‰ï¼Œå¦‚[Microformat](http://en.wikipedia.org/wiki/Microformats)é€šè¿‡æ·»åŠ ç¬¦åˆè§„åˆ™çš„ class æè¿°ä¿¡æ¯
ä¸ºä»€ä¹ˆéœ€è¦è¯­ä¹‰åŒ–ï¼š

- å»æ‰æ ·å¼åé¡µé¢å‘ˆç°æ¸…æ™°çš„ç»“æ„
- ç›²äººä½¿ç”¨è¯»å±å™¨æ›´å¥½åœ°é˜…è¯»
- æœç´¢å¼•æ“æ›´å¥½åœ°ç†è§£é¡µé¢ï¼Œæœ‰åˆ©äºæ”¶å½•
- ä¾¿äºå›¢é˜Ÿé¡¹ç›®çš„å¯æŒç»­è¿ä½œåŠç»´æŠ¤

## ä»€ä¹ˆæ˜¯æ¸è¿›å¢å¼º

æ¸è¿›å¢å¼ºæ˜¯æŒ‡åœ¨ web è®¾è®¡æ—¶å¼ºè°ƒå¯è®¿é—®æ€§ã€è¯­ä¹‰åŒ– HTML æ ‡ç­¾ã€å¤–éƒ¨æ ·å¼è¡¨å’Œè„šæœ¬ã€‚ä¿è¯æ‰€æœ‰äººéƒ½èƒ½è®¿é—®é¡µé¢çš„åŸºæœ¬å†…å®¹å’ŒåŠŸèƒ½åŒæ—¶ä¸ºé«˜çº§æµè§ˆå™¨å’Œé«˜å¸¦å®½ç”¨æˆ·æä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚æ ¸å¿ƒåŸåˆ™å¦‚ä¸‹:

- æ‰€æœ‰æµè§ˆå™¨éƒ½å¿…é¡»èƒ½è®¿é—®åŸºæœ¬å†…å®¹
- æ‰€æœ‰æµè§ˆå™¨éƒ½å¿…é¡»èƒ½ä½¿ç”¨åŸºæœ¬åŠŸèƒ½
- æ‰€æœ‰å†…å®¹éƒ½åŒ…å«åœ¨è¯­ä¹‰åŒ–æ ‡ç­¾ä¸­
- é€šè¿‡å¤–éƒ¨ CSS æä¾›å¢å¼ºçš„å¸ƒå±€
- é€šè¿‡éä¾µå…¥å¼ã€å¤–éƒ¨ javascript æä¾›å¢å¼ºåŠŸèƒ½
- end-user web browser preferences are respected

## DOM å…ƒç´  e çš„ e.getAttribute(propName)å’Œ e.propName æœ‰ä»€ä¹ˆåŒºåˆ«å’Œè”ç³»

- e.getAttribute()ï¼Œæ˜¯æ ‡å‡† DOM æ“ä½œæ–‡æ¡£å…ƒç´ å±æ€§çš„æ–¹æ³•ï¼Œå…·æœ‰é€šç”¨æ€§å¯åœ¨ä»»æ„æ–‡æ¡£ä¸Šä½¿ç”¨ï¼Œè¿”å›å…ƒç´ åœ¨æºæ–‡ä»¶ä¸­**è®¾ç½®çš„å±æ€§**
- e.propName é€šå¸¸æ˜¯åœ¨ HTML æ–‡æ¡£ä¸­è®¿é—®ç‰¹å®šå…ƒç´ çš„**ç‰¹æ€§**ï¼Œæµè§ˆå™¨è§£æå…ƒç´ åç”Ÿæˆå¯¹åº”å¯¹è±¡ï¼ˆå¦‚ a æ ‡ç­¾ç”Ÿæˆ HTMLAnchorElementï¼‰ï¼Œè¿™äº›å¯¹è±¡çš„ç‰¹æ€§ä¼šæ ¹æ®ç‰¹å®šè§„åˆ™ç»“åˆå±æ€§è®¾ç½®å¾—åˆ°ï¼Œå¯¹äºæ²¡æœ‰å¯¹åº”ç‰¹æ€§çš„å±æ€§ï¼Œåªèƒ½ä½¿ç”¨ getAttribute è¿›è¡Œè®¿é—®
- e.getAttribute()è¿”å›å€¼æ˜¯æºæ–‡ä»¶ä¸­è®¾ç½®çš„å€¼ï¼Œç±»å‹æ˜¯å­—ç¬¦ä¸²æˆ–è€… nullï¼ˆæœ‰çš„å®ç°è¿”å›""ï¼‰
- e.propName è¿”å›å€¼å¯èƒ½æ˜¯å­—ç¬¦ä¸²ã€å¸ƒå°”å€¼ã€å¯¹è±¡ã€undefined ç­‰
- å¤§éƒ¨åˆ† attribute ä¸ property æ˜¯ä¸€ä¸€å¯¹åº”å…³ç³»ï¼Œä¿®æ”¹å…¶ä¸­ä¸€ä¸ªä¼šå½±å“å¦ä¸€ä¸ªï¼Œå¦‚ idï¼Œtitle ç­‰å±æ€§
- ä¸€äº›å¸ƒå°”å±æ€§`<input hidden/>`çš„æ£€æµ‹è®¾ç½®éœ€è¦ hasAttribute å’Œ removeAttribute æ¥å®Œæˆï¼Œæˆ–è€…è®¾ç½®å¯¹åº” property
- åƒ`<a href="../index.html">link</a>`ä¸­ href å±æ€§ï¼Œè½¬æ¢æˆ property çš„æ—¶å€™éœ€è¦é€šè¿‡è½¬æ¢å¾—åˆ°å®Œæ•´ URL
- ä¸€äº› attribute å’Œ property ä¸æ˜¯ä¸€ä¸€å¯¹åº”å¦‚ï¼šform æ§ä»¶ä¸­`<input value="hello"/>`å¯¹åº”çš„æ˜¯ defaultValueï¼Œä¿®æ”¹æˆ–è®¾ç½® value property ä¿®æ”¹çš„æ˜¯æ§ä»¶å½“å‰å€¼ï¼ŒsetAttribute ä¿®æ”¹ value å±æ€§ä¸ä¼šæ”¹å˜ value property

## å‰ç«¯éœ€è¦æ³¨æ„å“ªäº› SEO

1. åˆç†çš„ titleã€descriptionã€keywordsï¼šæœç´¢å¯¹ç€ä¸‰é¡¹çš„æƒé‡é€ä¸ªå‡å°ï¼Œtitle å€¼å¼ºè°ƒé‡ç‚¹å³å¯ï¼Œé‡è¦å…³é”®è¯å‡ºç°ä¸è¦è¶…è¿‡ 2 æ¬¡ï¼Œè€Œä¸”è¦é å‰ï¼Œä¸åŒé¡µé¢ title è¦æœ‰æ‰€ä¸åŒï¼›description æŠŠé¡µé¢å†…å®¹é«˜åº¦æ¦‚æ‹¬ï¼Œé•¿åº¦åˆé€‚ï¼Œä¸å¯è¿‡åˆ†å †ç Œå…³é”®è¯ï¼Œä¸åŒé¡µé¢ description æœ‰æ‰€ä¸åŒï¼›keywords åˆ—ä¸¾å‡ºé‡è¦å…³é”®è¯å³å¯
2. è¯­ä¹‰åŒ–çš„ HTML ä»£ç ï¼Œç¬¦åˆ W3C è§„èŒƒï¼šè¯­ä¹‰åŒ–ä»£ç è®©æœç´¢å¼•æ“å®¹æ˜“ç†è§£ç½‘é¡µ
3. é‡è¦å†…å®¹ HTML ä»£ç æ”¾åœ¨æœ€å‰ï¼šæœç´¢å¼•æ“æŠ“å– HTML é¡ºåºæ˜¯ä»ä¸Šåˆ°ä¸‹ï¼Œæœ‰çš„æœç´¢å¼•æ“å¯¹æŠ“å–é•¿åº¦æœ‰é™åˆ¶ï¼Œä¿è¯é‡è¦å†…å®¹ä¸€å®šä¼šè¢«æŠ“å–
4. é‡è¦å†…å®¹ä¸è¦ç”¨ js è¾“å‡ºï¼šçˆ¬è™«ä¸ä¼šæ‰§è¡Œ js è·å–å†…å®¹
5. å°‘ç”¨ iframeï¼šæœç´¢å¼•æ“ä¸ä¼šæŠ“å– iframe ä¸­çš„å†…å®¹
6. éè£…é¥°æ€§å›¾ç‰‡å¿…é¡»åŠ  alt
7. æé«˜ç½‘ç«™é€Ÿåº¦ï¼šç½‘ç«™é€Ÿåº¦æ˜¯æœç´¢å¼•æ“æ’åºçš„ä¸€ä¸ªé‡è¦æŒ‡æ ‡

## SEO

### å‰ç«¯éœ€è¦æ³¨æ„å“ªäº›SEO

- åˆç†çš„titleã€descriptionã€keywordsï¼šæœç´¢å¯¹ç€ä¸‰é¡¹çš„æƒé‡é€ä¸ªå‡å°ï¼Œtitleå€¼å¼ºè°ƒé‡ç‚¹å³å¯ï¼Œé‡è¦å…³é”®è¯å‡ºç°ä¸è¦è¶…è¿‡2æ¬¡ï¼Œè€Œä¸”è¦é å‰ï¼Œä¸åŒé¡µé¢titleè¦æœ‰æ‰€ä¸åŒï¼›descriptionæŠŠé¡µé¢å†…å®¹é«˜åº¦æ¦‚æ‹¬ï¼Œé•¿åº¦åˆé€‚ï¼Œä¸å¯è¿‡åˆ†å †ç Œå…³é”®è¯ï¼Œä¸åŒé¡µé¢descriptionæœ‰æ‰€ä¸åŒï¼›keywordsåˆ—ä¸¾å‡ºé‡è¦å…³é”®è¯å³å¯
- è¯­ä¹‰åŒ–çš„HTMLä»£ç ï¼Œç¬¦åˆW3Cè§„èŒƒï¼šè¯­ä¹‰åŒ–ä»£ç è®©æœç´¢å¼•æ“å®¹æ˜“ç†è§£ç½‘é¡µ
- é‡è¦å†…å®¹HTMLä»£ç æ”¾åœ¨æœ€å‰ï¼šæœç´¢å¼•æ“æŠ“å–HTMLé¡ºåºæ˜¯ä»ä¸Šåˆ°ä¸‹ï¼Œæœ‰çš„æœç´¢å¼•æ“å¯¹æŠ“å–é•¿åº¦æœ‰é™åˆ¶ï¼Œä¿è¯é‡è¦å†…å®¹ä¸€å®šä¼šè¢«æŠ“å–
- é‡è¦å†…å®¹ä¸è¦ç”¨jsè¾“å‡ºï¼šçˆ¬è™«ä¸ä¼šæ‰§è¡Œjsè·å–å†…å®¹
- å°‘ç”¨iframeï¼šæœç´¢å¼•æ“ä¸ä¼šæŠ“å–iframeä¸­çš„å†…å®¹
- éè£…é¥°æ€§å›¾ç‰‡å¿…é¡»åŠ alt
- æé«˜ç½‘ç«™é€Ÿåº¦ï¼šç½‘ç«™é€Ÿåº¦æ˜¯æœç´¢å¼•æ“æ’åºçš„ä¸€ä¸ªé‡è¦æŒ‡æ ‡

**å¦‚ä½•åšSEOä¼˜åŒ–?**

* æ ‡é¢˜ä¸å…³é”®è¯
  - è®¾ç½®æœ‰å¸å¼•åŠ›åˆ‡åˆå®é™…çš„æ ‡é¢˜ï¼Œæ ‡é¢˜ä¸­è¦åŒ…å«æ‰€åšçš„å…³é”®è¯

* ç½‘ç«™ç»“æ„ç›®å½•
  - æœ€å¥½ä¸è¦è¶…è¿‡ä¸‰çº§ï¼Œæ¯çº§æœ‰â€œé¢åŒ…å±‘å¯¼èˆªâ€ï¼Œä½¿ç½‘ç«™æˆæ ‘çŠ¶ç»“æ„åˆ†å¸ƒ

* é¡µé¢å…ƒç´ 
  - ç»™å›¾ç‰‡æ ‡æ³¨"Alt"å¯ä»¥è®©æœç´¢å¼•æ“æ›´å‹å¥½çš„æ”¶å½•

* ç½‘ç«™å†…å®¹
  - æ¯ä¸ªæœˆæ¯å¤©æœ‰è§„å¾‹çš„æ›´æ–°ç½‘ç«™çš„å†…å®¹ï¼Œä¼šä½¿æœç´¢å¼•æ“æ›´åŠ å–œæ¬¢

* å‹æƒ…é“¾æ¥
  - å¯¹æ–¹ä¸€å®šè¦æ˜¯æ­£è§„ç½‘ç«™ï¼Œæ¯å¤©æœ‰ä¸“ä¸šçš„å›¢é˜Ÿæˆ–è€…ä¸ªäººç»´æŠ¤æ›´æ–°

* å†…é“¾çš„å¸ƒç½®
  - ä½¿ç½‘ç«™å½¢æˆç±»ä¼¼èœ˜è››ç½‘çš„ç»“æ„ï¼Œä¸ä¼šå‡ºç°å•ç‹¬è¿æ¥çš„é¡µé¢æˆ–é“¾æ¥

* æµé‡åˆ†æ
  - é€šè¿‡ç»Ÿè®¡å·¥å…·(ç™¾åº¦ç»Ÿè®¡ï¼ŒCNZZ)åˆ†ææµé‡æ¥æºï¼ŒæŒ‡å¯¼ä¸‹ä¸€æ­¥çš„SEO

## SPAå•é¡µé¡µé¢

SPAï¼ˆ single-page application ï¼‰ä»…åœ¨ Web é¡µé¢åˆå§‹åŒ–æ—¶åŠ è½½ç›¸åº”çš„ HTMLã€JavaScript å’Œ CSSã€‚ä¸€æ—¦é¡µé¢åŠ è½½å®Œæˆï¼ŒSPA ä¸ä¼šå› ä¸ºç”¨æˆ·çš„æ“ä½œè€Œè¿›è¡Œé¡µé¢çš„é‡æ–°åŠ è½½æˆ–è·³è½¬ï¼›å–è€Œä»£ä¹‹çš„æ˜¯åˆ©ç”¨è·¯ç”±æœºåˆ¶å®ç° HTML å†…å®¹çš„å˜æ¢ï¼ŒUI ä¸ç”¨æˆ·çš„äº¤äº’ï¼Œé¿å…é¡µé¢çš„é‡æ–°åŠ è½½ã€‚

### SPAä¼˜ç‚¹

- ç”¨æˆ·ä½“éªŒå¥½ã€å¿«ï¼Œå†…å®¹çš„æ”¹å˜ä¸éœ€è¦é‡æ–°åŠ è½½æ•´ä¸ªé¡µé¢ï¼Œé¿å…äº†ä¸å¿…è¦çš„è·³è½¬å’Œé‡å¤æ¸²æŸ“ï¼›
- åŸºäºä¸Šé¢ä¸€ç‚¹ï¼ŒSPA ç›¸å¯¹å¯¹æœåŠ¡å™¨å‹åŠ›å°ï¼›
- å‰åç«¯èŒè´£åˆ†ç¦»ï¼Œæ¶æ„æ¸…æ™°ï¼Œå‰ç«¯è¿›è¡Œäº¤äº’é€»è¾‘ï¼Œåç«¯è´Ÿè´£æ•°æ®å¤„ç†ï¼›

### SPAç¼ºç‚¹

- åˆæ¬¡åŠ è½½è€—æ—¶å¤šï¼šä¸ºå®ç°å•é¡µ Web åº”ç”¨åŠŸèƒ½åŠæ˜¾ç¤ºæ•ˆæœï¼Œéœ€è¦åœ¨åŠ è½½é¡µé¢çš„æ—¶å€™å°† JavaScriptã€CSS ç»Ÿä¸€åŠ è½½ï¼Œéƒ¨åˆ†é¡µé¢æŒ‰éœ€åŠ è½½ï¼›
- å‰è¿›åé€€è·¯ç”±ç®¡ç†ï¼šç”±äºå•é¡µåº”ç”¨åœ¨ä¸€ä¸ªé¡µé¢ä¸­æ˜¾ç¤ºæ‰€æœ‰çš„å†…å®¹ï¼Œæ‰€ä»¥ä¸èƒ½ä½¿ç”¨æµè§ˆå™¨çš„å‰è¿›åé€€åŠŸèƒ½ï¼Œæ‰€æœ‰çš„é¡µé¢åˆ‡æ¢éœ€è¦è‡ªå·±å»ºç«‹å †æ ˆç®¡ç†ï¼›
- SEO éš¾åº¦è¾ƒå¤§ï¼šç”±äºæ‰€æœ‰çš„å†…å®¹éƒ½åœ¨ä¸€ä¸ªé¡µé¢ä¸­åŠ¨æ€æ›¿æ¢æ˜¾ç¤ºï¼Œæ‰€ä»¥åœ¨ SEO ä¸Šå…¶æœ‰ç€å¤©ç„¶çš„å¼±åŠ¿ã€‚

## urlæ„æˆ
- protocol åè®®ï¼Œå¸¸ç”¨çš„åè®®æ˜¯http
- hostname ä¸»æœºåœ°å€ï¼Œå¯ä»¥æ˜¯åŸŸåï¼Œä¹Ÿå¯ä»¥æ˜¯IPåœ°å€
- port ç«¯å£ httpåè®®é»˜è®¤ç«¯å£æ˜¯ï¼š80ç«¯å£ï¼Œå¦‚æœä¸å†™é»˜è®¤å°±æ˜¯:80ç«¯å£
- path è·¯å¾„ ç½‘ç»œèµ„æºåœ¨æœåŠ¡å™¨ä¸­çš„æŒ‡å®šè·¯å¾„
- parameter å‚æ•° å¦‚æœè¦å‘æœåŠ¡å™¨ä¼ å…¥å‚æ•°ï¼Œåœ¨è¿™éƒ¨åˆ†è¾“å…¥
- query æŸ¥è¯¢å­—ç¬¦ä¸² å¦‚æœéœ€è¦ä»æœåŠ¡å™¨é‚£é‡ŒæŸ¥è¯¢å†…å®¹ï¼Œåœ¨è¿™é‡Œç¼–è¾‘
- fragment ç‰‡æ®µ ç½‘é¡µä¸­å¯èƒ½ä¼šåˆ†ä¸ºä¸åŒçš„ç‰‡æ®µï¼Œå¦‚æœæƒ³è®¿é—®ç½‘é¡µåç›´æ¥åˆ°è¾¾æŒ‡å®šä½ç½®ï¼Œå¯ä»¥åœ¨è¿™éƒ¨åˆ†è®¾ç½®

## hashå’Œhistory

### hash

http://xxx.abc.com/#/xxã€‚ æœ‰å¸¦#å·ï¼Œåé¢å°±æ˜¯hashå€¼çš„å˜åŒ–ã€‚æ”¹å˜åé¢çš„hashå€¼ï¼Œå®ƒä¸ä¼šå‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œå› æ­¤ä¹Ÿå°±ä¸ä¼šåˆ·æ–°é¡µé¢ã€‚å¹¶ä¸”æ¯æ¬¡hashå€¼å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼Œä¼šè§¦å‘`hashchange`äº‹ä»¶ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ç›‘å¬è¯¥äº‹ä»¶ï¼Œæ¥çŸ¥é“hashå€¼å‘ç”Ÿäº†å“ªäº›å˜åŒ–ã€‚

### history

HTML5çš„History APIä¸ºæµè§ˆå™¨çš„å…¨å±€historyå¯¹è±¡å¢åŠ äº†è¯¥æ‰©å±•æ–¹æ³•ã€‚å®ƒæ˜¯ä¸€ä¸ªæµè§ˆå™¨çš„ä¸€ä¸ªæ¥å£ï¼Œåœ¨windowå¯¹è±¡ä¸­æä¾›äº†onpopstateäº‹ä»¶æ¥ç›‘å¬å†å²æ ˆçš„æ”¹å˜ï¼Œåªè¦å†å²æ ˆæœ‰ä¿¡æ¯å‘ç”Ÿæ”¹å˜çš„è¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶ã€‚æä¾›äº†å¦‚ä¸‹äº‹ä»¶ï¼š

- history,go(-1); //
- history.back(); // å›é€€ä¸€æ¡è®°å½•
- history.forward(); // å‰è¿›ä¸€æ¡è®°å½•
- history.pushState(data[,title][,url]); // å‘å†å²è®°å½•ä¸­è¿½åŠ ä¸€æ¡è®°å½•
- history.replaceState(data[,title][,url]); // æ›¿æ¢å½“å‰é¡µåœ¨å†å²è®°å½•ä¸­çš„ä¿¡æ¯ã€‚


## scripté˜»å¡DOMè§£æ

æµè§ˆå™¨è§£æhtmlæ–‡ä»¶æ—¶ï¼Œä»ä¸Šå‘ä¸‹è§£ææ„å»ºDOMæ ‘ã€‚å½“è§£æåˆ°scriptæ ‡ç­¾æ—¶ï¼Œä¼šæš‚åœDOMæ„å»ºã€‚å…ˆæŠŠè„šæœ¬åŠ è½½å¹¶æ‰§è¡Œå®Œæ¯•ï¼Œæ‰ä¼šç»§ç»­å‘ä¸‹è§£æã€‚jsè„šæœ¬çš„å­˜åœ¨ä¼šé˜»å¡DOMè§£æï¼Œè¿›è€Œå½±å“é¡µé¢æ¸²æŸ“é€Ÿåº¦ã€‚
æˆ‘ä»¬å¯ä»¥åšä»¥ä¸‹å¤„ç†ï¼š

1. å°†scriptæ ‡ç­¾æ”¾åœ¨htmlæ–‡ä»¶åº•éƒ¨ï¼Œé¿å…è§£æDOMæ—¶è¢«å…¶é˜»å¡

2. å»¶è¿Ÿè„šæœ¬

åœ¨scriptæ ‡ç­¾ä¸Šè®¾ç½®deferå±æ€§

``` html
<script type="text/javascript" defer src="1.js"></script>
```


å‘ŠçŸ¥æµè§ˆå™¨ç«‹å³ä¸‹è½½è„šæœ¬ï¼Œä½†å»¶è¿Ÿæ‰§è¡Œã€‚å½“æµè§ˆå™¨è§£æå®Œhtmlæ–‡æ¡£æ—¶ï¼Œå†æ‰§è¡Œè„šæœ¬ã€‚

3. å¼‚æ­¥è„šæœ¬

``` html
<script type="text/javascript" async src="1.js"></script>
<script type="text/javascript" async src="2.js"></script>
```

å’ŒdeferåŠŸèƒ½ç±»ä¼¼ï¼ŒåŒºåˆ«åœ¨äºä¸ä¼šä¸¥æ ¼æŒ‰ç…§scriptæ ‡ç­¾é¡ºåºæ‰§è¡Œè„šæœ¬ï¼Œä¹Ÿå°±æ˜¯è¯´è„šæœ¬2å¯èƒ½å…ˆäºè„šæœ¬1æ‰§è¡Œã€‚è„šæœ¬éƒ½ä¼šåœ¨onloadäº‹ä»¶å‰æ‰§è¡Œï¼Œä½†å¯èƒ½ä¼šåœ¨ DOMContentLoaded äº‹ä»¶è§¦å‘å‰åæ‰§è¡Œã€‚

æ³¨æ„ï¼šdeferå’Œasyncéƒ½åªé€‚ç”¨äºå¤–éƒ¨è„šæœ¬


## ç§»åŠ¨ç«¯æœ€å°è§¦æ§åŒºåŸŸæ˜¯å¤šå¤§ï¼Ÿ

- 44 * 44 px

## ç§»åŠ¨ç«¯çš„ç‚¹å‡»äº‹ä»¶çš„å»¶è¿Ÿæ—¶é—´æ˜¯å¤šé•¿ï¼Œä¸ºä»€ä¹ˆä¼šæœ‰å»¶è¿Ÿï¼Ÿ å¦‚ä½•è§£å†³è¿™ä¸ªå»¶æ—¶ï¼Ÿ

* ç§»åŠ¨ç«¯ click æœ‰ 300ms å»¶è¿Ÿï¼Œæµè§ˆå™¨ä¸ºäº†åŒºåˆ†â€œåŒå‡»â€ï¼ˆæ”¾å¤§é¡µé¢ï¼‰è¿˜æ˜¯â€œå•å‡»â€è€Œè®¾è®¡
* è§£å†³æ–¹æ¡ˆï¼š
  - ç¦ç”¨ç¼©æ”¾(å¯¹safariæ— æ•ˆ)
  - ä½¿ç”¨æŒ‡é’ˆäº‹ä»¶(IEç§æœ‰ç‰¹æ€§ï¼Œä¸”ä»…IE10+)
  - ä½¿ç”¨ Zepto çš„ tap äº‹ä»¶(æœ‰ç‚¹é€BUG)
  - ä½¿ç”¨ FastClick æ’ä»¶(ä½“ç§¯å¤§[å‹ç¼©å8k])